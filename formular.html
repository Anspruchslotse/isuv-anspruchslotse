<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISUV – Formular ausfüllen</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:sans-serif; background:#f4f7f9; min-height:100vh; }
    .header { background:#003366; color:#fff; padding:16px 20px; text-align:center; }
    .header .logo { width:40px; height:40px; background:#00afad; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-weight:bold; font-size:16px; margin-bottom:8px; }
    .header h1 { font-size:16px; }
    .header p { font-size:11px; opacity:0.8; margin-top:4px; }
    .container { max-width:500px; margin:0 auto; padding:16px; }
    .card { background:#fff; border-radius:12px; padding:20px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .section-label { font-size:10px; font-weight:bold; color:#003366; text-transform:uppercase; background:#e8f0fb; border-radius:4px; padding:4px 8px; margin-bottom:12px; letter-spacing:0.5px; display:block; }
    label { font-size:12px; font-weight:bold; display:block; margin-bottom:4px; color:#333; }
    input, select, textarea { width:100%; padding:10px; margin-bottom:12px; border-radius:6px; border:1px solid #ddd; font-size:13px; box-sizing:border-box; font-family:sans-serif; }
    textarea { height:80px; resize:vertical; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .btn-primary { width:100%; padding:14px; background:#003366; color:#fff; border:none; border-radius:10px; font-weight:bold; font-size:14px; cursor:pointer; margin-top:8px; }
    .btn-primary:hover { background:#00254d; }
    .btn-add { background:#00afad; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:11px; cursor:pointer; margin-bottom:10px; }
    .btn-del { background:#ff4d4d; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px; }
    .kind-box { background:#f9f9f9; border-radius:8px; padding:12px; margin-bottom:10px; border-left:3px solid #00afad; }
    .kind-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .info-box { background:#e8f4fd; border:1px solid #bee5f8; border-radius:6px; padding:10px; font-size:11px; color:#0c5460; margin-bottom:12px; }
    .success { background:#e8f5e9; border:1px solid #a5d6a7; border-radius:10px; padding:30px 20px; text-align:center; }
    .success .icon { font-size:48px; margin-bottom:12px; }
    .success h2 { color:#2e7d32; margin-bottom:8px; }
    .success p { font-size:13px; color:#555; }
    .error-box { background:#ffebee; border:1px solid #ef9a9a; border-radius:6px; padding:10px; font-size:12px; color:#c62828; margin-bottom:12px; }
    .loading { text-align:center; padding:40px; color:#003366; }
    .spinner { width:40px; height:40px; border:3px solid #e0e0e0; border-top-color:#00afad; border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 16px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .required { color:#e53935; }
  </style>
</head>
<body>
<div class="header">
  <div class="logo">I</div>
  <h1>ISUV Anspruchslotse</h1>
  <p id="form-subtitle">Formular wird geladen...</p>
</div>
<div class="container">
  <div id="loading" class="card loading">
    <div class="spinner"></div>
    <p>Formular wird geladen...</p>
  </div>
  <div id="error-container" style="display:none"></div>
  <div id="form-container" style="display:none"></div>
  <div id="success-container" style="display:none">
    <div class="success">
      <div class="icon">✅</div>
      <h2>Vielen Dank!</h2>
      <p>Ihr Formular wurde erfolgreich übermittelt.<br/>Der ISUV wird sich bei Ihnen melden.</p>
    </div>
  </div>
</div>

<script>
var params = new URLSearchParams(window.location.search);
var formularId = params.get('id');
var sbParam = params.get('sb') || '';
var supabaseKey = params.get('key') || '';

// Normalize: always use base URL + /rest/v1
var supabaseBase = sbParam.replace(/\/rest\/v1.*$/, '').replace(/\/$/, '');
var apiBase = supabaseBase + '/rest/v1';

function showError(msg) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error-container').style.display = 'block';
  document.getElementById('error-container').innerHTML = '<div class="card error-box">⚠️ ' + msg + '</div>';
}

if (!formularId || !supabaseBase || !supabaseKey) {
  showError('Ungültiger Formular-Link. Bitte wenden Sie sich an Ihren ISUV-Berater.');
} else {
  loadFormular();
}

async function loadFormular() {
  try {
    var url = apiBase + '/formulare?formular_id=eq.' + encodeURIComponent(formularId);
    var res = await fetch(url, {
      headers: { 'apikey': supabaseKey, 'Authorization': 'Bearer ' + supabaseKey }
    });
    if (!res.ok) {
      var txt = await res.text();
      throw new Error('HTTP ' + res.status + ' – ' + txt.slice(0, 150));
    }
    var rows = await res.json();
    if (!rows || rows.length === 0) throw new Error('Formular nicht gefunden.');
    var row = rows[0];
    document.getElementById('form-subtitle').textContent = row.label || 'Formular ausfüllen';
    document.getElementById('loading').style.display = 'none';
    if (row.status === 'beantwortet') {
      document.getElementById('success-container').style.display = 'block';
      return;
    }
    var vf = {};
    try { vf = JSON.parse(row.vorausgefuellt || '{}'); } catch(e) {}
    renderFormular(row, vf);
  } catch(e) {
    showError('Fehler beim Laden: ' + e.message);
  }
}

function renderFormular(row, vf) {
  var c = document.getElementById('form-container');
  c.style.display = 'block';

  if (row.typ === 'stammdaten') {
    c.innerHTML = buildStammdatenForm(vf);
    document.getElementById('btn-add-kind').onclick = function() {
      var list = document.getElementById('kinder-list');
      var idx = list.children.length;
      var div = document.createElement('div');
      div.className = 'kind-box';
      div.innerHTML = buildKindBlock(idx, {});
      list.appendChild(div);
    };
  } else if (row.typ === 'tbg') {
    c.innerHTML = buildTbgForm(vf);
  } else {
    c.innerHTML = buildStammdatenForm(vf);
    document.getElementById('btn-add-kind').onclick = function() {
      var list = document.getElementById('kinder-list');
      var idx = list.children.length;
      var div = document.createElement('div');
      div.className = 'kind-box';
      div.innerHTML = buildKindBlock(idx, {});
      list.appendChild(div);
    };
  }

  document.getElementById('btn-submit').onclick = function() { submitFormular(row); };
}

function v(id, fallback) {
  return (fallback || '');
}

function sel(val, opt) {
  return val === opt ? ' selected' : '';
}

function buildStammdatenForm(vf) {
  var html = '';
  html += '<div class="card">';
  html += '<span class="section-label">Persönliche Daten</span>';
  html += '<div class="info-box">ℹ️ Pflichtfelder sind mit <span class="required">*</span> markiert.</div>';
  html += '<div class="row">';
  html += '<div><label>Vorname <span class="required">*</span></label><input id="vorname" value="' + esc(vf.vorname) + '"/></div>';
  html += '<div><label>Nachname <span class="required">*</span></label><input id="name" value="' + esc(vf.name) + '"/></div>';
  html += '</div>';
  html += '<label>Telefon</label><input id="tel" type="tel" value="' + esc(vf.tel) + '" placeholder="+49170 1234567"/>';
  html += '<label>E-Mail <span class="required">*</span></label><input id="mail" type="email" value="' + esc(vf.mail) + '" placeholder="name@beispiel.de"/>';
  html += '<label>Straße & Hausnummer</label><input id="strasse" value="' + esc(vf.strasse) + '"/>';
  html += '<div class="row">';
  html += '<div style="width:90px"><label>PLZ</label><input id="plz" value="' + esc(vf.plz) + '"/></div>';
  html += '<div><label>Ort</label><input id="ort" value="' + esc(vf.ort) + '"/></div>';
  html += '</div>';
  html += '<label>Familienstand</label>';
  html += '<select id="familienstand">';
  html += '<option value="">– bitte wählen –</option>';
  html += '<option value="ledig"' + sel(vf.familienstand,'ledig') + '>ledig</option>';
  html += '<option value="verheiratet"' + sel(vf.familienstand,'verheiratet') + '>verheiratet</option>';
  html += '<option value="getrennt lebend"' + sel(vf.familienstand,'getrennt lebend') + '>getrennt lebend</option>';
  html += '<option value="geschieden"' + sel(vf.familienstand,'geschieden') + '>geschieden</option>';
  html += '<option value="verwitwet"' + sel(vf.familienstand,'verwitwet') + '>verwitwet</option>';
  html += '</select>';
  html += '</div>';
  html += '<div class="card">';
  html += '<span class="section-label">Einkommen & Wohnen</span>';
  html += '<label>Nettoeinkommen (€/Monat)</label><input id="einkommenNetto" type="number" value="' + esc(vf.einkommenNetto) + '" placeholder="z.B. 1500"/>';
  html += '<label>Bruttomiete warm (€/Monat)</label><input id="mieteWarm" type="number" value="' + esc(vf.mieteWarm) + '" placeholder="z.B. 800"/>';
  html += '</div>';
  html += '<div class="card">';
  html += '<span class="section-label">Kinder</span>';
  html += '<div id="kinder-list"></div>';
  html += '<button class="btn-add" id="btn-add-kind" type="button">+ Kind hinzufügen</button>';
  html += '</div>';
  html += '<div class="card">';
  html += '<span class="section-label">Notizen / Anliegen</span>';
  html += '<textarea id="notizen" placeholder="Was ist Ihr Anliegen?"></textarea>';
  html += '</div>';
  html += '<button class="btn-primary" id="btn-submit" type="button">✓ Formular absenden</button>';
  html += '<p style="font-size:10px;color:#999;text-align:center;margin-top:10px">Ihre Daten werden sicher übermittelt.</p>';
  return html;
}

function buildKindBlock(idx, k) {
  var html = '';
  html += '<div class="kind-header">';
  html += '<strong style="font-size:13px">Kind ' + (idx+1) + '</strong>';
  html += '<button class="btn-del" type="button" onclick="this.closest(\'.kind-box\').remove()">✕</button>';
  html += '</div>';
  html += '<label>Vorname</label><input id="k_vorname_' + idx + '" value="' + esc(k.vorname) + '"/>';
  html += '<label>Nachname</label><input id="k_nachname_' + idx + '" value="' + esc(k.nachname) + '"/>';
  html += '<label>Geburtsdatum</label><input id="k_geburt_' + idx + '" type="date" value="' + esc(k.geburt) + '"/>';
  return html;
}

function buildTbgForm(vf) {
  var html = '';
  html += '<div class="card">';
  html += '<span class="section-label">Anlage TBG – Temporäre Bedarfsgemeinschaft</span>';
  html += '<div class="info-box">ℹ️ Bitte füllen Sie alle relevanten Felder aus.</div>';
  html += '<div class="row">';
  html += '<div><label>Nachname <span class="required">*</span></label><input id="name" value="' + esc(vf.name) + '"/></div>';
  html += '<div><label>Vorname <span class="required">*</span></label><input id="vorname" value="' + esc(vf.vorname) + '"/></div>';
  html += '</div>';
  html += '<label>Straße, Hausnummer</label><input id="strasse" value="' + esc(vf.strasse) + '"/>';
  html += '<div class="row">';
  html += '<div style="width:90px"><label>PLZ</label><input id="plz" value="' + esc(vf.plz) + '"/></div>';
  html += '<div><label>Ort</label><input id="ort" value="' + esc(vf.ort) + '"/></div>';
  html += '</div>';
  html += '<label>BG-Nummer (falls vorhanden)</label><input id="bg_nummer" placeholder="optional"/>';
  html += '<label>E-Mail</label><input id="mail" type="email" value="' + esc(vf.mail) + '"/>';
  html += '<label>Telefon</label><input id="tel" type="tel" value="' + esc(vf.tel) + '"/>';
  html += '</div>';
  html += '<div class="card">';
  html += '<span class="section-label">Betreuungsmodell</span>';
  html += '<label><input type="radio" name="modell" value="paritaetisch"/> Paritätisch (ca. 50:50)</label><br/><br/>';
  html += '<label><input type="radio" name="modell" value="asymmetrisch"/> Asymmetrisch / Residenz</label>';
  html += '</div>';
  html += '<div class="card">';
  html += '<span class="section-label">Notizen</span>';
  html += '<textarea id="notizen" placeholder="Weitere Angaben..."></textarea>';
  html += '</div>';
  html += '<button class="btn-primary" id="btn-submit" type="button">✓ Formular absenden</button>';
  return html;
}

function esc(val) {
  if (!val) return '';
  return String(val).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function submitFormular(row) {
  var btn = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.textContent = 'Wird gesendet...';

  var daten = {};
  ['vorname','name','tel','mail','strasse','plz','ort','familienstand','einkommenNetto','mieteWarm','notizen','bg_nummer'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) daten[id] = el.value;
  });

  var modell = document.querySelector('input[name="modell"]:checked');
  if (modell) daten.modell = modell.value;

  var kinderList = document.getElementById('kinder-list');
  if (kinderList) {
    var kinder = [];
    var boxes = kinderList.querySelectorAll('.kind-box');
    boxes.forEach(function(box, idx) {
      var k = {};
      var vn = document.getElementById('k_vorname_' + idx);
      var nn = document.getElementById('k_nachname_' + idx);
      var gb = document.getElementById('k_geburt_' + idx);
      if (vn) k.vorname = vn.value;
      if (nn) k.nachname = nn.value;
      if (gb) k.geburt = gb.value;
      if (k.vorname || k.nachname) kinder.push(k);
    });
    if (kinder.length > 0) daten.kinder = kinder;
  }

  if (!daten.vorname || !daten.name) {
    btn.disabled = false;
    btn.textContent = '✓ Formular absenden';
    alert('Bitte Vor- und Nachname ausfüllen.');
    return;
  }

  try {
    var url = apiBase + '/formulare?formular_id=eq.' + encodeURIComponent(formularId);
    var res = await fetch(url, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'apikey': supabaseKey,
        'Authorization': 'Bearer ' + supabaseKey,
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({
        antwort_daten: JSON.stringify(daten),
        status: 'beantwortet',
        beantwortet_am: new Date().toISOString()
      })
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    document.getElementById('form-container').style.display = 'none';
    document.getElementById('success-container').style.display = 'block';
    document.getElementById('form-subtitle').textContent = 'Erfolgreich gesendet';
  } catch(e) {
    btn.disabled = false;
    btn.textContent = '✓ Formular absenden';
    alert('Fehler beim Senden: ' + e.message);
  }
}
</script>
</body>
</html>
