<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ISUV Anspruchslotse</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; background: #f4f7f9; }
    #loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: #003366; gap: 12px; }
    .logo { width: 60px; height: 60px; background: #003366; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }
    .spinner { width: 32px; height: 32px; border: 3px solid #e0e0e0; border-top-color: #00afad; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading p { font-size: 13px; color: #999; }
  </style>
</head>
<body>
  <div id="loading">
    <div class="logo">I</div>
    <strong style="color:#003366;font-size:16px">ISUV Anspruchslotse</strong>
    <div class="spinner"></div>
    <p>App wird geladen...</p>
  </div>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script type="text/babel" data-presets="react">
const { useState } = React;


// =============================================
// MODUL 1: KINDESUNTERHALT (isoliert)
// =============================================
function KindesunterhaltsRechner() {
  const [einkommenSelbst, setEinkommenSelbst] = useState("");
  const [einkommenAnderer, setEinkommenAnderer] = useState("");
  const [altersvorsorge, setAltersvorsorge] = useState("");
  const [kredite, setKredite] = useState("");
  const [wohnvorteil, setWohnvorteil] = useState("");
  const [kinderUnterhalt, setKinderUnterhalt] = useState([
    { id: 1, alter: "6", mbListe: [], sbListe: [], eigeneEinnahmen: "" }
  ]);
  const [resUnterhalt, setResUnterhalt] = useState(null);

  const mbOptionen = ["Kita-Geb√ºhren", "Hort/Nachmittagsbetreuung", "Private Krankenversicherung", "Heilp√§dagogische Ma√ünahmen", "Privatschule"];
  const sbOptionen = ["Kieferorthop√§die (Eigenanteil)", "Unaufschiebbare Klassenfahrt", "Erstausstattung (S√§ugling)", "Brille/H√∂rger√§t"];

  const addKind = () => setKinderUnterhalt([...kinderUnterhalt, { id: Date.now(), alter: "6", mbListe: [], sbListe: [], eigeneEinnahmen: "" }]);
  const removeKind = (id) => { if (kinderUnterhalt.length > 1) setKinderUnterhalt(kinderUnterhalt.filter(k => k.id !== id)); };
  const updateKindFeld = (kindId, feld, wert) => setKinderUnterhalt(kinderUnterhalt.map(k => k.id === kindId ? { ...k, [feld]: wert } : k));

  const toggleBedarf = (kindId, typ, wert) => {
    setKinderUnterhalt(kinderUnterhalt.map(k => {
      if (k.id !== kindId) return k;
      const liste = typ === "mb" ? [...k.mbListe] : [...k.sbListe];
      const index = liste.findIndex(item => item.name === wert);
      if (index > -1) liste.splice(index, 1); else liste.push({ name: wert, betrag: "" });
      return typ === "mb" ? { ...k, mbListe: liste } : { ...k, sbListe: liste };
    }));
  };

  const updateBetrag = (kindId, typ, name, betrag) => {
    setKinderUnterhalt(kinderUnterhalt.map(k => {
      if (k.id !== kindId) return k;
      const liste = typ === "mb" ? k.mbListe : k.sbListe;
      const neueListe = liste.map(item => item.name === name ? { ...item, betrag } : item);
      return typ === "mb" ? { ...k, mbListe: neueListe } : { ...k, sbListe: neueListe };
    }));
  };

  const berechne = () => {
    const n1 = parseFloat(einkommenSelbst || 0);
    const pauschale = Math.min(150, n1 * 0.05);
    const berN1 = Math.max(0, n1 - pauschale - parseFloat(altersvorsorge || 0) - parseFloat(kredite || 0) + parseFloat(wohnvorteil || 0));
    const n2 = parseFloat(einkommenAnderer || 0);
    const berN2 = Math.max(0, n2 - Math.min(150, n2 * 0.05));
    let stufe = berN1 > 2500 ? 3 : berN1 > 2100 ? 2 : 1;
    if (kinderUnterhalt.length === 1) stufe += 1;
    if (kinderUnterhalt.length > 2) stufe -= 1;
    stufe = Math.max(1, Math.min(3, stufe));
    const sbMinderj√§hrig = 1450;
    const verf√ºgbareMasse = Math.max(0, berN1 - sbMinderj√§hrig);
    const √º1 = Math.max(0, berN1 - 1450);
    const √º2 = Math.max(0, berN2 - 1450);
    const quoteIch = (√º1 + √º2) > 0 ? √º1 / (√º1 + √º2) : 1;
    const tabelle = { 1: { "0": 480, "6": 551, "12": 645, "18": 706 }, 2: { "0": 504, "6": 579, "12": 678, "18": 742 }, 3: { "0": 528, "6": 607, "12": 710, "18": 777 } };
    let gesamtSoll = 0;
    const raw = kinderUnterhalt.map(k => {
      const basis = tabelle[stufe][k.alter];
      const barSoll = Math.max(0, basis - (k.alter === "18" ? 250 : 125) - parseFloat(k.eigeneEinnahmen || 0));
      const mbSollIch = k.mbListe.reduce((s, i) => s + parseFloat(i.betrag || 0), 0) * quoteIch;
      const sbSollIch = k.sbListe.reduce((s, i) => s + parseFloat(i.betrag || 0), 0) * quoteIch;
      gesamtSoll += barSoll + mbSollIch;
      return { ...k, barSoll, mbSollIch, sbSollIch };
    });
    const faktor = verf√ºgbareMasse < gesamtSoll ? verf√ºgbareMasse / gesamtSoll : 1;
    setResUnterhalt({ berN1: berN1.toFixed(2), sb: sbMinderj√§hrig, masse: verf√ºgbareMasse.toFixed(2), istSumme: (gesamtSoll * faktor).toFixed(2), istMangelfall: faktor < 1, quote: (quoteIch * 100).toFixed(0), einzelDetails: raw.map(d => ({ ...d, zBar: (d.barSoll * faktor).toFixed(2), zMB: (d.mbSollIch * faktor).toFixed(2), zSB: d.sbSollIch.toFixed(2) })) });
  };

  const u = rStyles;
  return (
    <div>
      <h4 style={u.modTitle}>‚öñÔ∏è Kindesunterhaltsrechner</h4>
      <label style={u.labelMini}>Nettoeinkommen:</label>
      <div style={u.row}>
        <input type="number" style={u.input} placeholder="Mein Netto (‚Ç¨)" value={einkommenSelbst} onChange={e => setEinkommenSelbst(e.target.value)} />
        <input type="number" style={u.input} placeholder="Andere Seite (‚Ç¨)" value={einkommenAnderer} onChange={e => setEinkommenAnderer(e.target.value)} />
      </div>
      <div style={u.row}>
        <input type="number" style={u.input} placeholder="Altersvorsorge (‚Ç¨)" value={altersvorsorge} onChange={e => setAltersvorsorge(e.target.value)} />
        <input type="number" style={u.input} placeholder="Kredite (‚Ç¨)" value={kredite} onChange={e => setKredite(e.target.value)} />
      </div>
      <input type="number" style={u.input} placeholder="Wohnwertvorteil (‚Ç¨)" value={wohnvorteil} onChange={e => setWohnvorteil(e.target.value)} />
      <div style={u.filterSection}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "10px" }}>
          <strong style={{ fontSize: "13px" }}>Kinder &amp; Bedarfe</strong>
          <button onClick={addKind} style={u.btnAdd}>+ Kind</button>
        </div>
        {kinderUnterhalt.map((k, i) => (
          <div key={k.id} style={u.childBox}>
            <div style={u.row}>
              <strong style={{ fontSize: "13px" }}>Kind {i + 1}</strong>
              <div style={{ display: "flex", gap: "5px", alignItems: "center" }}>
                <select style={u.inputMini} value={k.alter} onChange={e => updateKindFeld(k.id, "alter", e.target.value)}>
                  <option value="0">0‚Äì5 J.</option><option value="6">6‚Äì11 J.</option><option value="12">12‚Äì17 J.</option><option value="18">18+</option>
                </select>
                <button onClick={() => removeKind(k.id)} style={u.btnDel}>‚úï</button>
              </div>
            </div>
            <input type="number" style={{ ...u.miniIn, width: "100%", marginTop: "8px" }} placeholder="Eigene Einnahmen des Kindes (‚Ç¨)" value={k.eigeneEinnahmen} onChange={e => updateKindFeld(k.id, "eigeneEinnahmen", e.target.value)} />
            <span style={u.sectionLabel}>Mehrbedarf:</span>
            <div style={u.tagCloud}>
              {mbOptionen.map(opt => { const a = k.mbListe.some(m => m.name === opt); return (<div key={opt} onClick={() => toggleBedarf(k.id, "mb", opt)} style={{ padding: "4px 8px", borderRadius: "12px", fontSize: "9px", cursor: "pointer", backgroundColor: a ? "#00afad" : "#eee", color: a ? "#fff" : "#333" }}>{opt}</div>); })}
            </div>
            {k.mbListe.map(m => (<div key={m.name} style={u.bedarfRow}><span style={{ fontSize: "10px" }}>{m.name}</span><input type="number" style={u.miniIn} placeholder="‚Ç¨" value={m.betrag} onChange={e => updateBetrag(k.id, "mb", m.name, e.target.value)} /></div>))}
            <span style={u.sectionLabel}>Sonderbedarf:</span>
            <div style={u.tagCloud}>
              {sbOptionen.map(opt => { const a = k.sbListe.some(s => s.name === opt); return (<div key={opt} onClick={() => toggleBedarf(k.id, "sb", opt)} style={{ padding: "4px 8px", borderRadius: "12px", fontSize: "9px", cursor: "pointer", backgroundColor: a ? "#003366" : "#eee", color: a ? "#fff" : "#333" }}>{opt}</div>); })}
            </div>
            {k.sbListe.map(s => (<div key={s.name} style={u.bedarfRow}><span style={{ fontSize: "10px" }}>{s.name}</span><input type="number" style={u.miniIn} placeholder="‚Ç¨" value={s.betrag} onChange={e => updateBetrag(k.id, "sb", s.name, e.target.value)} /></div>))}
          </div>
        ))}
      </div>
      <button style={u.btnPrimary} onClick={berechne}>Berechnen</button>
      {resUnterhalt && (
        <div style={u.resultBox}>
          {resUnterhalt.istMangelfall && (<div style={u.warnung}>‚ö†Ô∏è <strong>Mangelfall:</strong> Einkommen reicht nicht f√ºr vollen Unterhalt. Betrag wird anteilig gek√ºrzt.</div>)}
          <div style={u.calcStep}><span>Bereinigtes Netto:</span><span>{resUnterhalt.berN1} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>Selbstbehalt:</span><span>‚Äì {resUnterhalt.sb} ‚Ç¨</span></div>
          <div style={{ ...u.calcStep, borderTop: "1px solid #00afad", fontWeight: "bold", marginTop: "5px", paddingTop: "5px" }}><span>Verf√ºgbare Masse:</span><span>{resUnterhalt.masse} ‚Ç¨</span></div>
          <div style={u.compositionBox}>
            <span style={{ fontSize: "11px", fontWeight: "bold", color: "#003366" }}>Monatlicher Zahlbetrag:</span>
            {resUnterhalt.einzelDetails.map((d, i) => (
              <div key={i} style={u.detailRow}>
                <div style={u.resRow}><span>Kind {i + 1} Barunterhalt:</span><span>{d.zBar} ‚Ç¨</span></div>
                {parseFloat(d.zMB) > 0 && <div style={u.resRow}><span>+ Mehrbedarf:</span><span>{d.zMB} ‚Ç¨</span></div>}
              </div>
            ))}
            <div style={{ ...u.resRow, fontWeight: "bold", marginTop: "10px", fontSize: "16px", borderTop: "2px solid #003366", paddingTop: "5px" }}><span>Gesamt:</span><span>{resUnterhalt.istSumme} ‚Ç¨</span></div>
          </div>
          {resUnterhalt.einzelDetails.some(d => parseFloat(d.zSB) > 0) && (
            <div style={u.sbBox}>
              <span style={{ fontSize: "10px", fontWeight: "bold" }}>Einmaliger Sonderbedarf (Ihr Anteil {resUnterhalt.quote}%):</span>
              {resUnterhalt.einzelDetails.map((d, i) => parseFloat(d.zSB) > 0 ? <div key={i} style={u.resRow}><span>Kind {i + 1}:</span><span>{d.zSB} ‚Ç¨</span></div> : null)}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// =============================================
// MODUL 2: TRENNUNGSUNTERHALT (isoliert)
// =============================================
function TrennungsunterhaltsRechner() {
  const [einAntragsteller, setEinAntragsteller] = useState("");
  const [einVerpflichteter, setEinVerpflichteter] = useState("");
  const [abzuegeAntragsteller, setAbzuegeAntragsteller] = useState("");
  const [abzuegeVerpflichteter, setAbzuegeVerpflichteter] = useState("");
  const [kinderAnzahl, setKinderAnzahl] = useState("0");
  const [ehezeit, setEhezeit] = useState("");
  const [erwerbstaetigkeit, setErwerbstaetigkeit] = useState("vollzeit");
  const [result, setResult] = useState(null);

  const berechne = () => {
    const berA = Math.max(0, parseFloat(einAntragsteller || 0) - parseFloat(abzuegeAntragsteller || 0));
    const berV = Math.max(0, parseFloat(einVerpflichteter || 0) - parseFloat(abzuegeVerpflichteter || 0));
    const bonusA = erwerbstaetigkeit === "vollzeit" ? berA / 7 : 0;
    const bonusV = berV / 7;
    const bereinigtA = berA - bonusA;
    const bereinigtV = berV - bonusV;
    const kuAbzug = parseInt(kinderAnzahl) * 450;
    const verf√ºgbarV = Math.max(0, bereinigtV - kuAbzug);
    const selbstbehalt = 1200;
    const masseF√ºrUnterhalt = Math.max(0, verf√ºgbarV - selbstbehalt);
    const differenz = bereinigtV - bereinigtA;
    const anspruch = Math.max(0, Math.min(differenz / 2, masseF√ºrUnterhalt));
    setResult({ bereinigtA: bereinigtA.toFixed(2), bereinigtV: bereinigtV.toFixed(2), kuAbzug: kuAbzug.toFixed(2), masseF√ºrUnterhalt: masseF√ºrUnterhalt.toFixed(2), anspruch: anspruch.toFixed(2), mangelfall: masseF√ºrUnterhalt < anspruch, keinAnspruch: differenz <= 0 });
  };

  const u = rStyles;
  return (
    <div>
      <h4 style={u.modTitle}>üë´ Trennungsunterhalt (¬ß 1361 BGB)</h4>
      <div style={u.infoBox}>‚ÑπÔ∏è Berechnung nach Halbteilungsgrundsatz. Selbstbehalt gegen√ºber Ehegatten: 1.200 ‚Ç¨.</div>
      <label style={u.sectionLabel}>Einkommen Antragsteller*in:</label>
      <div style={u.row}>
        <input type="number" style={u.input} placeholder="Nettoeinkommen (‚Ç¨)" value={einAntragsteller} onChange={e => setEinAntragsteller(e.target.value)} />
        <input type="number" style={u.input} placeholder="Abz√ºge (‚Ç¨)" value={abzuegeAntragsteller} onChange={e => setAbzuegeAntragsteller(e.target.value)} />
      </div>
      <label style={u.sectionLabel}>Einkommen Verpflichteter:</label>
      <div style={u.row}>
        <input type="number" style={u.input} placeholder="Nettoeinkommen (‚Ç¨)" value={einVerpflichteter} onChange={e => setEinVerpflichteter(e.target.value)} />
        <input type="number" style={u.input} placeholder="Abz√ºge (‚Ç¨)" value={abzuegeVerpflichteter} onChange={e => setAbzuegeVerpflichteter(e.target.value)} />
      </div>
      <label style={u.sectionLabel}>Erwerbst√§tigkeit Antragsteller*in:</label>
      <div style={{ display: "flex", gap: "8px", marginBottom: "10px" }}>
        {["vollzeit", "teilzeit", "keine"].map(v => (
          <div key={v} onClick={() => setErwerbstaetigkeit(v)} style={{ padding: "6px 12px", borderRadius: "8px", fontSize: "11px", cursor: "pointer", backgroundColor: erwerbstaetigkeit === v ? "#00afad" : "#eee", color: erwerbstaetigkeit === v ? "#fff" : "#333" }}>
            {v === "vollzeit" ? "Vollzeit" : v === "teilzeit" ? "Teilzeit" : "Keine"}
          </div>
        ))}
      </div>
      <label style={u.sectionLabel}>Anzahl gemeinsamer Kinder:</label>
      <select style={u.input} value={kinderAnzahl} onChange={e => setKinderAnzahl(e.target.value)}>
        <option value="0">Keine</option><option value="1">1 Kind</option><option value="2">2 Kinder</option><option value="3">3 Kinder</option><option value="4">4+</option>
      </select>
      <label style={u.sectionLabel}>Ehedauer (Jahre):</label>
      <input type="number" style={u.input} placeholder="z.B. 8" value={ehezeit} onChange={e => setEhezeit(e.target.value)} />
      <button style={u.btnPrimary} onClick={berechne}>Berechnen</button>
      {result && (
        <div style={u.resultBox}>
          {result.keinAnspruch ? <div style={u.warnung}>‚ö†Ô∏è Kein Unterhaltsanspruch.</div> : (
            <>
              <div style={u.calcStep}><span>Bereinigtes Netto Antragsteller*in:</span><span>{result.bereinigtA} ‚Ç¨</span></div>
              <div style={u.calcStep}><span>Bereinigtes Netto Verpflichteter:</span><span>{result.bereinigtV} ‚Ç¨</span></div>
              {parseFloat(result.kuAbzug) > 0 && <div style={u.calcStep}><span>‚Äì Kindesunterhalt (gesch√§tzt):</span><span>{result.kuAbzug} ‚Ç¨</span></div>}
              <div style={u.calcStep}><span>‚Äì Selbstbehalt Ehegatte:</span><span>1.200,00 ‚Ç¨</span></div>
              <div style={{ ...u.calcStep, borderTop: "1px solid #00afad", fontWeight: "bold", marginTop: "5px", paddingTop: "5px" }}><span>Verf√ºgbare Masse:</span><span>{result.masseF√ºrUnterhalt} ‚Ç¨</span></div>
              <div style={u.compositionBox}>
                <div style={{ ...u.resRow, fontWeight: "bold", fontSize: "16px", borderTop: "2px solid #003366", paddingTop: "5px", marginTop: "5px" }}>
                  <span>Trennungsunterhalt ca.:</span><span>{result.anspruch} ‚Ç¨ / Monat</span>
                </div>
              </div>
              <div style={{ fontSize: "10px", color: "#999", marginTop: "10px" }}>‚ö†Ô∏è Orientierungswert. Individuelle Beratung erforderlich.</div>
            </>
          )}
        </div>
      )}
    </div>
  );
}

// =============================================
// MODUL 3: NACHEHELICHER UNTERHALT (isoliert)
// =============================================
function NachehelicherUnterhaltsRechner() {
  const [einAntragsteller, setEinAntragsteller] = useState("");
  const [einVerpflichteter, setEinVerpflichteter] = useState("");
  const [abzuegeVerpflichteter, setAbzuegeVerpflichteter] = useState("");
  const [unterhaltstatbestand, setUnterhaltstatbestand] = useState("kinderbetreuung");
  const [kinderAnzahl, setKinderAnzahl] = useState("1");
  const [ehezeit, setEhezeit] = useState("");
  const [result, setResult] = useState(null);

  const tatbestaende = [
    { value: "kinderbetreuung", label: "¬ß 1570 ‚Äì Kinderbetreuung" },
    { value: "alter", label: "¬ß 1571 ‚Äì Alter" },
    { value: "krankheit", label: "¬ß 1572 ‚Äì Krankheit" },
    { value: "aufstockung", label: "¬ß 1573 ‚Äì Aufstockungsunterhalt" },
    { value: "ausbildung", label: "¬ß 1574 ‚Äì Ausbildung / Umschulung" },
    { value: "billigkeitsunterhalt", label: "¬ß 1576 ‚Äì Billigkeitsunterhalt" },
  ];

  const berechne = () => {
    const berA = parseFloat(einAntragsteller || 0);
    const berV = Math.max(0, parseFloat(einVerpflichteter || 0) - parseFloat(abzuegeVerpflichteter || 0));
    const bonusV = berV / 7;
    const bereinigtV = berV - bonusV;
    const kuAbzug = parseInt(kinderAnzahl) * 450;
    const selbstbehalt = 1300;
    const masseF√ºrUnterhalt = Math.max(0, bereinigtV - kuAbzug - selbstbehalt);
    const differenz = bereinigtV - berA;
    const anspruchRoh = Math.max(0, differenz / 2);
    const anspruch = Math.min(anspruchRoh, masseF√ºrUnterhalt);
    const ehejahre = parseFloat(ehezeit || 0);
    let befristungshinweis = "";
    if (ehejahre < 3) befristungshinweis = "Bei kurzer Ehedauer (< 3 Jahre) ist eine Befristung sehr wahrscheinlich.";
    else if (ehejahre < 10) befristungshinweis = "Bei mittlerer Ehedauer kann der Unterhalt zeitlich befristet werden.";
    else befristungshinweis = "Bei langer Ehedauer (> 10 Jahre) ist eine Befristung seltener, aber m√∂glich.";
    setResult({ bereinigtV: bereinigtV.toFixed(2), kuAbzug: kuAbzug.toFixed(2), masseF√ºrUnterhalt: masseF√ºrUnterhalt.toFixed(2), anspruch: anspruch.toFixed(2), keinAnspruch: differenz <= 0 || masseF√ºrUnterhalt <= 0, befristungshinweis });
  };

  const u = rStyles;
  return (
    <div>
      <h4 style={u.modTitle}>üíç Nachehelicher Unterhalt (¬ß¬ß 1569 ff. BGB)</h4>
      <div style={u.infoBox}>‚ÑπÔ∏è Selbstbehalt gegen√ºber Ex-Ehegatte: 1.300 ‚Ç¨.</div>
      <label style={u.sectionLabel}>Unterhaltstatbestand:</label>
      <select style={u.input} value={unterhaltstatbestand} onChange={e => setUnterhaltstatbestand(e.target.value)}>
        {tatbestaende.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}
      </select>
      <label style={u.sectionLabel}>Einkommen berechtigte Person:</label>
      <input type="number" style={u.input} placeholder="Nettoeinkommen (‚Ç¨, 0 wenn keines)" value={einAntragsteller} onChange={e => setEinAntragsteller(e.target.value)} />
      <label style={u.sectionLabel}>Einkommen Verpflichteter:</label>
      <div style={u.row}>
        <input type="number" style={u.input} placeholder="Nettoeinkommen (‚Ç¨)" value={einVerpflichteter} onChange={e => setEinVerpflichteter(e.target.value)} />
        <input type="number" style={u.input} placeholder="Abz√ºge (‚Ç¨)" value={abzuegeVerpflichteter} onChange={e => setAbzuegeVerpflichteter(e.target.value)} />
      </div>
      <label style={u.sectionLabel}>Anzahl Kinder:</label>
      <select style={u.input} value={kinderAnzahl} onChange={e => setKinderAnzahl(e.target.value)}>
        <option value="0">Keine</option><option value="1">1 Kind</option><option value="2">2 Kinder</option><option value="3">3 Kinder</option><option value="4">4+</option>
      </select>
      <label style={u.sectionLabel}>Ehedauer (Jahre):</label>
      <input type="number" style={u.input} placeholder="z.B. 12" value={ehezeit} onChange={e => setEhezeit(e.target.value)} />
      <button style={u.btnPrimary} onClick={berechne}>Berechnen</button>
      {result && (
        <div style={u.resultBox}>
          {result.keinAnspruch ? <div style={u.warnung}>‚ö†Ô∏è Kein Unterhaltsanspruch nach diesen Angaben.</div> : (
            <>
              <div style={u.calcStep}><span>Bereinigtes Netto Verpflichteter:</span><span>{result.bereinigtV} ‚Ç¨</span></div>
              {parseFloat(result.kuAbzug) > 0 && <div style={u.calcStep}><span>‚Äì Kindesunterhalt (gesch√§tzt):</span><span>{result.kuAbzug} ‚Ç¨</span></div>}
              <div style={u.calcStep}><span>‚Äì Selbstbehalt Ex-Ehegatte:</span><span>1.300,00 ‚Ç¨</span></div>
              <div style={{ ...u.calcStep, borderTop: "1px solid #00afad", fontWeight: "bold", marginTop: "5px", paddingTop: "5px" }}><span>Verf√ºgbare Masse:</span><span>{result.masseF√ºrUnterhalt} ‚Ç¨</span></div>
              <div style={u.compositionBox}>
                <div style={{ ...u.resRow, fontWeight: "bold", fontSize: "16px", borderTop: "2px solid #003366", paddingTop: "5px", marginTop: "5px" }}>
                  <span>Nachehelicher Unterhalt ca.:</span><span>{result.anspruch} ‚Ç¨ / Monat</span>
                </div>
              </div>
              {ehezeit && <div style={{ ...u.infoBox, marginTop: "10px" }}>üìÖ <strong>Befristung:</strong> {result.befristungshinweis}</div>}
              <div style={{ fontSize: "10px", color: "#999", marginTop: "10px" }}>‚ö†Ô∏è Orientierungswert. Individuelle anwaltliche Beratung unbedingt erforderlich.</div>
            </>
          )}
        </div>
      )}
    </div>
  );
}

// =============================================
// GEMEINSAME STYLES F√úR ALLE RECHNER-MODULE
// =============================================
const rStyles = {
  modTitle: { fontSize: "14px", color: "#003366", fontWeight: "bold", margin: "0 0 12px 0", paddingBottom: "8px", borderBottom: "2px solid #00afad" },
  input: { width: "100%", padding: "10px", marginBottom: "10px", borderRadius: "6px", border: "1px solid #ddd", boxSizing: "border-box", fontSize: "13px" },
  row: { display: "flex", gap: "10px" },
  btnPrimary: { width: "100%", padding: "12px", backgroundColor: "#003366", color: "#fff", border: "none", borderRadius: "10px", fontWeight: "bold", cursor: "pointer", marginTop: "5px" },
  filterSection: { backgroundColor: "#f0f4f7", padding: "10px", borderRadius: "10px", margin: "10px 0" },
  childBox: { backgroundColor: "#fff", padding: "10px", borderRadius: "6px", marginBottom: "8px" },
  tagCloud: { display: "flex", flexWrap: "wrap", gap: "5px", marginTop: "5px", marginBottom: "8px" },
  bedarfRow: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "4px" },
  miniIn: { width: "60px", padding: "3px", fontSize: "10px", border: "1px solid #ccc", borderRadius: "4px" },
  resultBox: { marginTop: "15px", padding: "15px", backgroundColor: "#f0fdfd", borderRadius: "10px", border: "1px solid #00afad" },
  calcStep: { display: "flex", justifyContent: "space-between", fontSize: "12px", marginBottom: "3px" },
  resRow: { display: "flex", justifyContent: "space-between", fontSize: "12px", marginTop: "2px" },
  compositionBox: { marginTop: "10px", padding: "10px", backgroundColor: "#fff", borderRadius: "8px", border: "1px solid #eee" },
  detailRow: { marginTop: "8px", borderBottom: "1px dashed #ddd", paddingBottom: "5px" },
  sbBox: { marginTop: "10px", padding: "8px", backgroundColor: "#fff9e6", borderRadius: "6px", border: "1px solid #ffeeba", color: "#856404" },
  warnung: { backgroundColor: "#fff3cd", border: "1px solid #ffc107", borderRadius: "6px", padding: "8px", marginBottom: "10px", fontSize: "11px", color: "#856404" },
  infoBox: { backgroundColor: "#e8f4fd", border: "1px solid #bee5f8", borderRadius: "6px", padding: "8px", marginBottom: "10px", fontSize: "11px", color: "#0c5460" },
  labelMini: { fontSize: "11px", fontWeight: "bold", color: "#666", display: "block", marginBottom: "4px" },
  sectionLabel: { fontSize: "10px", fontWeight: "bold", color: "#666", display: "block", marginBottom: "4px", marginTop: "6px", textTransform: "uppercase" },
  btnAdd: { backgroundColor: "#00afad", color: "#fff", border: "none", padding: "4px 8px", borderRadius: "4px", fontSize: "10px", cursor: "pointer" },
  btnDel: { backgroundColor: "#ff4d4d", color: "#fff", border: "none", padding: "2px 6px", borderRadius: "4px", cursor: "pointer", fontSize: "10px" },
  inputMini: { padding: "4px", fontSize: "11px", borderRadius: "4px", border: "1px solid #ddd" },
};

// =============================================
// MODUL 4: MEHRBEDARF ALLEINERZIEHENDE
// =============================================
function MehrbedarfAlleinerziehende() {
  const [modell, setModell] = useState("");
  const [kinderKonf, setKinderKonf] = useState("1u7");
  const [result, setResult] = useState(null);
  const regelbedarf = 563;

  const konstellationen = [
    { id: "1u7", label: "1 Kind unter 7 Jahren (36%)", prozent: 36 },
    { id: "1ue7", label: "1 Kind √ºber 7 Jahren (12%)", prozent: 12 },
    { id: "23u16", label: "2‚Äì3 Kinder unter 16 Jahren (36%)", prozent: 36 },
    { id: "2ue16", label: "2 Kinder √ºber 16 Jahren (24%)", prozent: 24 },
    { id: "4k", label: "4 Kinder generell (48%)", prozent: 48 },
    { id: "5k", label: "Ab 5 Kinder (60%)", prozent: 60 },
  ];

  const berechne = () => {
    const kons = konstellationen.find(k => k.id === kinderKonf);
    if (!kons) return;
    let prozent = kons.prozent;
    let hinweis = "";
    if (modell === "paritaetisch") { prozent = prozent / 2; hinweis = "Beim parit√§tischen Wechselmodell wird der Mehrbedarf h√§lftig aufgeteilt (BA-Weisung Ziff. 21.11)."; }
    else if (modell === "asymmetrisch") { hinweis = "Beim asymmetrischen Modell erh√§lt nur der hauptbetreuende Elternteil den vollen Mehrbedarf."; }
    setResult({ prozent: prozent.toFixed(1), betrag: (regelbedarf * prozent / 100).toFixed(2), hinweis });
  };

  const u = rStyles;
  return (
    <div>
      <h4 style={u.modTitle}>üë®‚Äçüëß Mehrbedarf Alleinerziehende (¬ß 21 Abs.3 SGB II)</h4>
      <div style={u.infoBox}>‚ÑπÔ∏è Bezugsgr√∂√üe: Regelbedarf = 563,00 ‚Ç¨. Mehrbedarf darf Regelbedarf nicht √ºbersteigen.</div>
      <label style={u.sectionLabel}>Kinderkonstellation:</label>
      <select style={u.input} value={kinderKonf} onChange={e => setKinderKonf(e.target.value)}>
        {konstellationen.map(k => <option key={k.id} value={k.id}>{k.label}</option>)}
      </select>
      <label style={u.sectionLabel}>Betreuungsmodell:</label>
      <div style={{ display: "flex", flexDirection: "column", gap: "6px", marginBottom: "12px" }}>
        {[{ id: "paritaetisch", label: "Parit√§tisches Wechselmodell (ca. 50:50) ‚Üí Mehrbedarf wird geteilt" }, { id: "asymmetrisch", label: "Asymmetrisches / Residenzmodell ‚Üí voller Mehrbedarf" }].map(m => (
          <label key={m.id} style={{ display: "flex", alignItems: "flex-start", gap: "8px", fontSize: "12px", cursor: "pointer" }}>
            <input type="radio" name="modell_mb" value={m.id} checked={modell === m.id} onChange={() => setModell(m.id)} style={{ marginTop: "2px" }} />{m.label}
          </label>
        ))}
      </div>
      <button style={u.btnPrimary} onClick={berechne} disabled={!modell}>Berechnen</button>
      {result && (
        <div style={u.resultBox}>
          <div style={u.calcStep}><span>Regelbedarf:</span><span>563,00 ‚Ç¨</span></div>
          <div style={u.calcStep}><span>Mehrbedarf-Prozentsatz:</span><span>{result.prozent} %</span></div>
          <div style={{ ...u.calcStep, borderTop: "1px solid #00afad", fontWeight: "bold", marginTop: "5px", paddingTop: "5px" }}><span>Mehrbedarf monatlich:</span><span>{result.betrag} ‚Ç¨</span></div>
          {result.hinweis && <div style={{ ...u.infoBox, marginTop: "10px" }}>üìã {result.hinweis}</div>}
        </div>
      )}
    </div>
  );
}

// =============================================
// MODUL 5: MEHRBEDARF UMGANGSKOSTEN
// =============================================
function MehrbedarfUmgangskosten() {
  const [fahrtkosten, setFahrtkosten] = useState("");
  const [uebernachtung, setUebernachtung] = useState("");
  const [telefon, setTelefon] = useState("");
  const [sonstige, setSonstige] = useState("");
  const [umgangsart, setUmgangsart] = useState("regelmaessig");
  const [umgangsItems, setUmgangsItems] = useState([]);
  const [result, setResult] = useState(null);

  const umgangsOptionen = [
    "Fahrtkosten Kind zum umgangsberechtigten Elternteil",
    "Fahrtkosten Kind vom Wohnort zur Schule",
    "Bring- und Abholfahrten des Elternteils",
    "Fahrten zum Umgang am Wohnort des Kindes",
    "√úbernachtungskosten am Wohnort des Kindes",
    "Telefonkosten / Internetkosten (weite Entfernung)",
    "Fahrten zum Kind in Obhut / Behinderteneinrichtung",
    "Fahrten zum inhaftierten Kind / Elternteil",
  ];

  const toggleItem = (opt) => setUmgangsItems(prev => prev.includes(opt) ? prev.filter(i => i !== opt) : [...prev, opt]);

  const berechne = () => {
    const gesamt = parseFloat(fahrtkosten || 0) + parseFloat(uebernachtung || 0) + parseFloat(telefon || 0) + parseFloat(sonstige || 0);
    const hinweis = umgangsart === "regelmaessig" ? "Regelm√§√üige Umgangskosten k√∂nnen als Mehrbedarf anerkannt werden. Belege und Umgangsregelung bereithalten." : "Seltene Umgangskosten werden h√§ufig nur eingeschr√§nkt anerkannt.";
    setResult({ gesamt: gesamt.toFixed(2), hinweis });
  };

  const u = rStyles;
  return (
    <div>
      <h4 style={u.modTitle}>üöó Mehrbedarf Umgangskosten (¬ß 21 SGB II)</h4>
      <div style={u.infoBox}>‚ÑπÔ∏è Nur Fahrtkosten und ggf. √úbernachtungskosten ‚Äì keine Kosten, die das Kind beim Umgangsberechtigten verursacht.</div>
      <label style={u.sectionLabel}>Art der Umgangskontakte:</label>
      <div style={{ display: "flex", gap: "8px", marginBottom: "12px" }}>
        {[{ id: "regelmaessig", label: "Regelm√§√üig" }, { id: "selten", label: "Selten / Weit entfernt" }].map(a => (
          <div key={a.id} onClick={() => setUmgangsart(a.id)} style={{ padding: "6px 12px", borderRadius: "8px", fontSize: "11px", cursor: "pointer", backgroundColor: umgangsart === a.id ? "#00afad" : "#eee", color: umgangsart === a.id ? "#fff" : "#333" }}>{a.label}</div>
        ))}
      </div>
      <label style={u.sectionLabel}>Kostenarten (zur Dokumentation):</label>
      <div style={{ marginBottom: "12px" }}>
        {umgangsOptionen.map((opt, i) => (
          <label key={i} style={{ display: "flex", alignItems: "flex-start", gap: "8px", fontSize: "11px", cursor: "pointer", marginBottom: "5px" }}>
            <input type="checkbox" checked={umgangsItems.includes(opt)} onChange={() => toggleItem(opt)} style={{ marginTop: "2px" }} />{opt}
          </label>
        ))}
      </div>
      <label style={u.sectionLabel}>Monatliche Kosten (‚Ç¨):</label>
      <div style={u.row}>
        <input type="number" style={u.input} placeholder="Fahrtkosten" value={fahrtkosten} onChange={e => setFahrtkosten(e.target.value)} />
        <input type="number" style={u.input} placeholder="√úbernachtung" value={uebernachtung} onChange={e => setUebernachtung(e.target.value)} />
      </div>
      <div style={u.row}>
        <input type="number" style={u.input} placeholder="Telefon/Internet" value={telefon} onChange={e => setTelefon(e.target.value)} />
        <input type="number" style={u.input} placeholder="Sonstige" value={sonstige} onChange={e => setSonstige(e.target.value)} />
      </div>
      <button style={u.btnPrimary} onClick={berechne}>Berechnen</button>
      {result && (
        <div style={u.resultBox}>
          <div style={u.calcStep}><span>Fahrtkosten:</span><span>{parseFloat(fahrtkosten || 0).toFixed(2)} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>√úbernachtung:</span><span>{parseFloat(uebernachtung || 0).toFixed(2)} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>Telefon/Internet:</span><span>{parseFloat(telefon || 0).toFixed(2)} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>Sonstige:</span><span>{parseFloat(sonstige || 0).toFixed(2)} ‚Ç¨</span></div>
          <div style={{ ...u.calcStep, borderTop: "1px solid #00afad", fontWeight: "bold", marginTop: "5px", paddingTop: "5px" }}><span>Gesamte Umgangskosten:</span><span>{result.gesamt} ‚Ç¨</span></div>
          <div style={{ ...u.infoBox, marginTop: "10px" }}>üìã {result.hinweis}</div>
          <div style={{ fontSize: "10px", color: "#999", marginTop: "8px" }}>‚ö†Ô∏è Anerkennung liegt im Ermessen des Jobcenters. Belege bereithalten.</div>
        </div>
      )}
    </div>
  );
}

// =============================================
// MODUL 6: TEMPOR√ÑRE BEDARFSGEMEINSCHAFT (TBG)
// =============================================
function TemporaereBedarfsgemeinschaft() {
  const [modell, setModell] = useState("");
  const [kalender, setKalender] = useState(Array(12).fill({ antragsteller: "", anderer: "" }));
  const [regelbedarf] = useState(563);
  const [kgEmpf√§nger, setKgEmpf√§nger] = useState("");
  const [kgBetrag, setKgBetrag] = useState("250");
  const [kgGeteilt, setKgGeteilt] = useState("");
  const [result, setResult] = useState(null);

  const monate = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];

  const updateKalender = (idx, seite, val) => {
    setKalender(kalender.map((m, i) => i === idx ? { ...m, [seite]: val } : m));
  };

  const kgFragenVollstaendig = () => {
    if (!kgEmpf√§nger) return false;
    if (modell === "paritaetisch" && kgEmpf√§nger === "anderer" && !kgGeteilt) return false;
    return true;
  };

  const berechne = () => {
    const tageA = kalender.reduce((s, m) => s + parseFloat(m.antragsteller || 0), 0);
    const tageB = kalender.reduce((s, m) => s + parseFloat(m.anderer || 0), 0);
    const gesamtTage = tageA + tageB;
    if (gesamtTage === 0) return;
    const anteilA = tageA / gesamtTage;
    const anteilB = tageB / gesamtTage;
    const regelbedarfKind = 390;
    const mbGesamt = regelbedarf * 36 / 100;
    let regelA = 0, regelB = 0, mehrA = 0, mehrB = 0, hinweis = "";
    if (modell === "paritaetisch") {
      regelA = regelbedarfKind * 0.5; regelB = regelbedarfKind * 0.5;
      mehrA = mbGesamt / 2; mehrB = mbGesamt / 2;
      hinweis = "Parit√§tisches Modell: Regelbedarf Kind und Mehrbedarf ¬ß 21 werden je h√§lftig aufgeteilt (BA-Weisung Ziff. 21.11).";
    } else {
      regelA = regelbedarfKind * anteilA; regelB = regelbedarfKind * anteilB;
      if (anteilA >= anteilB) { mehrA = mbGesamt; } else { mehrB = mbGesamt; }
      hinweis = "Asymmetrisches Modell: Regelbedarfsanteil tagesanteilig. Mehrbedarf ¬ß 21 nur f√ºr den hauptbetreuenden Elternteil.";
    }
    const kg = parseFloat(kgBetrag || 0);
    let kgAntragsteller = 0, kgHinweis = "";
    if (kgEmpf√§nger === "antragsteller") {
      kgAntragsteller = kg;
      kgHinweis = "Das Kindergeld wird beim Antragsteller als Einkommen angerechnet und mindert den B√ºrgergeld-Anspruch.";
    } else if (kgEmpf√§nger === "anderer") {
      if (modell === "paritaetisch" && kgGeteilt === "ja") {
        kgAntragsteller = kg / 2;
        kgHinweis = "Das Kindergeld wird h√§lftig geteilt. Der Anteil (" + (kg / 2).toFixed(2) + " ‚Ç¨) wird angerechnet.";
      } else {
        kgHinweis = "Das Kindergeld verbleibt beim anderen Elternteil und wird beim Antragsteller nicht angerechnet.";
      }
    }
    setResult({
      tageA: tageA.toFixed(0), tageB: tageB.toFixed(0),
      anteilA: (anteilA * 100).toFixed(1), anteilB: (anteilB * 100).toFixed(1),
      regelA: regelA.toFixed(2), regelB: regelB.toFixed(2),
      mehrA: mehrA.toFixed(2), mehrB: mehrB.toFixed(2),
      gesamtB: (regelB + mehrB).toFixed(2),
      kgAntragsteller: kgAntragsteller.toFixed(2),
      kgHinweis, hinweis,
      nettoA: Math.max(0, regelA + mehrA - kgAntragsteller).toFixed(2)
    });
  };

  const u = rStyles;
  const bereit = modell && kgFragenVollstaendig();

  return (
    <div>
      <h4 style={u.modTitle}>üè† Tempor√§re Bedarfsgemeinschaft (TBG)</h4>
      <div style={u.infoBox}>‚ÑπÔ∏è Berechnung der Leistungsaufteilung bei zeitweisem Aufenthalt des Kindes in beiden Haushalten.</div>

      <label style={u.sectionLabel}>Schritt 1 ‚Äì Betreuungsmodell:</label>
      <div style={{ display: "flex", flexDirection: "column", gap: "6px", marginBottom: "12px" }}>
        <label style={{ display: "flex", alignItems: "flex-start", gap: "8px", fontSize: "12px", cursor: "pointer" }}>
          <input type="radio" name="tbg_m" checked={modell === "paritaetisch"} onChange={() => { setModell("paritaetisch"); setKgGeteilt(""); setResult(null); }} style={{ marginTop: "2px" }} />
          <span><strong>Parit√§tisches Wechselmodell</strong> ‚Äì ca. 50:50 (13/17, 14/16 oder 15/15 Tage)</span>
        </label>
        <label style={{ display: "flex", alignItems: "flex-start", gap: "8px", fontSize: "12px", cursor: "pointer" }}>
          <input type="radio" name="tbg_m" checked={modell === "asymmetrisch"} onChange={() => { setModell("asymmetrisch"); setKgGeteilt(""); setResult(null); }} style={{ marginTop: "2px" }} />
          <span><strong>Asymmetrisches Wechselmodell / Residenzmodell</strong> ‚Äì 2‚Äì12 Tage beim anderen Elternteil</span>
        </label>
      </div>

      {modell && (
        <>
          <label style={u.sectionLabel}>Schritt 2 ‚Äì Kalender: Tage pro Monat (√úbernachtungen):</label>
          <div style={{ backgroundColor: "#f0f4f7", borderRadius: "8px", padding: "10px", marginBottom: "12px" }}>
            <div style={{ display: "grid", gridTemplateColumns: "1.5fr 1fr 1fr", gap: "4px", marginBottom: "6px" }}>
              <span style={{ fontSize: "10px", fontWeight: "bold" }}>Monat</span>
              <span style={{ fontSize: "10px", fontWeight: "bold", textAlign: "center" }}>Antragsteller*in</span>
              <span style={{ fontSize: "10px", fontWeight: "bold", textAlign: "center" }}>And. Elternteil</span>
            </div>
            {monate.map((m, i) => (
              <div key={m} style={{ display: "grid", gridTemplateColumns: "1.5fr 1fr 1fr", gap: "4px", marginBottom: "3px", alignItems: "center" }}>
                <span style={{ fontSize: "11px" }}>{m}</span>
                <input type="number" style={{ ...u.miniIn, width: "100%", textAlign: "center" }} placeholder="Tage" value={kalender[i].antragsteller} onChange={e => updateKalender(i, "antragsteller", e.target.value)} />
                <input type="number" style={{ ...u.miniIn, width: "100%", textAlign: "center" }} placeholder="Tage" value={kalender[i].anderer} onChange={e => updateKalender(i, "anderer", e.target.value)} />
              </div>
            ))}
          </div>

          <label style={u.sectionLabel}>Schritt 3 ‚Äì Kindergeld:</label>
          <div style={{ ...u.infoBox, marginBottom: "10px" }}>
            ‚ÑπÔ∏è Das Kindergeld erh√§lt in der Regel der √ºberwiegend betreuende Elternteil bzw. derjenige, bei dem das Kind gemeldet ist ‚Äì nicht automatisch der Antragsteller.
          </div>
          <label style={{ fontSize: "12px", display: "block", marginBottom: "6px" }}>Wer bezieht das Kindergeld?</label>
          <div style={{ display: "flex", flexDirection: "column", gap: "6px", marginBottom: "12px" }}>
            <label style={{ display: "flex", alignItems: "center", gap: "8px", fontSize: "12px", cursor: "pointer" }}>
              <input type="radio" name="kg_e" checked={kgEmpf√§nger === "antragsteller"} onChange={() => { setKgEmpf√§nger("antragsteller"); setKgGeteilt(""); setResult(null); }} />
              Antragsteller*in bezieht das Kindergeld selbst
            </label>
            <label style={{ display: "flex", alignItems: "center", gap: "8px", fontSize: "12px", cursor: "pointer" }}>
              <input type="radio" name="kg_e" checked={kgEmpf√§nger === "anderer"} onChange={() => { setKgEmpf√§nger("anderer"); setKgGeteilt(""); setResult(null); }} />
              Anderer Elternteil bezieht das Kindergeld
            </label>
          </div>

          {modell === "paritaetisch" && kgEmpf√§nger === "anderer" && (
            <div style={{ backgroundColor: "#fff9e6", border: "1px solid #ffeeba", borderRadius: "8px", padding: "10px", marginBottom: "12px" }}>
              <label style={{ fontSize: "12px", display: "block", marginBottom: "6px", fontWeight: "bold" }}>
                Wird das Kindergeld beim parit√§tischen Modell h√§lftig geteilt / weitergeleitet?
              </label>
              <div style={{ display: "flex", gap: "8px" }}>
                <div onClick={() => { setKgGeteilt("ja"); setResult(null); }} style={{ padding: "6px 14px", borderRadius: "8px", fontSize: "12px", cursor: "pointer", backgroundColor: kgGeteilt === "ja" ? "#00afad" : "#eee", color: kgGeteilt === "ja" ? "#fff" : "#333" }}>Ja, wird geteilt</div>
                <div onClick={() => { setKgGeteilt("nein"); setResult(null); }} style={{ padding: "6px 14px", borderRadius: "8px", fontSize: "12px", cursor: "pointer", backgroundColor: kgGeteilt === "nein" ? "#003366" : "#eee", color: kgGeteilt === "nein" ? "#fff" : "#333" }}>Nein, verbleibt beim anderen</div>
              </div>
            </div>
          )}

          {kgEmpf√§nger && (modell !== "paritaetisch" || kgEmpf√§nger !== "anderer" || kgGeteilt) && (
            <>
              <label style={u.sectionLabel}>Kindergeldbetrag (‚Ç¨/Monat):</label>
              <input type="number" style={u.input} placeholder="z.B. 250" value={kgBetrag} onChange={e => setKgBetrag(e.target.value)} />
            </>
          )}
        </>
      )}

      <button style={{ ...u.btnPrimary, opacity: bereit ? 1 : 0.5 }} onClick={berechne} disabled={!bereit}>Berechnen</button>
      {!bereit && modell && <div style={{ fontSize: "11px", color: "#999", marginTop: "6px", textAlign: "center" }}>Bitte alle Fragen beantworten um die Berechnung zu starten.</div>}

      {result && (
        <div style={u.resultBox}>
          <div style={u.calcStep}><span>Tage Antragsteller*in:</span><span>{result.tageA} Tage ({result.anteilA}%)</span></div>
          <div style={{ ...u.calcStep, marginBottom: "10px" }}><span>Tage and. Elternteil:</span><span>{result.tageB} Tage ({result.anteilB}%)</span></div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "8px" }}>
            <div style={{ ...u.compositionBox, margin: 0 }}>
              <div style={{ fontSize: "11px", fontWeight: "bold", color: "#003366", marginBottom: "6px" }}>Antragsteller*in</div>
              <div style={u.calcStep}><span style={{ fontSize: "11px" }}>Regelbedarf Kind:</span><span>{result.regelA} ‚Ç¨</span></div>
              <div style={u.calcStep}><span style={{ fontSize: "11px" }}>Mehrbedarf ¬ß 21:</span><span>{result.mehrA} ‚Ç¨</span></div>
              {parseFloat(result.kgAntragsteller) > 0 && <div style={u.calcStep}><span style={{ fontSize: "11px" }}>‚Äì Kindergeld:</span><span>{result.kgAntragsteller} ‚Ç¨</span></div>}
              <div style={{ ...u.calcStep, borderTop: "1px solid #003366", paddingTop: "4px", fontWeight: "bold" }}><span>Netto-Anspruch:</span><span>{result.nettoA} ‚Ç¨</span></div>
            </div>
            <div style={{ ...u.compositionBox, margin: 0 }}>
              <div style={{ fontSize: "11px", fontWeight: "bold", color: "#003366", marginBottom: "6px" }}>And. Elternteil</div>
              <div style={u.calcStep}><span style={{ fontSize: "11px" }}>Regelbedarf Kind:</span><span>{result.regelB} ‚Ç¨</span></div>
              <div style={u.calcStep}><span style={{ fontSize: "11px" }}>Mehrbedarf ¬ß 21:</span><span>{result.mehrB} ‚Ç¨</span></div>
              <div style={{ ...u.calcStep, borderTop: "1px solid #003366", paddingTop: "4px", fontWeight: "bold" }}><span>Gesamt:</span><span>{result.gesamtB} ‚Ç¨</span></div>
            </div>
          </div>
          {result.hinweis && <div style={{ ...u.infoBox, marginTop: "10px" }}>üìã {result.hinweis}</div>}
          {result.kgHinweis && <div style={{ backgroundColor: "#fff9e6", border: "1px solid #ffeeba", borderRadius: "6px", padding: "8px", marginTop: "8px", fontSize: "11px", color: "#856404" }}>üí∂ {result.kgHinweis}</div>}
        </div>
      )}
    </div>
  );
}

// =============================================
// MODUL 7: WOHNGELD-RECHNER
// =============================================
function WohngeldRechner() {
  const [haushaltGroesse, setHaushaltGroesse] = useState("1");
  const [bruttomiete, setBruttomiete] = useState("");
  const [bruttoEinkommen, setBruttoEinkommen] = useState("");
  const [steuerAbzug, setSteuerAbzug] = useState("");
  const [svAbzug, setSvAbzug] = useState("");
  const [unterhaltsTitel, setUnterhaltsTitel] = useState("nein");
  const [unterhaltHoehe, setUnterhaltHoehe] = useState("");
  const [unterhaltWirdBedient, setUnterhaltWirdBedient] = useState("ja");
  const [weitereAbzuege, setWeitereAbzuege] = useState("");
  const [mietStufe, setMietStufe] = useState("3");
  const [result, setResult] = useState(null);

  const hoechstbetraege = {
    "1": { "1": 404, "2": 449, "3": 502, "4": 548, "5": 591, "6": 660 },
    "2": { "1": 490, "2": 545, "3": 610, "4": 666, "5": 718, "6": 803 },
    "3": { "1": 585, "2": 651, "3": 729, "4": 796, "5": 859, "6": 960 },
    "4": { "1": 672, "2": 747, "3": 836, "4": 913, "5": 984, "6": 1100 },
    "5": { "1": 760, "2": 845, "3": 946, "4": 1032, "5": 1113, "6": 1245 },
  };

  const berechneFreibetrag = (netto) => {
    let frei = 0;
    if (netto <= 100) return netto;
    frei += 100;
    if (netto > 100) frei += Math.min(netto - 100, 420) * 0.20;
    if (netto > 520) frei += Math.min(netto - 520, 480) * 0.30;
    if (netto > 1000) frei += Math.min(netto - 1000, 500) * 0.10;
    return frei;
  };

  const berechne = () => {
    const brutto = parseFloat(bruttoEinkommen || 0);
    const steuer = parseFloat(steuerAbzug || 0);
    const sv = parseFloat(svAbzug || 0);
    let netto = Math.max(0, brutto - steuer - sv);
    let unterhaltAbzug = 0;
    if (unterhaltsTitel === "ja" && unterhaltWirdBedient === "ja") {
      unterhaltAbzug = parseFloat(unterhaltHoehe || 0);
      netto = Math.max(0, netto - unterhaltAbzug);
    }
    const verfuegbar = Math.max(0, netto - parseFloat(weitereAbzuege || 0));
    const freibetrag = berechneFreibetrag(verfuegbar);
    const anzurechnendes = Math.max(0, verfuegbar - freibetrag);
    const miete = parseFloat(bruttomiete || 0);
    const hoechst = (hoechstbetraege[haushaltGroesse] && hoechstbetraege[haushaltGroesse][mietStufe]) ? hoechstbetraege[haushaltGroesse][mietStufe] : 502;
    const anrechenbareMiete = Math.min(miete, hoechst);
    const a = 0.04; const b = 0.46; const c = 0.000097;
    const wg = Math.max(0, 1.15 * (anrechenbareMiete - (a + b * haushaltGroesse) * anzurechnendes - c * anzurechnendes * anzurechnendes));
    const wohngeld = Math.round(Math.min(wg, anrechenbareMiete));
    setResult({ netto: netto.toFixed(2), unterhaltAbzug: unterhaltAbzug.toFixed(2), verfuegbar: verfuegbar.toFixed(2), freibetrag: freibetrag.toFixed(2), anzurechnendes: anzurechnendes.toFixed(2), anrechenbareMiete: anrechenbareMiete.toFixed(2), hoechst: hoechst.toFixed(2), wohngeld, keinAnspruch: wohngeld <= 0, unterhaltNichtAbgezogen: unterhaltsTitel === "ja" && unterhaltWirdBedient === "nein" });
  };

  const u = rStyles;
  return (
    <div>
      <h4 style={u.modTitle}>üè° Wohngeld-Rechner (WoGG)</h4>
      <div style={u.infoBox}>‚ÑπÔ∏è Titulierter und tats√§chlich gezahlter Unterhalt wird vom anrechenbaren Einkommen abgezogen. Orientierungsrechner ‚Äì individuelle Pr√ºfung empfohlen.</div>
      <label style={u.sectionLabel}>Haushaltsgr√∂√üe:</label>
      <select style={u.input} value={haushaltGroesse} onChange={e => setHaushaltGroesse(e.target.value)}>
        {["1","2","3","4","5"].map(n => <option key={n} value={n}>{n} {n === "1" ? "Person" : "Personen"}</option>)}
      </select>
      <label style={u.sectionLabel}>Mietenstufe der Gemeinde:</label>
      <select style={u.input} value={mietStufe} onChange={e => setMietStufe(e.target.value)}>
        <option value="1">Stufe I (sehr g√ºnstig, l√§ndlich)</option>
        <option value="2">Stufe II</option>
        <option value="3">Stufe III (Mittelst√§dte)</option>
        <option value="4">Stufe IV (Gro√üst√§dte)</option>
        <option value="5">Stufe V (teure St√§dte)</option>
        <option value="6">Stufe VI (Hochpreislagen, z.B. M√ºnchen)</option>
      </select>
      <label style={u.sectionLabel}>Bruttomiete inkl. Heizkosten (‚Ç¨/Monat):</label>
      <input type="number" style={u.input} placeholder="z.B. 750" value={bruttomiete} onChange={e => setBruttomiete(e.target.value)} />
      <label style={u.sectionLabel}>Einkommen:</label>
      <div style={u.row}>
        <input type="number" style={u.input} placeholder="Bruttoeinkommen (‚Ç¨)" value={bruttoEinkommen} onChange={e => setBruttoEinkommen(e.target.value)} />
        <input type="number" style={u.input} placeholder="Steuern (‚Ç¨)" value={steuerAbzug} onChange={e => setSteuerAbzug(e.target.value)} />
      </div>
      <input type="number" style={u.input} placeholder="Sozialversicherungsbeitr√§ge (‚Ç¨)" value={svAbzug} onChange={e => setSvAbzug(e.target.value)} />
      <label style={u.sectionLabel}>Unterhaltstitel vorhanden?</label>
      <div style={{ display: "flex", gap: "8px", marginBottom: "10px" }}>
        {[{ id: "ja", label: "Ja" }, { id: "nein", label: "Nein" }].map(v => (
          <div key={v.id} onClick={() => setUnterhaltsTitel(v.id)} style={{ padding: "6px 16px", borderRadius: "8px", fontSize: "12px", cursor: "pointer", backgroundColor: unterhaltsTitel === v.id ? "#003366" : "#eee", color: unterhaltsTitel === v.id ? "#fff" : "#333" }}>{v.label}</div>
        ))}
      </div>
      {unterhaltsTitel === "ja" && (
        <div>
          <label style={u.sectionLabel}>Titulierter Unterhaltsbetrag (‚Ç¨/Monat):</label>
          <input type="number" style={u.input} placeholder="z.B. 450" value={unterhaltHoehe} onChange={e => setUnterhaltHoehe(e.target.value)} />
          <label style={u.sectionLabel}>Wird der Unterhalt tats√§chlich gezahlt?</label>
          <div style={{ display: "flex", gap: "8px", marginBottom: "10px" }}>
            {[{ id: "ja", label: "Ja, wird gezahlt" }, { id: "nein", label: "Nein, wird nicht gezahlt" }].map(v => (
              <div key={v.id} onClick={() => setUnterhaltWirdBedient(v.id)} style={{ padding: "6px 12px", borderRadius: "8px", fontSize: "11px", cursor: "pointer", backgroundColor: unterhaltWirdBedient === v.id ? "#00afad" : "#eee", color: unterhaltWirdBedient === v.id ? "#fff" : "#333" }}>{v.label}</div>
            ))}
          </div>
          {unterhaltWirdBedient === "nein" && <div style={u.warnung}>‚ö†Ô∏è Nur tats√§chlich gezahlter Unterhalt auf Basis eines Titels wird abgezogen.</div>}
        </div>
      )}
      <label style={u.sectionLabel}>Weitere Abz√ºge (Altersvorsorge, Kredite, ‚Ç¨/Monat):</label>
      <input type="number" style={u.input} placeholder="z.B. 100" value={weitereAbzuege} onChange={e => setWeitereAbzuege(e.target.value)} />
      <button style={u.btnPrimary} onClick={berechne}>Berechnen</button>
      {result && (
        <div style={u.resultBox}>
          {result.unterhaltNichtAbgezogen && <div style={u.warnung}>‚ÑπÔ∏è Unterhalt wird nicht abgezogen, da nicht bedient.</div>}
          <div style={u.calcStep}><span>Nettoeinkommen:</span><span>{result.netto} ‚Ç¨</span></div>
          {parseFloat(result.unterhaltAbzug) > 0 && <div style={u.calcStep}><span>‚Äì Unterhalt (tituliert & gezahlt):</span><span>{result.unterhaltAbzug} ‚Ç¨</span></div>}
          <div style={u.calcStep}><span>Verf√ºgbares Einkommen:</span><span>{result.verfuegbar} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>‚Äì Freibetrag (¬ß 11 SGB II):</span><span>{result.freibetrag} ‚Ç¨</span></div>
          <div style={{ ...u.calcStep, borderTop: "1px solid #00afad", marginTop: "5px", paddingTop: "5px" }}><span>Anzurechnendes Einkommen:</span><span>{result.anzurechnendes} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>Anrechenbare Miete (max. {result.hoechst} ‚Ç¨):</span><span>{result.anrechenbareMiete} ‚Ç¨</span></div>
          {result.keinAnspruch
            ? <div style={{ ...u.warnung, marginTop: "10px" }}>‚ö†Ô∏è Kein Wohngeldanspruch. Ggf. B√ºrgergeld-Antrag pr√ºfen.</div>
            : <div style={{ ...u.compositionBox, marginTop: "10px" }}><div style={{ ...u.resRow, fontWeight: "bold", fontSize: "16px", borderTop: "2px solid #003366", paddingTop: "5px" }}><span>Wohngeld ca.:</span><span>{result.wohngeld} ‚Ç¨ / Monat</span></div></div>
          }
          <div style={{ fontSize: "10px", color: "#999", marginTop: "8px" }}>‚ö†Ô∏è Orientierungswert nach WoGG. F√ºr genaue Berechnung: Wohngeldstelle kontaktieren.</div>
        </div>
      )}
    </div>
  );
}

// =============================================
// MODUL: BETREUUNGSUNTERHALT (¬ß 1615l BGB)
// =============================================
function BetreuungsunterhaltsRechner() {
  const [geburtsdatum, setGeburtsdatum] = useState("");
  const [erwartetAm, setErwartetAm] = useState("");
  const [situation, setSituation] = useState(""); // "vor_geburt" | "nach_geburt"
  const [einkommenMutter, setEinkommenMutter] = useState("");
  const [einkommenVater, setEinkommenVater] = useState("");
  const [erwerbshindernis, setErwerbshindernis] = useState("");
  const [betreuungDurch, setBetreuungDurch] = useState("mutter");
  const [abzuegeMutter, setAbzuegeMutter] = useState("");
  const [abzuegeVater, setAbzuegeVater] = useState("");
  const [schwangerschaftskosten, setSchwangerschaftskosten] = useState("");
  const [kannNichtArbeiten, setKannNichtArbeiten] = useState("");
  const [weitereKinder, setWeitereKinder] = useState("nein");
  const [anzahlWeitereKinder, setAnzahlWeitereKinder] = useState("0");
  const [result, setResult] = useState(null);

  // Hilfsfunktionen
  var heute = new Date();

  var dateDiff = function(von, bis) {
    // Differenz in Tagen
    return Math.round((bis - von) / (1000 * 60 * 60 * 24));
  };

  var getSituation = function() {
    // Ermittelt automatisch die Situation aus den eingegebenen Daten
    if (geburtsdatum) {
      var geb = new Date(geburtsdatum);
      var tageNachGeburt = dateDiff(geb, heute);
      var monateNachGeburt = (heute.getFullYear() - geb.getFullYear()) * 12 + (heute.getMonth() - geb.getMonth());
      if (tageNachGeburt < 0) return "vor_geburt"; // Geburtsdatum in der Zukunft
      return "nach_geburt";
    }
    if (erwartetAm) return "vor_geburt";
    return situation;
  };

  var getPhaseInfo = function() {
    var sit = getSituation();
    if (sit === "vor_geburt") {
      var termin = geburtsdatum ? new Date(geburtsdatum) : (erwartetAm ? new Date(erwartetAm) : null);
      if (!termin) return { phase: "vor_geburt", tageVorGeburt: null };
      var tageVorGeburt = dateDiff(heute, termin);
      return { phase: "vor_geburt", tageVorGeburt: Math.max(0, tageVorGeburt), termin: termin };
    }
    if (sit === "nach_geburt") {
      var geb = new Date(geburtsdatum);
      var tageNach = dateDiff(geb, heute);
      var monateNach = (heute.getFullYear() - geb.getFullYear()) * 12 + (heute.getMonth() - geb.getMonth());
      var inMutterschaftsschutz = tageNach <= 56; // 8 Wochen = 56 Tage
      var verbleibendeAnspruchsmonate = Math.max(0, 36 - monateNach);
      return {
        phase: inMutterschaftsschutz ? "mutterschaftsschutz" : "betreuungsunterhalt",
        tageNachGeburt: tageNach,
        monateNach: monateNach,
        inMutterschaftsschutz: inMutterschaftsschutz,
        verbleibendeAnspruchsmonate: verbleibendeAnspruchsmonate,
        anspruchAbgelaufen: monateNach >= 36,
      };
    }
    return { phase: "unbekannt" };
  };

  var berechne = function() {
    var berM = Math.max(0, parseFloat(einkommenMutter || 0) - parseFloat(abzuegeMutter || 0));
    var berV = Math.max(0, parseFloat(einkommenVater || 0) - parseFloat(abzuegeVater || 0));
    var sbVater = 1600;
    var kuAbzug = parseInt(anzahlWeitereKinder || 0) * 480;
    var verfuegbar = Math.max(0, berV - sbVater - kuAbzug);
    var info = getPhaseInfo();

    // ‚îÄ‚îÄ Phase 1: Vor der Geburt (¬ß 1615l Abs. 1 BGB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 6 Wochen vor Geburt: Lebensunterhalt wenn Mutter nicht arbeiten kann
    // + Entbindungskosten (pauschal oder konkret)
    var entbindungskosten = parseFloat(schwangerschaftskosten || 0);
    var lebenshaltungVorGeburt = 0;
    var berechnungVorGeburt = "";
    if (info.phase === "vor_geburt" || info.phase === "mutterschaftsschutz") {
      if (kannNichtArbeiten === "ja") {
        // Lebensunterhalt: wie Betreuungsunterhalt berechnet
        if (berM < 100) {
          lebenshaltungVorGeburt = Math.round(berV * 3 / 7);
          berechnungVorGeburt = "3/7 des Vatereinkommens (Mutter ohne Einkommen)";
        } else {
          lebenshaltungVorGeburt = Math.max(960, Math.round((berV - berM) * 3 / 7));
          berechnungVorGeburt = "3/7 der Einkommensdifferenz (mind. 960 ‚Ç¨)";
        }
      }
    }
    var zahlbarVorGeburt = Math.min(lebenshaltungVorGeburt, verfuegbar);
    var zahlbareEntbindungskosten = Math.min(entbindungskosten, Math.max(0, verfuegbar - zahlbarVorGeburt));

    // ‚îÄ‚îÄ Phase 2+3: Nach der Geburt (¬ß 1615l Abs. 2 BGB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 3/7 der Einkommensdifferenz, mind. 960 ‚Ç¨
    var bedarf = 0;
    var berechnungsgrundlage = "";
    if (betreuungDurch === "mutter") {
      if (berM < 100) {
        bedarf = Math.round(berV * 3 / 7);
        berechnungsgrundlage = "3/7 des Vatereinkommens (Mutter ohne Einkommen)";
      } else {
        bedarf = Math.max(0, Math.round((berV - berM) * 3 / 7));
        berechnungsgrundlage = "3/7 der Einkommensdifferenz";
      }
    } else {
      if (berV < 100) {
        bedarf = Math.round(berM * 3 / 7);
        berechnungsgrundlage = "3/7 des Muttereinkommens (Vater ohne Einkommen)";
      } else {
        bedarf = Math.max(0, Math.round((berM - berV) * 3 / 7));
        berechnungsgrundlage = "3/7 der Einkommensdifferenz";
      }
    }
    bedarf = Math.max(bedarf, 960); // Mindestbedarf
    var zahlbar = Math.min(bedarf, verfuegbar);
    var mangelfall = zahlbar < bedarf;

    // Verl√§ngerungsgr√ºnde
    var verlaengerungen = [];
    if (erwerbshindernis === "kita_fehlt") verlaengerungen.push("Kein Kita-Platz verf√ºgbar (¬ß 1615l Abs. 2 S. 5)");
    if (erwerbshindernis === "krankheit") verlaengerungen.push("Krankheit / Behinderung des Kindes");
    if (erwerbshindernis === "pflege") verlaengerungen.push("Weiteres Kind unter 3 Jahren in Betreuung");
    if (erwerbshindernis === "kindeswohl") verlaengerungen.push("Sonstige Kindeswohlgr√ºnde (Einzelfallpr√ºfung)");

    setResult({
      berM: berM.toFixed(2), berV: berV.toFixed(2),
      sbVater, kuAbzug,
      verfuegbar: verfuegbar.toFixed(2),
      // Vor Geburt
      lebenshaltungVorGeburt: lebenshaltungVorGeburt.toFixed(2),
      zahlbarVorGeburt: zahlbarVorGeburt.toFixed(2),
      entbindungskosten: entbindungskosten.toFixed(2),
      zahlbareEntbindungskosten: zahlbareEntbindungskosten.toFixed(2),
      berechnungVorGeburt,
      // Nach Geburt
      bedarf: bedarf.toFixed(2),
      zahlbar: zahlbar.toFixed(2),
      mangelfall,
      berechnungsgrundlage,
      // Allgemein
      info,
      verlaengerungen,
    });
  };

  var u = rStyles;
  var info = getPhaseInfo();

  // Phasen-Badge Farben
  var phaseFarbe = info.phase === "vor_geburt" ? "#7b1fa2" : info.phase === "mutterschaftsschutz" ? "#1565c0" : "#2e7d32";
  var phaseLabel = info.phase === "vor_geburt" ? "üìÖ Vor der Geburt" : info.phase === "mutterschaftsschutz" ? "üè• Entbindungsphase (bis 8 Wo. nach Geburt)" : info.phase === "betreuungsunterhalt" ? "üë∂ Betreuungsunterhalt (nach 8 Wo.)" : "";

  return (
    <div>
      <h4 style={u.modTitle}>üë∂ Betreuungsunterhalt (¬ß 1615l BGB)</h4>
      <div style={u.infoBox}>‚ÑπÔ∏è Gilt unabh√§ngig vom Familienstand. Umfasst: Unterhalt ab 6 Wochen vor Geburt (Entbindungsschaden) sowie Betreuungsunterhalt f√ºr mind. 3 Jahre nach der Geburt.</div>

      {/* Block 1: Zeitpunkt / Datum */}
      <div style={{ backgroundColor:"#f0f4ff", borderRadius:"8px", padding:"12px", marginBottom:"10px", borderLeft:"3px solid #7b1fa2" }}>
        <div style={{ fontWeight:"bold", fontSize:"12px", color:"#7b1fa2", marginBottom:"8px", textTransform:"uppercase", letterSpacing:"0.5px" }}>üìÖ Zeitpunkt bestimmen</div>
        <div style={{ display:"flex", flexDirection:"column", gap:"10px" }}>
          <div>
            <label style={u.sectionLabel}>Geburtsdatum (tats√§chlich oder erwartet):</label>
            <input type="date" style={u.input} value={geburtsdatum}
              onChange={function(e) { setGeburtsdatum(e.target.value); setErwartetAm(""); setResult(null); }} />
          </div>
          {!geburtsdatum && (
            <div>
              <label style={u.sectionLabel}>Oder: Errechneter Geburtstermin (ET):</label>
              <input type="date" style={u.input} value={erwartetAm}
                onChange={function(e) { setErwartetAm(e.target.value); setResult(null); }} />
            </div>
          )}
        </div>

        {/* Automatische Phasen-Erkennung */}
        {(geburtsdatum || erwartetAm) && info.phase !== "unbekannt" && (
          <div style={{ marginTop:"10px", backgroundColor: phaseFarbe, color:"#fff", borderRadius:"7px", padding:"10px 12px" }}>
            <div style={{ fontWeight:"bold", fontSize:"12px", marginBottom:"4px" }}>{phaseLabel}</div>
            {info.phase === "vor_geburt" && info.tageVorGeburt !== null && (
              <div style={{ fontSize:"11px" }}>Noch <strong>{info.tageVorGeburt} Tage</strong> bis zur Geburt ¬∑ Anspruch beginnt 42 Tage (6 Wochen) vor Geburtstermin</div>
            )}
            {info.phase === "mutterschaftsschutz" && (
              <div style={{ fontSize:"11px" }}>Tag <strong>{info.tageNachGeburt}</strong> nach Geburt ¬∑ Mutterschaftsschutzphase (bis Tag 56 = 8 Wochen)</div>
            )}
            {info.phase === "betreuungsunterhalt" && !info.anspruchAbgelaufen && (
              <div style={{ fontSize:"11px" }}>Kind ist <strong>{info.monateNach} Monate</strong> alt ¬∑ Grundanspruch noch <strong>{info.verbleibendeAnspruchsmonate} Monate</strong></div>
            )}
            {info.anspruchAbgelaufen && (
              <div style={{ fontSize:"11px" }}>‚ö†Ô∏è Kind ist bereits √ºber 3 Jahre alt ‚Äì Grundanspruch abgelaufen. Verl√§ngerung nur aus besonderen Gr√ºnden.</div>
            )}
          </div>
        )}
      </div>

      {/* Block 2: Situation vor der Geburt ‚Äì nur anzeigen wenn relevant */}
      {(info.phase === "vor_geburt" || info.phase === "mutterschaftsschutz") && (
        <div style={{ backgroundColor:"#f9f0ff", borderRadius:"8px", padding:"12px", marginBottom:"10px", borderLeft:"3px solid #7b1fa2" }}>
          <div style={{ fontWeight:"bold", fontSize:"12px", color:"#7b1fa2", marginBottom:"8px", textTransform:"uppercase", letterSpacing:"0.5px" }}>üè• Entbindungsschaden (¬ß 1615l Abs. 1)</div>
          <div style={{ fontSize:"11px", color:"#555", marginBottom:"8px" }}>6 Wochen vor bis 8 Wochen nach der Geburt: Lebensunterhalt bei Erwerbsausfall + konkrete Entbindungskosten.</div>
          <label style={u.sectionLabel}>Kann die Mutter wegen der Schwangerschaft nicht arbeiten?</label>
          <div style={{ display:"flex", gap:"8px", marginBottom:"10px" }}>
            {[{v:"ja", l:"Ja ‚Äì Erwerbsausfall"}, {v:"nein", l:"Nein / Teilzeit m√∂glich"}].map(function(opt) {
              return (
                <div key={opt.v} onClick={function() { setKannNichtArbeiten(opt.v); setResult(null); }}
                  style={{ padding:"6px 12px", borderRadius:"8px", cursor:"pointer", fontSize:"12px",
                    backgroundColor: kannNichtArbeiten === opt.v ? "#7b1fa2" : "#eee",
                    color: kannNichtArbeiten === opt.v ? "#fff" : "#333" }}>
                  {opt.l}
                </div>
              );
            })}
          </div>
          <label style={u.sectionLabel}>Schwangerschafts- / Entbindungskosten (‚Ç¨, Einmalbetrag):</label>
          <input type="number" style={u.input} placeholder="z.B. Hebamme, Entbindungsheim, Ausstattung" value={schwangerschaftskosten}
            onChange={function(e) { setSchwangerschaftskosten(e.target.value); setResult(null); }} />
          <div style={{ fontSize:"10px", color:"#888", marginTop:"2px" }}>Nur Kosten, die der gesetzlichen Krankenversicherung nicht ersetzt werden.</div>
        </div>
      )}

      {/* Block 3: Einkommen */}
      <div style={{ backgroundColor:"#f0f4ff", borderRadius:"8px", padding:"12px", marginBottom:"10px", borderLeft:"3px solid #003366" }}>
        <div style={{ fontWeight:"bold", fontSize:"12px", color:"#003366", marginBottom:"8px", textTransform:"uppercase", letterSpacing:"0.5px" }}>üí∂ Einkommen</div>
        <label style={u.sectionLabel}>Wer betreut das Kind?</label>
        <div style={{ display:"flex", gap:"8px", marginBottom:"10px" }}>
          {[{v:"mutter", l:"Mutter betreut"}, {v:"vater", l:"Vater betreut"}].map(function(opt) {
            return (
              <div key={opt.v} onClick={function() { setBetreuungDurch(opt.v); setResult(null); }}
                style={{ padding:"6px 14px", borderRadius:"8px", cursor:"pointer", fontSize:"12px", fontWeight:"bold",
                  backgroundColor: betreuungDurch === opt.v ? "#003366" : "#eee",
                  color: betreuungDurch === opt.v ? "#fff" : "#333" }}>
                {opt.l}
              </div>
            );
          })}
        </div>
        <label style={u.sectionLabel}>Nettoeinkommen Mutter (‚Ç¨/Monat):</label>
        <div style={u.row}>
          <input type="number" style={u.input} placeholder="Netto Mutter" value={einkommenMutter} onChange={function(e) { setEinkommenMutter(e.target.value); setResult(null); }} />
          <input type="number" style={u.input} placeholder="Abz√ºge (Vorsorge, Kredit)" value={abzuegeMutter} onChange={function(e) { setAbzuegeMutter(e.target.value); setResult(null); }} />
        </div>
        <label style={u.sectionLabel}>Nettoeinkommen Vater (‚Ç¨/Monat):</label>
        <div style={u.row}>
          <input type="number" style={u.input} placeholder="Netto Vater" value={einkommenVater} onChange={function(e) { setEinkommenVater(e.target.value); setResult(null); }} />
          <input type="number" style={u.input} placeholder="Abz√ºge (Vorsorge, Kredit)" value={abzuegeVater} onChange={function(e) { setAbzuegeVater(e.target.value); setResult(null); }} />
        </div>
        <label style={u.sectionLabel}>Weitere unterhaltspflichtige Kinder des Pflichtigen:</label>
        <div style={{ display:"flex", gap:"8px", marginBottom:"6px" }}>
          {[{v:"nein",l:"Keine"},{v:"ja",l:"Ja"}].map(function(opt) {
            return (
              <div key={opt.v} onClick={function() { setWeitereKinder(opt.v); setResult(null); }}
                style={{ padding:"5px 12px", borderRadius:"8px", cursor:"pointer", fontSize:"12px",
                  backgroundColor: weitereKinder === opt.v ? "#003366" : "#eee",
                  color: weitereKinder === opt.v ? "#fff" : "#333" }}>
                {opt.l}
              </div>
            );
          })}
        </div>
        {weitereKinder === "ja" && (
          <div style={{ display:"flex", alignItems:"center", gap:"8px" }}>
            <span style={{ fontSize:"12px" }}>Anzahl:</span>
            <select style={{ ...u.input, width:"80px" }} value={anzahlWeitereKinder} onChange={function(e) { setAnzahlWeitereKinder(e.target.value); setResult(null); }}>
              {["1","2","3","4","5"].map(function(n) { return <option key={n} value={n}>{n}</option>; })}
            </select>
          </div>
        )}
      </div>

      {/* Block 4: Verl√§ngerungsgr√ºnde ‚Äì nur nach Geburt relevant */}
      {(info.phase === "betreuungsunterhalt" || !info.phase || info.phase === "unbekannt") && (
        <div style={{ backgroundColor:"#f0f4ff", borderRadius:"8px", padding:"12px", marginBottom:"10px", borderLeft:"3px solid #00afad" }}>
          <div style={{ fontWeight:"bold", fontSize:"12px", color:"#003366", marginBottom:"8px", textTransform:"uppercase", letterSpacing:"0.5px" }}>‚è≥ Verl√§ngerung √ºber 3 Jahre?</div>
          <div style={{ fontSize:"11px", color:"#555", marginBottom:"8px" }}>Liegt ein Grund vor, der den Anspruch √ºber das 3. Lebensjahr des Kindes hinaus verl√§ngert?</div>
          <div style={{ display:"flex", flexDirection:"column", gap:"6px" }}>
            {[
              {v:"kita_fehlt", l:"Kein Kita-Platz verf√ºgbar"},
              {v:"krankheit", l:"Krankheit / Behinderung des Kindes"},
              {v:"pflege", l:"Weiteres Kind unter 3 Jahren in Betreuung"},
              {v:"kindeswohl", l:"Sonstige Kindeswohlgr√ºnde"},
              {v:"keine", l:"Kein Verl√§ngerungsgrund"},
            ].map(function(opt) {
              return (
                <div key={opt.v} onClick={function() { setErwerbshindernis(opt.v); setResult(null); }}
                  style={{ padding:"8px 12px", borderRadius:"7px", cursor:"pointer", fontSize:"12px",
                    backgroundColor: erwerbshindernis === opt.v ? "#00afad" : "#f9f9f9",
                    color: erwerbshindernis === opt.v ? "#fff" : "#333",
                    border: "1px solid " + (erwerbshindernis === opt.v ? "#00afad" : "#e0e0e0") }}>
                  {erwerbshindernis === opt.v ? "‚úì " : ""}{opt.l}
                </div>
              );
            })}
          </div>
        </div>
      )}

      <button style={u.btnPrimary} onClick={berechne}>Berechnen</button>

      {result && (
        <div style={u.resultBox}>
          {result.mangelfall && <div style={u.warnung}>‚ö†Ô∏è <strong>Mangelfall:</strong> Verf√ºgbare Masse reicht nicht f√ºr vollen Bedarf.</div>}

          {/* Einkommens√ºbersicht */}
          <div style={u.calcStep}><span>Bereinigtes Einkommen Mutter:</span><span>{result.berM} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>Bereinigtes Einkommen Vater:</span><span>{result.berV} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>‚Äì Selbstbehalt Pflichtiger:</span><span>{result.sbVater} ‚Ç¨</span></div>
          {result.kuAbzug > 0 && <div style={u.calcStep}><span>‚Äì Weitere Kinder (Abzug):</span><span>{result.kuAbzug} ‚Ç¨</span></div>}
          <div style={{ ...u.calcStep, borderTop:"1px solid #00afad", fontWeight:"bold", marginTop:"5px", paddingTop:"5px" }}>
            <span>Verf√ºgbare Masse:</span><span>{result.verfuegbar} ‚Ç¨</span>
          </div>

          {/* Entbindungsschaden (Phase 1) */}
          {(result.info.phase === "vor_geburt" || result.info.phase === "mutterschaftsschutz") && (
            <div style={{ backgroundColor:"#f9f0ff", borderRadius:"8px", padding:"10px", marginTop:"12px" }}>
              <div style={{ fontWeight:"bold", fontSize:"12px", color:"#7b1fa2", marginBottom:"6px" }}>üè• ¬ß 1615l Abs. 1 ‚Äì Entbindungsschaden</div>
              {parseFloat(result.lebenshaltungVorGeburt) > 0 && (
                <div>
                  <div style={{ fontSize:"11px", color:"#555", marginBottom:"4px" }}>Lebensunterhalt bei Erwerbsausfall ({result.berechnungVorGeburt}):</div>
                  <div style={{ ...u.resRow, fontWeight:"bold" }}><span>Lebensunterhalt / Monat:</span><span>{result.zahlbarVorGeburt} ‚Ç¨</span></div>
                </div>
              )}
              {parseFloat(result.entbindungskosten) > 0 && (
                <div style={{ marginTop:"6px" }}>
                  <div style={{ ...u.resRow }}><span>Entbindungskosten (einmalig):</span><span>{result.zahlbareEntbindungskosten} ‚Ç¨</span></div>
                </div>
              )}
              {parseFloat(result.lebenshaltungVorGeburt) === 0 && parseFloat(result.entbindungskosten) === 0 && (
                <div style={{ fontSize:"11px", color:"#888" }}>Keine Angaben zu Erwerbsausfall oder Kosten gemacht.</div>
              )}
            </div>
          )}

          {/* Betreuungsunterhalt (Phase 2/3) */}
          <div style={u.compositionBox}>
            <div style={{ fontWeight:"bold", fontSize:"12px", color:"#003366", marginBottom:"6px" }}>üë∂ ¬ß 1615l Abs. 2 ‚Äì Betreuungsunterhalt</div>
            <div style={{ fontSize:"11px", color:"#666", marginBottom:"6px" }}>Grundlage: {result.berechnungsgrundlage}</div>
            <div style={u.resRow}><span>Errechneter Bedarf:</span><span>{result.bedarf} ‚Ç¨</span></div>
            <div style={{ ...u.resRow, fontWeight:"bold", fontSize:"16px", borderTop:"2px solid #003366", paddingTop:"5px", marginTop:"8px" }}>
              <span>Betreuungsunterhalt:</span><span>{result.zahlbar} ‚Ç¨ / Monat</span>
            </div>
          </div>

          {/* Anspruchsdauer */}
          <div style={{ backgroundColor:"#e8f0fb", borderRadius:"6px", padding:"10px", marginTop:"10px" }}>
            <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"4px" }}>üìÖ Anspruchsdauer</div>
            {result.info.anspruchAbgelaufen
              ? <div style={{ fontSize:"11px", color:"#e53935" }}>Grundanspruch (3 Jahre) abgelaufen.</div>
              : result.info.verbleibendeAnspruchsmonate !== undefined
                ? <div style={{ fontSize:"11px" }}>Grundanspruch noch ca. <strong>{result.info.verbleibendeAnspruchsmonate} Monate</strong> (bis Kind 3 Jahre)</div>
                : <div style={{ fontSize:"11px" }}>Grundanspruch: 3 Jahre ab Geburt (¬ß 1615l Abs. 2 S. 1)</div>
            }
            {result.verlaengerungen.length > 0 && (
              <div style={{ marginTop:"6px" }}>
                <div style={{ fontSize:"11px", fontWeight:"bold", color:"#00afad" }}>Verl√§ngerungsgr√ºnde vorhanden:</div>
                {result.verlaengerungen.map(function(v, i) { return <div key={i} style={{ fontSize:"11px", marginTop:"2px" }}>‚úì {v}</div>; })}
              </div>
            )}
          </div>

          <div style={{ fontSize:"10px", color:"#999", marginTop:"8px" }}>
            ‚ö†Ô∏è Orientierungsberechnung nach ¬ß 1615l BGB. Gilt unabh√§ngig vom Familienstand. F√ºr rechtssichere Auskunft Rechtsberatung in Anspruch nehmen.
          </div>
        </div>
      )}
    </div>
  );
}

// =============================================
// RECHNER-REITER NAVIGATION
// =============================================
function RechnerReiter() {
  const [kategorie, setKategorie] = useState(null);
  const [unterkategorie, setUnterkategorie] = useState(null);
  const [aktiverRechner, setAktivenRechner] = useState(null);

  const familienRechner = [
    { id: "kindes", label: "‚öñÔ∏è Kindesunterhalt" },
    { id: "betreuungsunterhalt", label: "üë∂ Betreuungsunterhalt (¬ß 1615l)" },
    { id: "trennung", label: "üë´ Trennungsunterhalt" },
    { id: "nachehelich", label: "üíç Nachehelicher Unterhalt" },
  ];
  const sozialUnterkategorien = [
    { id: "betreuung", label: "üë®‚Äçüëß Betreuungs- / Umgangskosten", desc: "Mehrbedarf Alleinerziehende, Umgangskosten, TBG" },
    { id: "wohngeld", label: "üè° Wohngeld", desc: "Wohngeldberechnung nach WoGG" },
  ];
  const betreuungsRechner = [
    { id: "mbAlleinerziehende", label: "üë®‚Äçüëß Mehrbedarf Alleinerziehende" },
    { id: "mbUmgang", label: "üöó Mehrbedarf Umgangskosten" },
    { id: "tbg", label: "üè† Tempor√§re Bedarfsgemeinschaft" },
  ];

  const backBtn = (label, onClick) => (
    <button onClick={onClick} style={{ background: "none", border: "none", color: "#00afad", cursor: "pointer", fontWeight: "bold", marginBottom: "12px", padding: 0 }}>‚Äπ {label}</button>
  );

  if (aktiverRechner) {
    const zurueck = unterkategorie === "betreuung" ? "Betreuungs-/Umgangskosten" : "Familienrecht";
    return (
      <div>
        {backBtn(zurueck, () => setAktivenRechner(null))}
        {aktiverRechner === "kindes" && <KindesunterhaltsRechner />}
        {aktiverRechner === "betreuungsunterhalt" && <BetreuungsunterhaltsRechner />}
        {aktiverRechner === "trennung" && <TrennungsunterhaltsRechner />}
        {aktiverRechner === "nachehelich" && <NachehelicherUnterhaltsRechner />}
        {aktiverRechner === "mbAlleinerziehende" && <MehrbedarfAlleinerziehende />}
        {aktiverRechner === "mbUmgang" && <MehrbedarfUmgangskosten />}
        {aktiverRechner === "tbg" && <TemporaereBedarfsgemeinschaft />}
        {aktiverRechner === "wohngeld" && <WohngeldRechner />}
      </div>
    );
  }

  if (unterkategorie === "betreuung") return (
    <div>
      {backBtn("Sozialrecht", () => setUnterkategorie(null))}
      <div style={{ fontSize: "11px", fontWeight: "bold", color: "#003366", marginBottom: "8px", textTransform: "uppercase" }}>üë®‚Äçüëß Betreuungs- / Umgangskosten</div>
      <div style={{ display: "flex", flexDirection: "column", gap: "8px" }}>
        {betreuungsRechner.map(r => (
          <div key={r.id} onClick={() => setAktivenRechner(r.id)} style={{ padding: "12px", backgroundColor: "#f9f9f9", borderRadius: "8px", cursor: "pointer", borderLeft: "4px solid #00afad", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <strong style={{ fontSize: "13px" }}>{r.label}</strong><span style={{ color: "#00afad" }}>‚Ä∫</span>
          </div>
        ))}
      </div>
    </div>
  );

  if (kategorie === "sozialrecht") return (
    <div>
      {backBtn("Kategorien", () => { setKategorie(null); setUnterkategorie(null); })}
      <div style={{ fontSize: "11px", fontWeight: "bold", color: "#003366", marginBottom: "8px", textTransform: "uppercase" }}>üèõÔ∏è Sozialrecht ‚Äì Bereich w√§hlen:</div>
      <div style={{ display: "flex", flexDirection: "column", gap: "8px" }}>
        {sozialUnterkategorien.map(u => (
          <div key={u.id} onClick={() => { if (u.id === "wohngeld") setAktivenRechner("wohngeld"); else setUnterkategorie(u.id); }} style={{ padding: "12px", backgroundColor: "#f9f9f9", borderRadius: "8px", cursor: "pointer", borderLeft: "4px solid #00afad", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div><strong style={{ fontSize: "13px" }}>{u.label}</strong><div style={{ fontSize: "10px", color: "#999", marginTop: "2px" }}>{u.desc}</div></div>
            <span style={{ color: "#00afad", marginLeft: "8px" }}>‚Ä∫</span>
          </div>
        ))}
      </div>
    </div>
  );

  if (kategorie === "familienrecht") return (
    <div>
      {backBtn("Kategorien", () => setKategorie(null))}
      <div style={{ fontSize: "11px", fontWeight: "bold", color: "#003366", marginBottom: "8px", textTransform: "uppercase" }}>‚öñÔ∏è Familienrecht ‚Äì Rechner w√§hlen:</div>
      <div style={{ display: "flex", flexDirection: "column", gap: "8px" }}>
        {familienRechner.map(r => (
          <div key={r.id} onClick={() => setAktivenRechner(r.id)} style={{ padding: "12px", backgroundColor: "#f9f9f9", borderRadius: "8px", cursor: "pointer", borderLeft: "4px solid #00afad", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <strong style={{ fontSize: "13px" }}>{r.label}</strong><span style={{ color: "#00afad" }}>‚Ä∫</span>
          </div>
        ))}
      </div>
    </div>
  );

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: "8px" }}>
      <div onClick={() => setKategorie("familienrecht")} style={{ padding: "14px", backgroundColor: "#f9f9f9", borderRadius: "10px", cursor: "pointer", borderLeft: "4px solid #003366", display: "flex", alignItems: "center", gap: "12px" }}>
        <span style={{ fontSize: "18px" }}>‚öñÔ∏è</span>
        <div><div style={{ fontWeight: "bold", fontSize: "13px" }}>Familienrecht</div><div style={{ fontSize: "10px", color: "#aaa" }}>Kindes-, Trennungs- und nachehelicher Unterhalt</div></div>
        <span style={{ marginLeft: "auto", color: "#00afad" }}>‚Ä∫</span>
      </div>
      <div onClick={() => setKategorie("sozialrecht")} style={{ padding: "14px", backgroundColor: "#f9f9f9", borderRadius: "10px", cursor: "pointer", borderLeft: "4px solid #00afad", display: "flex", alignItems: "center", gap: "12px" }}>
        <span style={{ fontSize: "18px" }}>üèõÔ∏è</span>
        <div><div style={{ fontWeight: "bold", fontSize: "13px" }}>Sozialrecht</div><div style={{ fontSize: "10px", color: "#aaa" }}>Mehrbedarf, TBG, Wohngeld</div></div>
        <span style={{ marginLeft: "auto", color: "#00afad" }}>‚Ä∫</span>
      </div>
    </div>
  );
}



// =============================================
// BERECHNUNG MIT DATEN ‚Äì Rechner vorausgef√ºllt
// =============================================
function BerechnungMitDaten({ rechner, member, ext, onSaveData, onSaveErgebnis }) {
  const netto   = ext ? String(ext.einkommenNetto || "") : "";
  const nettoG  = ext ? String(ext.einkommenGegenseite || "") : "";
  const mieteW  = ext ? String(ext.mieteWarm || "") : "";
  const mStufe  = ext ? String(ext.mietStufe || "3") : "3";
  const haushalt= ext ? String(1 + (ext.kinder ? ext.kinder.length : 0)) : "1";
  const uBetrag = ext ? String(ext.unterhaltBetrag || "") : "";
  const uTitel  = ext ? (ext.unterhaltsTitel ? "ja" : "nein") : "nein";
  const u = rStyles;

  // Hilfsfunktion: neue Daten speichern und Ergebnis zur√ºckschreiben
  const speichern = (neueFelder, ergebnis) => {
    if (onSaveData && neueFelder && Object.keys(neueFelder).length > 0) onSaveData(neueFelder);
    if (onSaveErgebnis && ergebnis) onSaveErgebnis(ergebnis);
  };

  // ‚îÄ‚îÄ Kindesunterhalt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [kuEinSelbst, setKuEinSelbst] = useState(netto);
  const [kuEinAnderer, setKuEinAnderer] = useState(nettoG);
  const initKinder = ext && ext.kinder ? ext.kinder.map((k, i) => {
    const a = k.alter.startsWith("0") ? "0" : k.alter.startsWith("6") ? "6" : k.alter.startsWith("12") ? "12" : "18";
    return { id: i+1, alter: a, eigeneEinnahmen: "" };
  }) : [{ id:1, alter:"6", eigeneEinnahmen:"" }];
  const [kuKinder] = useState(initKinder);
  const [kuResult, setKuResult] = useState(null);

  const berechneKU = () => {
    const n1 = parseFloat(kuEinSelbst||0);
    const berN1 = Math.max(0, n1 - Math.min(150, n1*0.05));
    const n2 = parseFloat(kuEinAnderer||0);
    const berN2 = Math.max(0, n2 - Math.min(150, n2*0.05));
    let stufe = berN1 > 2500 ? 3 : berN1 > 2100 ? 2 : 1;
    const sb = 1450;
    const masse = Math.max(0, berN1 - sb);
    const tab = {1:{"0":480,"6":551,"12":645,"18":706},2:{"0":504,"6":579,"12":678,"18":742},3:{"0":528,"6":607,"12":710,"18":777}};
    const ue1 = Math.max(0, berN1-sb); const ue2 = Math.max(0, berN2-sb);
    let soll = 0;
    const details = kuKinder.map(k => { const bar = Math.max(0,(tab[stufe][k.alter]||551)-(k.alter==="18"?250:125)); soll+=bar; return {...k,bar}; });
    const faktor = masse < soll && soll > 0 ? masse/soll : 1;
    const gesamt = (soll*faktor).toFixed(2);
    const res = { berN1:berN1.toFixed(2), sb, masse:masse.toFixed(2), gesamt, mangelfall:faktor<1, details:details.map(d=>({...d,z:(d.bar*faktor).toFixed(2)})) };
    setKuResult(res);
    const neueFelder = {};
    if (!ext || !ext.einkommenNetto) neueFelder.einkommenNetto = parseFloat(kuEinSelbst||0);
    if (kuEinAnderer && (!ext || !ext.einkommenGegenseite)) neueFelder.einkommenGegenseite = parseFloat(kuEinAnderer||0);
    speichern(neueFelder, { typ:"‚öñÔ∏è Kindesunterhalt", ergebnis: gesamt+" ‚Ç¨ / Monat", details: kuKinder.length+" Kind(er), Selbstbehalt "+sb+" ‚Ç¨" });
  };

  // ‚îÄ‚îÄ Trennungsunterhalt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [tuEinA, setTuEinA] = useState(netto);
  const [tuEinV, setTuEinV] = useState(nettoG);
  const [tuResult, setTuResult] = useState(null);

  const berechneTU = () => {
    const berA = Math.max(0, parseFloat(tuEinA||0)*(1-1/7));
    const berV = Math.max(0, parseFloat(tuEinV||0)*(1-1/7));
    const masse = Math.max(0, berV-1200);
    const diff = berV-berA;
    const anspruch = Math.max(0, Math.min(diff/2, masse));
    setTuResult({ bereA:berA.toFixed(2), bereV:berV.toFixed(2), masse:masse.toFixed(2), anspruch:anspruch.toFixed(2), kein:diff<=0||masse<=0 });
    const neueFelder = {};
    if (!ext || !ext.einkommenNetto) neueFelder.einkommenNetto = parseFloat(tuEinA||0);
    if (tuEinV && (!ext || !ext.einkommenGegenseite)) neueFelder.einkommenGegenseite = parseFloat(tuEinV||0);
    speichern(neueFelder, { typ:"üë´ Trennungsunterhalt", ergebnis: diff<=0||masse<=0 ? "Kein Anspruch" : anspruch.toFixed(2)+" ‚Ç¨ / Monat", details: "¬ß 1361 BGB, Selbstbehalt 1.200 ‚Ç¨" });
  };

  // ‚îÄ‚îÄ Nachehelicher Unterhalt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [nuEinA, setNuEinA] = useState(netto);
  const [nuEinV, setNuEinV] = useState(nettoG);
  const [nuResult, setNuResult] = useState(null);

  const berechneNU = () => {
    const berA = Math.max(0, parseFloat(nuEinA||0));
    const berV = Math.max(0, parseFloat(nuEinV||0)*(1-1/7));
    const masse = Math.max(0, berV-1300);
    const diff = berV-berA;
    const anspruch = Math.max(0, Math.min(diff/2, masse));
    setNuResult({ bereV:berV.toFixed(2), masse:masse.toFixed(2), anspruch:anspruch.toFixed(2), kein:diff<=0||masse<=0 });
    const neueFelder = {};
    if (!ext || !ext.einkommenNetto) neueFelder.einkommenNetto = parseFloat(nuEinA||0);
    if (nuEinV && (!ext || !ext.einkommenGegenseite)) neueFelder.einkommenGegenseite = parseFloat(nuEinV||0);
    speichern(neueFelder, { typ:"üíç Nachehelicher Unterhalt", ergebnis: diff<=0||masse<=0 ? "Kein Anspruch" : anspruch.toFixed(2)+" ‚Ç¨ / Monat", details: "¬ß¬ß 1569 ff. BGB, Selbstbehalt 1.300 ‚Ç¨" });
  };

  // ‚îÄ‚îÄ Mehrbedarf Alleinerziehende ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const anzK = ext && ext.kinder ? ext.kinder.length : 1;
  const autoKonf = anzK >= 4 ? "4k" : anzK >= 2 ? "23u16" : "1u7";
  const [mbModell, setMbModell] = useState(ext && ext.betreuungsmodell ? (ext.betreuungsmodell.toLowerCase().includes("parit") ? "paritaetisch" : "asymmetrisch") : "");
  const [mbKonf] = useState(autoKonf);
  const [mbResult, setMbResult] = useState(null);

  const berechneMB = () => {
    const rb = 563;
    const konfMap = {"1u7":36,"1ue7":12,"23u16":36,"2ue16":24,"4k":48,"5k":60};
    let proz = konfMap[mbKonf] || 36;
    let hinweis = "";
    if (mbModell === "paritaetisch") { proz = proz/2; hinweis = "Parit√§tisches Modell: h√§lftig."; }
    else { hinweis = "Residenz-/Asymm. Modell: voller Betrag."; }
    const betrag = (rb*proz/100).toFixed(2);
    setMbResult({ proz:proz.toFixed(1), betrag, hinweis });
    const neueFelder = {};
    if (!ext || !ext.betreuungsmodell) neueFelder.betreuungsmodell = mbModell === "paritaetisch" ? "Parit√§tisches Wechselmodell" : "Residenzmodell";
    speichern(neueFelder, { typ:"üë®‚Äçüëß Mehrbedarf Alleinerziehende", ergebnis: betrag+" ‚Ç¨ / Monat", details: hinweis });
  };

  // ‚îÄ‚îÄ Umgangskosten ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [ukFahrt, setUkFahrt] = useState("");
  const [ukUeber, setUkUeber] = useState("");
  const [ukSonst, setUkSonst] = useState("");
  const [ukResult, setUkResult] = useState(null);

  const berechneUK = () => {
    const gesamt = parseFloat(ukFahrt||0)+parseFloat(ukUeber||0)+parseFloat(ukSonst||0);
    setUkResult({ gesamt: gesamt.toFixed(2) });
    speichern({}, { typ:"üöó Mehrbedarf Umgangskosten", ergebnis: gesamt.toFixed(2)+" ‚Ç¨ / Monat", details: "Fahrtkosten + √úbernachtung + Sonstiges" });
  };

  // ‚îÄ‚îÄ TBG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [tbgModell, setTbgModell] = useState(ext && ext.betreuungsmodell ? (ext.betreuungsmodell.toLowerCase().includes("parit") ? "paritaetisch" : "asymmetrisch") : "");
  const [tbgTageA, setTbgTageA] = useState("15");
  const [tbgTageB, setTbgTageB] = useState("15");
  const [tbgKgEmpf, setTbgKgEmpf] = useState(ext && ext.kindergeldEmpf ? (ext.kindergeldEmpf.toLowerCase().includes("antrag") ? "antragsteller" : "anderer") : "");
  const [tbgKgBetrag, setTbgKgBetrag] = useState(ext ? String(ext.kindergeldBetrag || "250") : "250");
  const [tbgResult, setTbgResult] = useState(null);

  const berechneTBG = () => {
    const tA = parseFloat(tbgTageA||0); const tB = parseFloat(tbgTageB||0);
    const ges = tA+tB; if (ges===0) return;
    const antA = tA/ges; const antB = tB/ges;
    const rbKind = 390; const mb = 563*0.36;
    let regelA, regelB, mehrA, mehrB;
    if (tbgModell === "paritaetisch") { regelA=rbKind*0.5; regelB=rbKind*0.5; mehrA=mb/2; mehrB=mb/2; }
    else { regelA=rbKind*antA; regelB=rbKind*antB; if (antA>=antB) { mehrA=mb; mehrB=0; } else { mehrA=0; mehrB=mb; } }
    const kg = parseFloat(tbgKgBetrag||0);
    const kgA = tbgKgEmpf==="antragsteller" ? kg : 0;
    const nettoA = Math.max(0, regelA+mehrA-kgA);
    setTbgResult({ regelA:regelA.toFixed(2), mehrA:mehrA.toFixed(2), kgA:kgA.toFixed(2), nettoA:nettoA.toFixed(2), regelB:regelB.toFixed(2), mehrB:mehrB.toFixed(2), tageA:tA, tageB:tB });
    const neueFelder = {};
    if (!ext || !ext.betreuungsmodell) neueFelder.betreuungsmodell = tbgModell==="paritaetisch" ? "Parit√§tisches Wechselmodell" : "Asymmetrisches Modell";
    if (!ext || !ext.kindergeldBetrag) neueFelder.kindergeldBetrag = parseFloat(tbgKgBetrag||0);
    speichern(neueFelder, { typ:"üè† Temp. Bedarfsgemeinschaft", ergebnis: "Antragsteller*in: "+nettoA.toFixed(2)+" ‚Ç¨ Netto-Anteil", details: tA+" Tage / "+tB+" Tage, Modell: "+tbgModell });
  };

  // ‚îÄ‚îÄ Wohngeld ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [wgNetto, setWgNetto] = useState(netto);
  const [wgMiete, setWgMiete] = useState(mieteW);
  const [wgStufe, setWgStufe] = useState(mStufe);
  const [wgHH, setWgHH] = useState(haushalt);
  const [wgUnterhalt, setWgUnterhalt] = useState(uBetrag);
  const [wgUTitel, setWgUTitel] = useState(uTitel);
  const [wgResult, setWgResult] = useState(null);

  const hoechstTab = {"1":{"1":404,"2":449,"3":502,"4":548,"5":591,"6":660},"2":{"1":490,"2":545,"3":610,"4":666,"5":718,"6":803},"3":{"1":585,"2":651,"3":729,"4":796,"5":859,"6":960},"4":{"1":672,"2":747,"3":836,"4":913,"5":984,"6":1100},"5":{"1":760,"2":845,"3":946,"4":1032,"5":1113,"6":1245}};

  const berechneWG = () => {
    const n = parseFloat(wgNetto||0);
    const uAbzug = wgUTitel==="ja" ? parseFloat(wgUnterhalt||0) : 0;
    const verf = Math.max(0, n-uAbzug);
    let frei = 0;
    if (verf<=100) frei=verf;
    else { frei=100+Math.min(verf-100,420)*0.20; if(verf>520) frei+=Math.min(verf-520,480)*0.30; if(verf>1000) frei+=Math.min(verf-1000,500)*0.10; }
    const anr = Math.max(0,verf-frei);
    const hh = String(Math.min(5,Math.max(1,parseInt(wgHH)||1)));
    const st = String(Math.min(6,Math.max(1,parseInt(wgStufe)||3)));
    const hb = (hoechstTab[hh] && hoechstTab[hh][st]) ? hoechstTab[hh][st] : 502;
    const mietAnr = Math.min(parseFloat(wgMiete||0), hb);
    const hn = parseInt(hh);
    const wg = Math.max(0, 1.15*(mietAnr-(0.04+0.46*hn)*anr-0.000097*anr*anr));
    const wohngeld = Math.round(Math.min(wg, mietAnr));
    setWgResult({ n:n.toFixed(2), uAbzug:uAbzug.toFixed(2), verf:verf.toFixed(2), frei:frei.toFixed(2), anr:anr.toFixed(2), hb:hb.toFixed(2), mietAnr:mietAnr.toFixed(2), wohngeld, kein:wohngeld<=0 });
    const neueFelder = {};
    if (!ext || !ext.einkommenNetto) neueFelder.einkommenNetto = parseFloat(wgNetto||0);
    if (!ext || !ext.mieteWarm) neueFelder.mieteWarm = parseFloat(wgMiete||0);
    if (!ext || !ext.mietStufe) neueFelder.mietStufe = wgStufe;
    if (!ext || !ext.unterhaltsTitel) { neueFelder.unterhaltsTitel = wgUTitel==="ja"; neueFelder.unterhaltBetrag = parseFloat(wgUnterhalt||0); }
    speichern(neueFelder, { typ:"üè° Wohngeld", ergebnis: wohngeld<=0 ? "Kein Anspruch" : wohngeld+" ‚Ç¨ / Monat", details: "Miete "+wgMiete+" ‚Ç¨, Stufe "+wgStufe+", HH "+wgHH+" Pers." });
  };

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (rechner === "kindes") return (
    <div>
      <h4 style={u.modTitle}>‚öñÔ∏è Kindesunterhalt</h4>
      {(netto||nettoG) && <div style={u.infoBox}>‚úÖ {netto ? "Eigenes Einkommen" : ""}{netto && nettoG ? " und " : ""}{nettoG ? "Einkommen Gegenseite" : ""} aus Akte vorausgef√ºllt.</div>}
      <label style={u.sectionLabel}>Mein Nettoeinkommen (‚Ç¨):</label>
      <input type="number" style={u.input} value={kuEinSelbst} onChange={e => setKuEinSelbst(e.target.value)} />
      <label style={u.sectionLabel}>Einkommen Gegenseite (‚Ç¨):</label>
      <input type="number" style={u.input} placeholder="Bitte eingeben" value={kuEinAnderer} onChange={e => setKuEinAnderer(e.target.value)} />
      <div style={{ fontSize:"11px", backgroundColor:"#f0f4f7", borderRadius:"6px", padding:"8px", marginBottom:"8px" }}>
        Kinder: {kuKinder.map((k,i) => "Kind "+(i+1)+" ("+k.alter+" J.)").join(", ")}
      </div>
      <button style={u.btnPrimary} onClick={berechneKU}>Berechnen & In Akte speichern</button>
      {kuResult && (
        <div style={u.resultBox}>
          {kuResult.mangelfall && <div style={u.warnung}>‚ö†Ô∏è Mangelfall ‚Äì anteilig gek√ºrzt.</div>}
          <div style={u.calcStep}><span>Bereinigtes Netto:</span><span>{kuResult.berN1} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>‚Äì Selbstbehalt:</span><span>{kuResult.sb} ‚Ç¨</span></div>
          <div style={{...u.calcStep,fontWeight:"bold",borderTop:"1px solid #00afad",paddingTop:"4px",marginTop:"4px"}}><span>Verf√ºgbare Masse:</span><span>{kuResult.masse} ‚Ç¨</span></div>
          <div style={u.compositionBox}>
            {kuResult.details.map((d,i) => <div key={i} style={u.resRow}><span>Kind {i+1}:</span><span>{d.z} ‚Ç¨</span></div>)}
            <div style={{...u.resRow,fontWeight:"bold",fontSize:"16px",borderTop:"2px solid #003366",paddingTop:"4px",marginTop:"4px"}}><span>Gesamt / Monat:</span><span>{kuResult.gesamt} ‚Ç¨</span></div>
          </div>
          <div style={{...u.infoBox,marginTop:"8px",color:"#0a4a0a",backgroundColor:"#e8f5e9",borderColor:"#a5d6a7"}}>‚úÖ Ergebnis wurde in der Akte gespeichert.</div>
        </div>
      )}
    </div>
  );

  if (rechner === "trennung") return (
    <div>
      <h4 style={u.modTitle}>üë´ Trennungsunterhalt (¬ß 1361 BGB)</h4>
      {(netto||nettoG) && <div style={u.infoBox}>‚úÖ {netto ? "Einkommen Antragsteller*in" : ""}{netto && nettoG ? " und " : ""}{nettoG ? "Einkommen Gegenseite" : ""} aus Akte vorausgef√ºllt.</div>}
      <label style={u.sectionLabel}>Einkommen Antragsteller*in (‚Ç¨):</label>
      <input type="number" style={u.input} value={tuEinA} onChange={e => setTuEinA(e.target.value)} />
      <label style={u.sectionLabel}>Einkommen Verpflichteter (‚Ç¨):</label>
      <input type="number" style={u.input} placeholder="Bitte eingeben" value={tuEinV} onChange={e => setTuEinV(e.target.value)} />
      <button style={u.btnPrimary} onClick={berechneTU}>Berechnen & In Akte speichern</button>
      {tuResult && (
        <div style={u.resultBox}>
          {tuResult.kein ? <div style={u.warnung}>‚ö†Ô∏è Kein Unterhaltsanspruch.</div> : (
            <>
              <div style={u.calcStep}><span>Bereinigt Antragsteller*in:</span><span>{tuResult.bereA} ‚Ç¨</span></div>
              <div style={u.calcStep}><span>Bereinigt Verpflichteter:</span><span>{tuResult.bereV} ‚Ç¨</span></div>
              <div style={u.calcStep}><span>‚Äì Selbstbehalt:</span><span>1.200 ‚Ç¨</span></div>
              <div style={{...u.calcStep,fontWeight:"bold",borderTop:"1px solid #00afad",paddingTop:"4px",marginTop:"4px"}}><span>Masse:</span><span>{tuResult.masse} ‚Ç¨</span></div>
              <div style={u.compositionBox}><div style={{...u.resRow,fontWeight:"bold",fontSize:"16px",borderTop:"2px solid #003366",paddingTop:"4px"}}><span>Trennungsunterhalt:</span><span>{tuResult.anspruch} ‚Ç¨/Monat</span></div></div>
            </>
          )}
          <div style={{...u.infoBox,marginTop:"8px",color:"#0a4a0a",backgroundColor:"#e8f5e9",borderColor:"#a5d6a7"}}>‚úÖ Ergebnis wurde in der Akte gespeichert.</div>
        </div>
      )}
    </div>
  );

  if (rechner === "nachehelich") return (
    <div>
      <h4 style={u.modTitle}>üíç Nachehelicher Unterhalt (¬ß¬ß 1569 ff.)</h4>
      {(netto||nettoG) && <div style={u.infoBox}>‚úÖ {netto ? "Einkommen Antragsteller*in" : ""}{netto && nettoG ? " und " : ""}{nettoG ? "Einkommen Gegenseite" : ""} aus Akte vorausgef√ºllt.</div>}
      <label style={u.sectionLabel}>Einkommen berechtigte Person (‚Ç¨):</label>
      <input type="number" style={u.input} value={nuEinA} onChange={e => setNuEinA(e.target.value)} />
      <label style={u.sectionLabel}>Einkommen Verpflichteter (‚Ç¨):</label>
      <input type="number" style={u.input} placeholder="Bitte eingeben" value={nuEinV} onChange={e => setNuEinV(e.target.value)} />
      <button style={u.btnPrimary} onClick={berechneNU}>Berechnen & In Akte speichern</button>
      {nuResult && (
        <div style={u.resultBox}>
          {nuResult.kein ? <div style={u.warnung}>‚ö†Ô∏è Kein Anspruch.</div> : (
            <>
              <div style={u.calcStep}><span>Bereinigt Verpflichteter:</span><span>{nuResult.bereV} ‚Ç¨</span></div>
              <div style={u.calcStep}><span>‚Äì Selbstbehalt Ex-Ehegatte:</span><span>1.300 ‚Ç¨</span></div>
              <div style={{...u.calcStep,fontWeight:"bold",borderTop:"1px solid #00afad",paddingTop:"4px",marginTop:"4px"}}><span>Masse:</span><span>{nuResult.masse} ‚Ç¨</span></div>
              <div style={u.compositionBox}><div style={{...u.resRow,fontWeight:"bold",fontSize:"16px",borderTop:"2px solid #003366",paddingTop:"4px"}}><span>Nachehelicher Unterhalt:</span><span>{nuResult.anspruch} ‚Ç¨/Monat</span></div></div>
            </>
          )}
          <div style={{...u.infoBox,marginTop:"8px",color:"#0a4a0a",backgroundColor:"#e8f5e9",borderColor:"#a5d6a7"}}>‚úÖ Ergebnis wurde in der Akte gespeichert.</div>
        </div>
      )}
    </div>
  );

  if (rechner === "mbAlleinerziehende") return (
    <div>
      <h4 style={u.modTitle}>üë®‚Äçüëß Mehrbedarf Alleinerziehende (¬ß 21 Abs.3 SGB II)</h4>
      {ext && ext.betreuungsmodell && <div style={u.infoBox}>‚úÖ Betreuungsmodell aus Akte: <strong>{ext.betreuungsmodell}</strong></div>}
      <div style={{ fontSize:"12px", marginBottom:"8px" }}>Kinderkonstellation: <strong>{mbKonf}</strong> ({anzK} Kind{anzK!==1?"er":""})</div>
      <label style={u.sectionLabel}>Betreuungsmodell best√§tigen:</label>
      <div style={{ display:"flex", gap:"8px", marginBottom:"12px" }}>
        {["paritaetisch","asymmetrisch"].map(v => (
          <div key={v} onClick={() => setMbModell(v)} style={{ padding:"6px 12px", borderRadius:"8px", fontSize:"11px", cursor:"pointer", backgroundColor:mbModell===v?"#00afad":"#eee", color:mbModell===v?"#fff":"#333" }}>
            {v==="paritaetisch" ? "Parit√§tisch" : "Residenz / Asymm."}
          </div>
        ))}
      </div>
      <button style={{...u.btnPrimary, opacity:mbModell?1:0.5}} disabled={!mbModell} onClick={berechneMB}>Berechnen & In Akte speichern</button>
      {mbResult && (
        <div style={u.resultBox}>
          <div style={u.calcStep}><span>Regelbedarf:</span><span>563,00 ‚Ç¨</span></div>
          <div style={u.calcStep}><span>Prozentsatz:</span><span>{mbResult.proz} %</span></div>
          <div style={{...u.calcStep,fontWeight:"bold",borderTop:"1px solid #00afad",paddingTop:"4px",marginTop:"4px"}}><span>Mehrbedarf / Monat:</span><span>{mbResult.betrag} ‚Ç¨</span></div>
          <div style={{...u.infoBox,marginTop:"6px"}}>üìã {mbResult.hinweis}</div>
          <div style={{...u.infoBox,marginTop:"8px",color:"#0a4a0a",backgroundColor:"#e8f5e9",borderColor:"#a5d6a7"}}>‚úÖ Ergebnis wurde in der Akte gespeichert.</div>
        </div>
      )}
    </div>
  );

  if (rechner === "mbUmgang") return (
    <div>
      <h4 style={u.modTitle}>üöó Mehrbedarf Umgangskosten (¬ß 21 SGB II)</h4>
      {ext && ext.betreuungsmodell && <div style={u.infoBox}>Betreuungsmodell: <strong>{ext.betreuungsmodell}</strong></div>}
      <label style={u.sectionLabel}>Fahrtkosten (‚Ç¨/Monat):</label>
      <input type="number" style={u.input} placeholder="0" value={ukFahrt} onChange={e => setUkFahrt(e.target.value)} />
      <label style={u.sectionLabel}>√úbernachtungskosten (‚Ç¨/Monat):</label>
      <input type="number" style={u.input} placeholder="0" value={ukUeber} onChange={e => setUkUeber(e.target.value)} />
      <label style={u.sectionLabel}>Sonstige Kosten (‚Ç¨/Monat):</label>
      <input type="number" style={u.input} placeholder="0" value={ukSonst} onChange={e => setUkSonst(e.target.value)} />
      <button style={u.btnPrimary} onClick={berechneUK}>Berechnen & In Akte speichern</button>
      {ukResult && (
        <div style={u.resultBox}>
          <div style={{...u.resRow,fontWeight:"bold",fontSize:"16px"}}><span>Umgangskosten gesamt:</span><span>{ukResult.gesamt} ‚Ç¨/Monat</span></div>
          <div style={{ fontSize:"10px", color:"#999", marginTop:"6px" }}>Anerkennung liegt im Ermessen des Jobcenters.</div>
          <div style={{...u.infoBox,marginTop:"8px",color:"#0a4a0a",backgroundColor:"#e8f5e9",borderColor:"#a5d6a7"}}>‚úÖ Ergebnis wurde in der Akte gespeichert.</div>
        </div>
      )}
    </div>
  );

  if (rechner === "tbg") return (
    <div>
      <h4 style={u.modTitle}>üè† Tempor√§re Bedarfsgemeinschaft (TBG)</h4>
      {ext && ext.betreuungsmodell && <div style={u.infoBox}>‚úÖ Betreuungsmodell aus Akte: <strong>{ext.betreuungsmodell}</strong></div>}
      <label style={u.sectionLabel}>Betreuungsmodell:</label>
      <div style={{ display:"flex", flexDirection:"column", gap:"6px", marginBottom:"10px" }}>
        {[{v:"paritaetisch",l:"Parit√§tisches Wechselmodell (ca. 50:50)"},{v:"asymmetrisch",l:"Asymmetrisch / Residenz (weniger als 50%)"}].map(m => (
          <label key={m.v} style={{ display:"flex", gap:"8px", fontSize:"12px", cursor:"pointer", alignItems:"flex-start" }}>
            <input type="radio" checked={tbgModell===m.v} onChange={() => setTbgModell(m.v)} style={{ marginTop:"2px" }} />{m.l}
          </label>
        ))}
      </div>
      <div style={{ display:"flex", gap:"10px" }}>
        <div style={{ flex:1 }}><label style={u.sectionLabel}>Tage/Monat Antragsteller*in:</label><input type="number" style={u.input} value={tbgTageA} onChange={e => setTbgTageA(e.target.value)} /></div>
        <div style={{ flex:1 }}><label style={u.sectionLabel}>Tage/Monat and. Elternteil:</label><input type="number" style={u.input} value={tbgTageB} onChange={e => setTbgTageB(e.target.value)} /></div>
      </div>
      <label style={u.sectionLabel}>Wer bezieht das Kindergeld?</label>
      <div style={{ display:"flex", gap:"8px", marginBottom:"10px" }}>
        {[{v:"antragsteller",l:"Antragsteller*in"},{v:"anderer",l:"And. Elternteil"}].map(x => (
          <div key={x.v} onClick={() => setTbgKgEmpf(x.v)} style={{ padding:"6px 12px", borderRadius:"8px", fontSize:"11px", cursor:"pointer", backgroundColor:tbgKgEmpf===x.v?"#003366":"#eee", color:tbgKgEmpf===x.v?"#fff":"#333" }}>{x.l}</div>
        ))}
      </div>
      <label style={u.sectionLabel}>Kindergeldbetrag (‚Ç¨/Monat):</label>
      <input type="number" style={u.input} value={tbgKgBetrag} onChange={e => setTbgKgBetrag(e.target.value)} />
      <button style={{...u.btnPrimary, opacity:tbgModell&&tbgKgEmpf?1:0.5}} disabled={!tbgModell||!tbgKgEmpf} onClick={berechneTBG}>Berechnen & In Akte speichern</button>
      {tbgResult && (
        <div style={u.resultBox}>
          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:"8px" }}>
            <div style={u.compositionBox}>
              <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"6px" }}>Antragsteller*in ({tbgResult.tageA} Tage)</div>
              <div style={u.calcStep}><span style={{fontSize:"11px"}}>Regelbedarf Kind:</span><span>{tbgResult.regelA} ‚Ç¨</span></div>
              <div style={u.calcStep}><span style={{fontSize:"11px"}}>+ Mehrbedarf:</span><span>{tbgResult.mehrA} ‚Ç¨</span></div>
              {parseFloat(tbgResult.kgA)>0 && <div style={u.calcStep}><span style={{fontSize:"11px"}}>‚Äì Kindergeld:</span><span>{tbgResult.kgA} ‚Ç¨</span></div>}
              <div style={{...u.calcStep,fontWeight:"bold",borderTop:"1px solid #003366",paddingTop:"4px",marginTop:"4px"}}><span>Netto-Anteil:</span><span>{tbgResult.nettoA} ‚Ç¨</span></div>
            </div>
            <div style={u.compositionBox}>
              <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"6px" }}>And. Elternteil ({tbgResult.tageB} Tage)</div>
              <div style={u.calcStep}><span style={{fontSize:"11px"}}>Regelbedarf Kind:</span><span>{tbgResult.regelB} ‚Ç¨</span></div>
              <div style={u.calcStep}><span style={{fontSize:"11px"}}>+ Mehrbedarf:</span><span>{tbgResult.mehrB} ‚Ç¨</span></div>
              <div style={{...u.calcStep,fontWeight:"bold",borderTop:"1px solid #003366",paddingTop:"4px",marginTop:"4px"}}><span>Gesamt:</span><span>{(parseFloat(tbgResult.regelB)+parseFloat(tbgResult.mehrB)).toFixed(2)} ‚Ç¨</span></div>
            </div>
          </div>
          <div style={{...u.infoBox,marginTop:"8px",color:"#0a4a0a",backgroundColor:"#e8f5e9",borderColor:"#a5d6a7"}}>‚úÖ Ergebnis und neue Daten in der Akte gespeichert.</div>
        </div>
      )}
    </div>
  );

  if (rechner === "wohngeld") return (
    <div>
      <h4 style={u.modTitle}>üè° Wohngeld (WoGG)</h4>
      {(netto||mieteW) && <div style={u.infoBox}>‚úÖ Einkommen und/oder Miete aus Akte vorausgef√ºllt.</div>}
      <label style={u.sectionLabel}>Nettoeinkommen (‚Ç¨/Monat):</label>
      <input type="number" style={u.input} value={wgNetto} onChange={e => setWgNetto(e.target.value)} />
      <label style={u.sectionLabel}>Bruttomiete warm (‚Ç¨/Monat):</label>
      <input type="number" style={u.input} value={wgMiete} onChange={e => setWgMiete(e.target.value)} />
      <div style={{ display:"flex", gap:"10px" }}>
        <div style={{ flex:1 }}>
          <label style={u.sectionLabel}>Haushaltsgr√∂√üe:</label>
          <select style={u.input} value={wgHH} onChange={e => setWgHH(e.target.value)}>
            {["1","2","3","4","5"].map(n => <option key={n} value={n}>{n} {n==="1"?"Person":"Personen"}</option>)}
          </select>
        </div>
        <div style={{ flex:1 }}>
          <label style={u.sectionLabel}>Mietenstufe:</label>
          <select style={u.input} value={wgStufe} onChange={e => setWgStufe(e.target.value)}>
            {["1","2","3","4","5","6"].map(s => <option key={s} value={s}>Stufe {s}</option>)}
          </select>
        </div>
      </div>
      <label style={u.sectionLabel}>Unterhaltstitel vorhanden und gezahlt?</label>
      <div style={{ display:"flex", gap:"8px", marginBottom:"8px" }}>
        {[{v:"ja",l:"Ja"},{v:"nein",l:"Nein"}].map(x => (
          <div key={x.v} onClick={() => setWgUTitel(x.v)} style={{ padding:"6px 14px", borderRadius:"8px", fontSize:"12px", cursor:"pointer", backgroundColor:wgUTitel===x.v?"#003366":"#eee", color:wgUTitel===x.v?"#fff":"#333" }}>{x.l}</div>
        ))}
      </div>
      {wgUTitel==="ja" && (
        <>
          <label style={u.sectionLabel}>Unterhaltsbetrag (‚Ç¨/Monat):</label>
          <input type="number" style={u.input} value={wgUnterhalt} onChange={e => setWgUnterhalt(e.target.value)} />
        </>
      )}
      <button style={u.btnPrimary} onClick={berechneWG}>Berechnen & In Akte speichern</button>
      {wgResult && (
        <div style={u.resultBox}>
          <div style={u.calcStep}><span>Nettoeinkommen:</span><span>{wgResult.n} ‚Ç¨</span></div>
          {parseFloat(wgResult.uAbzug)>0 && <div style={u.calcStep}><span>‚Äì Unterhalt:</span><span>{wgResult.uAbzug} ‚Ç¨</span></div>}
          <div style={u.calcStep}><span>Verf√ºgbar:</span><span>{wgResult.verf} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>‚Äì Freibetrag:</span><span>{wgResult.frei} ‚Ç¨</span></div>
          <div style={{...u.calcStep,borderTop:"1px solid #00afad",paddingTop:"4px",marginTop:"4px"}}><span>Anzurechnendes Einkommen:</span><span>{wgResult.anr} ‚Ç¨</span></div>
          <div style={u.calcStep}><span>Anrechenbare Miete (max. {wgResult.hb} ‚Ç¨):</span><span>{wgResult.mietAnr} ‚Ç¨</span></div>
          {wgResult.kein
            ? <div style={{...u.warnung,marginTop:"8px"}}>‚ö†Ô∏è Kein Wohngeldanspruch. Ggf. B√ºrgergeld pr√ºfen.</div>
            : <div style={u.compositionBox}><div style={{...u.resRow,fontWeight:"bold",fontSize:"16px",borderTop:"2px solid #003366",paddingTop:"4px"}}><span>Wohngeld ca.:</span><span>{wgResult.wohngeld} ‚Ç¨/Monat</span></div></div>
          }
          <div style={{...u.infoBox,marginTop:"8px",color:"#0a4a0a",backgroundColor:"#e8f5e9",borderColor:"#a5d6a7"}}>‚úÖ Neue Daten und Ergebnis in der Akte gespeichert.</div>
        </div>
      )}
    </div>
  );

  return <div style={{ color:"#999", fontSize:"12px" }}>Rechner nicht gefunden.</div>;
}


// =============================================
// MEHR-DATEN-VIEW KOMPONENTE
// =============================================
function MehrDatenView({ ext }) {
  const sh = { fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginTop:"14px", marginBottom:"6px", letterSpacing:"0.5px" };
  const kb = { backgroundColor:"#f9f9f9", borderRadius:"8px", padding:"10px", marginBottom:"8px", borderLeft:"3px solid #00afad" };
  const kr = { display:"flex", justifyContent:"space-between", fontSize:"12px", paddingBottom:"3px", borderBottom:"1px solid #eee", marginBottom:"3px" };
  const dr = { display:"flex", justifyContent:"space-between", padding:"8px 0", borderBottom:"1px solid #f5f5f5", fontSize:"13px" };
  return (
    <div style={{ marginTop:"12px" }}>
      <div style={sh}>üë®‚Äçüë©‚Äçüëß Familiensituation</div>
      <div style={dr}><span>Familienstand:</span><strong>{ext.familienstand}</strong></div>
      <div style={dr}><span>Alleinerziehend:</span><strong>{ext.alleinerziehend ? "Ja" : "Nein"}</strong></div>
      <div style={dr}><span>Betreuungsmodell:</span><strong style={{ fontSize:"12px" }}>{ext.betreuungsmodell}</strong></div>

      <div style={sh}>üë∂ Kinder</div>
      {ext.kinder.map((k, i) => (
        <div key={i} style={kb}>
          <div style={{ fontWeight:"bold", fontSize:"13px", marginBottom:"4px" }}>Kind {i+1}: {k.name}</div>
          <div style={kr}><span>Geburtsdatum:</span><span>{k.geburt}</span></div>
          <div style={kr}><span>Altersgruppe:</span><span>{k.alter}</span></div>
          <div style={kr}><span>Wohnort:</span><span>{k.wohnort}</span></div>
          <div style={kr}><span>UVG:</span><span>{k.uvg ? "‚úÖ Ja" : "‚ùå Nein"}</span></div>
          <div style={kr}><span>Kindergeld:</span><span>{k.kg ? "‚úÖ Ja" : "‚ùå Nein"}</span></div>
        </div>
      ))}

      <div style={sh}>üí∂ Einkommen & Leistungen</div>
      <div style={dr}><span>Nettoeinkommen:</span><strong>{ext.einkommenNetto} EUR</strong></div>
      {ext.einkommenGegenseite > 0 && <div style={dr}><span>Einkommen Gegenseite:</span><strong>{ext.einkommenGegenseite} EUR</strong></div>}
      <div style={dr}><span>Art:</span><strong style={{ fontSize:"12px" }}>{ext.einkommenArt}</strong></div>
      {ext.uvgBetrag > 0 && <div style={dr}><span>Unterhaltsvorschuss:</span><strong>{ext.uvgBetrag} EUR/Monat</strong></div>}
      <div style={dr}><span>Kindergeld:</span><strong>{ext.kindergeldBetrag} EUR/Monat</strong></div>
      <div style={dr}><span>KG-Empf√§nger:</span><strong style={{ fontSize:"12px" }}>{ext.kindergeldEmpf}</strong></div>

      <div style={sh}>‚öñÔ∏è Unterhalt</div>
      <div style={dr}><span>Unterhaltstitel:</span><strong>{ext.unterhaltsTitel ? "‚úÖ Vorhanden" : "‚ùå Kein Titel"}</strong></div>
      {ext.unterhaltBetrag > 0 && <div style={dr}><span>Betrag:</span><strong>{ext.unterhaltBetrag} EUR/Monat</strong></div>}

      <div style={sh}>üè† Wohnen</div>
      <div style={dr}><span>Wohnungsgroesse:</span><strong>{ext.wohnungGroesse} m¬≤</strong></div>
      <div style={dr}><span>Miete warm:</span><strong>{ext.mieteWarm} EUR/Monat</strong></div>
      <div style={dr}><span>Miete kalt:</span><strong>{ext.mieteKalt} EUR/Monat</strong></div>
      <div style={dr}><span>Heizkosten:</span><strong>{ext.heizkosten} EUR/Monat</strong></div>
      <div style={dr}><span>Mietenstufe:</span><strong>Stufe {ext.mietStufe}</strong></div>

      {ext.notizen && (
        <div style={{ marginTop:"12px", backgroundColor:"#f0f4f7", borderRadius:"8px", padding:"10px", fontSize:"12px", color:"#444", borderLeft:"3px solid #00afad" }}>
          üìã <strong>Notizen:</strong><br />{ext.notizen}
        </div>
      )}
    </div>
  );
}

// =============================================
// HAUPT-APP
// =============================================
function App() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [loginDaten, setLoginDaten] = useState(() => {
    try {
      const gespeichert = localStorage.getItem("isuv_profil");
      if (gespeichert) {
        const d = JSON.parse(gespeichert);
        return { leiter:d.leiter||"", ort:d.ort||"", email:d.email||"", passwort:d.passwort||"", whatsapp:d.whatsapp||"", supabaseUrl:d.supabaseUrl||"", supabaseKey:d.supabaseKey||"" };
      }
    } catch(e) {}
    return { leiter:"", ort:"", email:"", passwort:"", whatsapp:"", supabaseUrl:"", supabaseKey:"" };
  });
  const [showProfil, setShowProfil] = useState(false);
  const [formularVersandDialogNeu, setFormularVersandDialogNeu] = useState(null);
  const [view, setView] = useState("dashboard");
  const [monthOffset, setMonthOffset] = useState(new Date().getMonth());
  const [showMemberList, setShowMemberList] = useState(false);
  const [showFormulare, setShowFormulare] = useState(false);
  const [showCalendar, setShowCalendar] = useState(false);
  const [showRechner, setShowRechner] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [openActionMenuId, setOpenActionMenuId] = useState(null);
  const [activeMember, setActiveMember] = useState(null);
  const [selectedTerminId, setSelectedTerminId] = useState(null);

  const [members, setMembers] = useState([
    { id: 1, vorname: "Sabine", name: "Landgraf", tel: "01701234567", mail: "s.landgraf@gmx.de", strasse: "Musterweg 1", plz: "12345", ort: "Musterstadt" },
    { id: 2, vorname: "Markus", name: "Siedler", tel: "01729876543", mail: "m.siedler@web.de", strasse: "Feldstr. 12", plz: "54321", ort: "Beispielort" },
    { id: 3, vorname: "Wolfgang", name: "Wechsel", tel: "01755556677", mail: "wolf@wechsel.de", strasse: "Hauptstr. 5", plz: "99887", ort: "Testdorf" },
    { id: 4, vorname: "Susanne", name: "Vogel", tel: "01512223344", mail: "s.vogel@icloud.com", strasse: "Wiesenstr. 3", plz: "10203", ort: "Berlin" }
  ]);

  const [memberExtras, setMemberExtras] = useState({
    1: {
      familienstand: "getrennt lebend", alleinerziehend: true,
      betreuungsmodell: "Residenzmodell (beide Kinder bei Mutter)",
      kinder: [
        { name: "Landgraf, Leon", geburt: "12.03.2017", alter: "6-11 J.", wohnort: "bei Mutter", uvg: true, kg: true },
        { name: "Landgraf, Lena", geburt: "05.09.2019", alter: "0-5 J.", wohnort: "bei Mutter", uvg: true, kg: true }
      ],
      einkommenNetto: 1300, einkommenArt: "Arbeitseinkommen (Teilzeit)",
      uvgBetrag: 357, kindergeldBetrag: 500, kindergeldEmpf: "Antragstellerin",
      wohnungGroesse: 100, mieteWarm: 1100, mieteKalt: 850, heizkosten: 250, mietStufe: "3",
      unterhaltsTitel: false, unterhaltBetrag: 0,
      notizen: "Unterhaltsverpflichteter zahlt nicht. UVG l√§uft. Beide Kinder bei Sabine gemeldet."
    },
    2: {
      familienstand: "getrennt lebend", alleinerziehend: false,
      betreuungsmodell: "Asymmetrisches Wechselmodell (10 Tage Vater / 20 Tage Mutter)",
      kinder: [
        { name: "Siedler, Max", geburt: "22.07.2016", alter: "6-11 J.", wohnort: "Wechselmodell", uvg: false, kg: false }
      ],
      einkommenNetto: 2100, einkommenArt: "Arbeitseinkommen (Vollzeit)",
      uvgBetrag: 0, kindergeldBetrag: 250, kindergeldEmpf: "Mutter (ueberwiegend betreuend)",
      wohnungGroesse: 65, mieteWarm: 780, mieteKalt: 630, heizkosten: 150, mietStufe: "3",
      unterhaltsTitel: true, unterhaltBetrag: 426,
      notizen: "Unterhalt tituliert per Jugendamtsurkunde. Zahlt regelmaessig. Kind 10 Tage beim Vater."
    },
    3: {
      familienstand: "geschieden", alleinerziehend: false,
      betreuungsmodell: "Paritaetisches Wechselmodell (15/15 Tage)",
      kinder: [
        { name: "Wechsel, Mia", geburt: "14.04.2015", alter: "6-11 J.", wohnort: "Wechselmodell 50:50", uvg: false, kg: false },
        { name: "Wechsel, Tim", geburt: "30.11.2018", alter: "0-5 J.", wohnort: "Wechselmodell 50:50", uvg: false, kg: false }
      ],
      einkommenNetto: 1750, einkommenArt: "Arbeitseinkommen (Vollzeit)",
      uvgBetrag: 0, kindergeldBetrag: 500, kindergeldEmpf: "Beide je 250 EUR haelftig geteilt",
      wohnungGroesse: 80, mieteWarm: 950, mieteKalt: 760, heizkosten: 190, mietStufe: "3",
      unterhaltsTitel: true, unterhaltBetrag: 0,
      notizen: "Kein Barunterhalt. Kindergeld haelftig geteilt. Beide gleich viel betreuend."
    },
    4: {
      familienstand: "geschieden", alleinerziehend: true,
      betreuungsmodell: "Residenzmodell (Umgang jedes 2. Wochenende)",
      kinder: [
        { name: "Vogel, Jana", geburt: "03.06.2014", alter: "12-17 J.", wohnort: "bei Mutter", uvg: false, kg: true }
      ],
      einkommenNetto: 1850, einkommenArt: "Arbeitseinkommen (Vollzeit)",
      uvgBetrag: 0, kindergeldBetrag: 250, kindergeldEmpf: "Antragstellerin",
      wohnungGroesse: 72, mieteWarm: 1350, mieteKalt: 1080, heizkosten: 270, mietStufe: "5",
      unterhaltsTitel: true, unterhaltBetrag: 522,
      notizen: "Berlin Mietenstufe V. Unterhalt tituliert und regelmaessig gezahlt."
    }
  });
  const [memberErgebnisse, setMemberErgebnisse] = useState({});
  const [showMehrDaten, setShowMehrDaten] = useState(false);
  const [showNeuesMitglied, setShowNeuesMitglied] = useState(false);
  const [neuesMitglied, setNeuesMitglied] = useState({ vorname:"", name:"", tel:"", mail:"", strasse:"", plz:"", ort:"" });
  const [berechnungRechner, setBerechnungRechner] = useState(null);
  const [berechnungKategorie, setBerechnungKategorie] = useState(null);
  const [openRechnerMenuId, setOpenRechnerMenuId] = useState(null);
  const [showEingang, setShowEingang] = useState(false);
  const [versandMail, setVersandMail] = useState({});
  const [eingangFormulare, setEingangFormulare] = useState([
    { id:901, datum:"18.02.2026 09:41", typ:"Stammdaten-Fragebogen", absender:"s.landgraf@gmx.de", name:"Sabine Landgraf",
      felder:{ vorname:"Sabine", name:"Landgraf", tel:"01701234567", mail:"s.landgraf@gmx.de", strasse:"Musterweg 1", plz:"12345", ort:"Musterstadt", familienstand:"getrennt lebend", kinder:"2", einkommenNetto:"1300", mieteWarm:"1100", mietStufe:"3", notizen:"Bitte dringend Termin, UVG l√§uft aus." } }
  ]);
  const [aktivesEingangFormular, setAktivesEingangFormular] = useState(null);
  const [formFelderDaten, setFormFelderDaten] = useState({});
  const [ausgangFormulare, setAusgangFormulare] = useState([]);
  const [showAusgang, setShowAusgang] = useState(false);
  const [formulareVersandDialog, setFormulareVersandDialog] = useState(null);

  const [termine, setTermine] = useState([
    { id: 101, tag: 18, monat: new Date().getMonth(), zeit: "17:00", text: "Beratung: Anlage TBG", notiz: "Wichtiges Erstgespr√§ch" }
  ]);
  const [newTerminDialog, setNewTerminDialog] = useState(null);

  const [tbgKinder, setTbgKinder] = useState([
    { id: Date.now(), kNachname: "", kVorname: "", kGeburt: "", pNachname: "", pVorname: "", pStrasse: "", pPlz: "", pOrt: "", modell: "", tageMutter: Array(12).fill(""), tageVater: Array(12).fill(""), kgBerechtigt: "", kgBetrag: "" }
  ]);

  const addKind = () => setTbgKinder([...tbgKinder, { id: Date.now(), kNachname: "", kVorname: "", kGeburt: "", pNachname: "", pVorname: "", pStrasse: "", pPlz: "", pOrt: "", modell: "", tageMutter: Array(12).fill(""), tageVater: Array(12).fill("") }]);
  const handleAddTermin = (day) => setNewTerminDialog({ day, text: "" });
  const confirmAddTermin = () => {
    if (newTerminDialog && newTerminDialog.text.trim()) setTermine([...termine, { id: Date.now(), tag: newTerminDialog.day, monat: monthOffset, zeit: "10:00", text: newTerminDialog.text.trim(), notiz: "" }]);
    setNewTerminDialog(null);
  };
  const updateTermin = (id, field, value) => setTermine(termine.map(t => t.id === id ? { ...t, [field]: value } : t));
  const activeTermin = termine.find(t => t.id === selectedTerminId);


  // ‚îÄ‚îÄ Supabase Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const sbHeaders = () => ({
    "Content-Type": "application/json",
    "apikey": loginDaten.supabaseKey,
    "Authorization": "Bearer " + loginDaten.supabaseKey
  });

  const sbReady = () => loginDaten.supabaseUrl && loginDaten.supabaseKey;

  // Formular in Supabase speichern ‚Üí gibt { id, url } zur√ºck
  const sbSaveFormular = async (formTyp, formLabel, member, vorausgefuellt) => {
    if (!sbReady()) return null;
    const id = Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
    const baseUrl = loginDaten.supabaseUrl.replace("/rest/v1", "");
    const payload = {
      formular_id: id,
      typ: formTyp,
      label: formLabel,
      mitglied_name: member ? member.vorname + " " + member.name : null,
      mitglied_mail: member ? member.mail : null,
      mitglied_tel: member ? member.tel : null,
      vorausgefuellt: JSON.stringify(vorausgefuellt || {}),
      status: "gesendet",
      erstellt_am: new Date().toISOString()
    };
    try {
      const res = await fetch(loginDaten.supabaseUrl + "/formulare", {
        method: "POST", headers: { ...sbHeaders(), "Prefer": "return=representation" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) { console.error("Supabase save error", await res.text()); return null; }
      const formularUrl = "https://anspruchslotse.github.io/isuv-anspruchslotse/formular.html?id=" + id +
        "&sb=" + encodeURIComponent(baseUrl) +
        "&key=" + encodeURIComponent(loginDaten.supabaseKey);
      return { id, url: formularUrl };
    } catch(e) { console.error("Supabase error", e); return null; }
  };

  // Ausgef√ºllte Formulare aus Supabase laden
  const sbLadeEingaenge = async () => {
    if (!sbReady()) return;
    try {
      const res = await fetch(loginDaten.supabaseUrl + "/formulare?status=eq.beantwortet&order=beantwortet_am.desc", {
        headers: sbHeaders()
      });
      if (!res.ok) return;
      const rows = await res.json();
      const neu = rows.map(r => ({
        id: r.id,
        datum: r.beantwortet_am ? new Date(r.beantwortet_am).toLocaleString("de-DE") : "‚Äì",
        typ: r.label,
        absender: r.mitglied_mail || "‚Äì",
        name: r.mitglied_name || "Unbekannt",
        felder: JSON.parse(r.antwort_daten || "{}")
      }));
      setEingangFormulare(prev => {
        const existIds = new Set(prev.map(x => x.id));
        const wirklichNeu = neu.filter(x => !existIds.has(x.id));
        return wirklichNeu.length > 0 ? [...wirklichNeu, ...prev] : prev;
      });
    } catch(e) { console.error("Supabase load error", e); }
  };

  if (!isLoggedIn) return (
    <div style={styles.loginPage}>
      <div style={styles.loginCard}>
        <div style={styles.logo}>ISUV</div>
        <h2 style={{ textAlign: "center", marginBottom:"20px" }}>Anspruchslotse</h2>
        <input style={styles.input} placeholder="Leiter (Name)" value={loginDaten.leiter}
          onChange={e => setLoginDaten(function(p){ return Object.assign({},p,{leiter:e.target.value}); })} />
        <input style={styles.input} placeholder="Ortsgruppe / Ort" value={loginDaten.ort}
          onChange={e => setLoginDaten(function(p){ return Object.assign({},p,{ort:e.target.value}); })} />
        <input style={styles.input} type="email" placeholder="E-Mail-Adresse (Absender)" value={loginDaten.email}
          onChange={e => setLoginDaten(function(p){ return Object.assign({},p,{email:e.target.value}); })} />
        <input style={styles.input} type="password" placeholder="Passwort" value={loginDaten.passwort}
          onChange={e => setLoginDaten(function(p){ return Object.assign({},p,{passwort:e.target.value}); })} />
        <input style={styles.input} type="tel" placeholder="WhatsApp-Nummer (z.B. +49170...)" value={loginDaten.whatsapp}
          onChange={e => setLoginDaten(function(p){ return Object.assign({},p,{whatsapp:e.target.value}); })} />
        <div style={{ fontSize:"10px", color:"#999", marginBottom:"12px", textAlign:"center" }}>
          üì± WhatsApp-Nummer wird f√ºr Formular-Versand genutzt
        </div>
        <button style={styles.btnPrimary} onClick={() => setIsLoggedIn(true)}>Software starten</button>
        {(loginDaten.email || loginDaten.whatsapp) && (
          <div style={{ fontSize:"10px", color:"#00afad", textAlign:"center", marginTop:"8px" }}>
            {loginDaten.email && <div>‚úâÔ∏è E-Mail: {loginDaten.email}</div>}
            {loginDaten.whatsapp && <div>üì± WhatsApp: {loginDaten.whatsapp}</div>}
          </div>
        )}
      </div>
    </div>
  );

  return (
    <div style={styles.appFrame}>
      <header style={styles.header}>
        <div style={{ display: "flex", alignItems: "center", cursor: "pointer" }} onClick={() => setView("dashboard")}>
          <div style={styles.miniLogo}>I</div>
          <div style={{ marginLeft:"8px" }}>
            <strong style={{ display:"block", fontSize:"13px" }}>ANSPRUCHSLOTSE</strong>
            {(loginDaten.leiter || loginDaten.ort) && (
              <span style={{ fontSize:"10px", color:"#666" }}>{loginDaten.leiter}{loginDaten.leiter && loginDaten.ort ? " ¬∑ " : ""}{loginDaten.ort}</span>
            )}
          </div>
        </div>
        <div style={{ display:"flex", gap:"6px", alignItems:"center" }}>
          <button onClick={() => setView("profil")} style={{ ...styles.btnLogout, backgroundColor:"#e8f0fb", color:"#003366" }}>‚öôÔ∏è Profil</button>
          <button onClick={() => setIsLoggedIn(false)} style={styles.btnLogout}>Abmelden</button>
        </div>
      </header>

      <main style={styles.main}>
        {view === "dashboard" && (
          <div style={{ display: "flex", flexDirection: "column", gap: "10px" }}>

            {/* MITGLIEDER */}
            <div style={styles.card}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", cursor:"pointer" }} onClick={() => setShowMemberList(!showMemberList)}>
                <h3 style={{ margin: 0, fontSize: "14px" }}>üë• Mitglieder</h3>
                <div style={{ display:"flex", alignItems:"center", gap:"8px" }}>
                  <div onClick={e => { e.stopPropagation(); setShowNeuesMitglied(true); setView("neues_mitglied"); }}
                    style={{ backgroundColor:"#00afad", color:"#fff", border:"none", borderRadius:"6px", padding:"4px 10px", fontSize:"11px", cursor:"pointer", fontWeight:"bold" }}>
                    + Mitglied
                  </div>
                  <span>{showMemberList ? "‚ñ≤" : "‚ñº"}</span>
                </div>
              </div>
              {showMemberList && (
                <div style={{ marginTop: "10px" }}>
                  <input style={styles.input} placeholder="Suchen..." onChange={e => setSearchTerm(e.target.value)} />
                  {members.filter(m => (m.vorname + " " + m.name).toLowerCase().includes(searchTerm.toLowerCase())).map(m => (
                    <div key={m.id} style={styles.memberRow}>
                      <div onClick={() => { setActiveMember(m); setView("akte"); }} style={{ flex: 1, cursor: "pointer" }}>
                        <strong>{m.name}, {m.vorname}</strong>
                        <div style={{ fontSize: "11px", color: "#666" }}>üìû {m.tel} | ‚úâÔ∏è {m.mail}</div>
                      </div>
                      <div style={{ position: "relative" }}>
                        <button style={styles.btnDots} onClick={() => setOpenActionMenuId(openActionMenuId === m.id ? null : m.id)}>‚ãÆ</button>
                        {openActionMenuId === m.id && (
                          <div style={styles.actionMenu}>
                            <div style={styles.menuItem} onClick={() => { setActiveMember(m); setView("akte"); setOpenActionMenuId(null); }}>üìã Akte</div>
                            <div style={styles.menuItem} onClick={() => { setFormularVersandDialogNeu({ member: m, formTyp: "stammdaten" }); setOpenActionMenuId(null); }}>‚úâÔ∏è Formular senden</div>
                            <div style={styles.menuItem} onClick={() => { setActiveMember(m); setView("berechnung"); setBerechnungRechner(null); setBerechnungKategorie(null); setOpenActionMenuId(null); }}>üßÆ Berechnung</div>
                            <div style={styles.menuItem} onClick={() => setOpenActionMenuId(null)}>‚ùå Schlie√üen</div>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* FORMULARE + EINGANG */}
            <div style={styles.card}>
              <div onClick={() => setShowFormulare(!showFormulare)} style={styles.reiterHeader}>
                <div style={{ display:"flex", alignItems:"center", gap:"8px" }}>
                  <h3 style={{ margin:0, fontSize:"14px" }}>üìÑ Formulare</h3>
                  {eingangFormulare.length > 0 && (
                    <span style={{ backgroundColor:"#e53935", color:"#fff", borderRadius:"50%", width:"18px", height:"18px", fontSize:"10px", fontWeight:"bold", display:"flex", alignItems:"center", justifyContent:"center" }}>{eingangFormulare.length}</span>
                  )}
                </div>
                <span>{showFormulare ? "‚ñ≤" : "‚ñº"}</span>
              </div>
              {showFormulare && (
                <div style={{ marginTop:"10px" }}>
                  {[
                    { id:"stammdaten", label:"üìã Stammdaten-Fragebogen", desc:"Pers√∂nliche Daten, Einkommen, Wohnen" },
                    { id:"tbg", label:"üìã Anlage TBG (B√ºrgergeld)", desc:"Tempor√§re Bedarfsgemeinschaft" },
                  ].map(function(f) {
                    return (
                      <div key={f.id} style={{ backgroundColor:"#f9f9f9", borderRadius:"8px", padding:"12px", marginBottom:"8px", borderLeft:"4px solid #003366" }}>
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                          <div>
                            <div style={{ fontWeight:"bold", fontSize:"13px" }}>{f.label}</div>
                            <div style={{ fontSize:"10px", color:"#999", marginTop:"2px" }}>{f.desc}</div>
                          </div>
                          <div style={{ display:"flex", gap:"6px" }}>
                            <button
                              onClick={function() { setView(f.id === "stammdaten" ? "formular_ausfuellen" : "tbg_form"); if(f.id === "stammdaten") setFormFelderDaten({}); }}
                              style={{ backgroundColor:"#e8f0fb", color:"#003366", border:"none", cursor:"pointer", fontSize:"11px", fontWeight:"bold", padding:"5px 10px", borderRadius:"5px" }}>
                              √ñffnen
                            </button>
                            <button
                              onClick={function() { setFormularVersandDialogNeu({ member: null, formTyp: f.id }); }}
                              style={{ backgroundColor:"#003366", color:"#fff", border:"none", cursor:"pointer", fontSize:"11px", fontWeight:"bold", padding:"5px 10px", borderRadius:"5px" }}>
                              üì§ Senden
                            </button>
                          </div>
                        </div>
                        {versandMail[f.id + "_sendDialog"] && (
                          <div style={{ marginTop:"10px", backgroundColor:"#e8f0fb", borderRadius:"6px", padding:"10px" }}>
                            <div style={{ fontSize:"11px", color:"#555", marginBottom:"6px", fontWeight:"bold" }}>‚úâÔ∏è An welche E-Mail-Adresse senden?</div>
                            <div style={{ display:"flex", gap:"6px" }}>
                              <input
                                style={{ flex:1, padding:"7px 10px", border:"1px solid #ddd", borderRadius:"6px", fontSize:"12px", boxSizing:"border-box" }}
                                placeholder="empfaenger@beispiel.de"
                                value={versandMail[f.id + "_sendMail"] || ""}
                                onChange={function(e) { setVersandMail(function(prev) { return Object.assign({}, prev, {[f.id + "_sendMail"]: e.target.value}); }); }}
                                autoFocus
                              />
                              <button
                                onClick={function() {
                                  var mail = (versandMail[f.id + "_sendMail"] || "").trim();
                                  if (!mail.includes("@")) { return; }
                                  var jetzt = new Date();
                                  var ds = jetzt.toLocaleDateString("de-DE") + " " + String(jetzt.getHours()).padStart(2,"0") + ":" + String(jetzt.getMinutes()).padStart(2,"0");
                                  var formLabel = f.label.replace("üìã ", "");
                                  setAusgangFormulare(function(prev) {
                                    return prev.concat([{ id: Date.now(), typ: formLabel, empfaenger: mail, mitglied: null, datum: ds, status: "unbeantwortet", kanal: "‚úâÔ∏è E-Mail", vorausgefuellt: false }]);
                                  });
                                  setVersandMail(function(prev) { return Object.assign({}, prev, {[f.id + "_sendDialog"]: false, [f.id + "_sendMail"]: "", [f.id + "_gesendet"]: mail}); });
                                  setShowAusgang(true);
                                }}
                                style={{ backgroundColor:"#003366", color:"#fff", border:"none", borderRadius:"6px", padding:"7px 12px", fontSize:"12px", cursor:"pointer", fontWeight:"bold" }}>
                                ‚úì Senden
                              </button>
                              <button
                                onClick={function() { setVersandMail(function(prev) { return Object.assign({}, prev, {[f.id + "_sendDialog"]: false}); }); }}
                                style={{ backgroundColor:"#eee", color:"#333", border:"none", borderRadius:"6px", padding:"7px 10px", fontSize:"12px", cursor:"pointer" }}>
                                ‚úï
                              </button>
                            </div>
                            {versandMail[f.id + "_sendMail"] && !versandMail[f.id + "_sendMail"].includes("@") && (
                              <div style={{ fontSize:"10px", color:"#e53935", marginTop:"4px" }}>Bitte g√ºltige E-Mail-Adresse eingeben.</div>
                            )}
                          </div>
                        )}
                        {versandMail[f.id + "_gesendet"] && !versandMail[f.id + "_sendDialog"] && (
                          <div style={{ marginTop:"8px", backgroundColor:"#e8f5e9", borderRadius:"6px", padding:"8px 10px", fontSize:"11px", color:"#2e7d32" }}>
                            ‚úÖ Gesendet an {versandMail[f.id + "_gesendet"]} ¬∑ im Ausgang als <strong>unbeantwortet</strong> gespeichert
                          </div>
                        )}
                      </div>
                    );
                  })}

                  {/* EINGANG FORMULARE ‚Äì Unterkategorie */}
                  <div style={{ marginTop:"14px", borderTop:"2px solid #e8f0fb", paddingTop:"12px" }}>
                    <div onClick={() => setShowEingang(!showEingang)}
                      style={{ display:"flex", justifyContent:"space-between", alignItems:"center", cursor:"pointer", padding:"6px 0", marginBottom: showEingang ? "8px" : "0" }}>
                      <div style={{ display:"flex", alignItems:"center", gap:"8px" }}>
                        <span style={{ fontSize:"13px", fontWeight:"bold", color:"#003366" }}>üì• Eingang Formulare</span>
                        {eingangFormulare.length > 0 && (
                          <span style={{ backgroundColor:"#e53935", color:"#fff", borderRadius:"50%", width:"18px", height:"18px", fontSize:"10px", fontWeight:"bold", display:"flex", alignItems:"center", justifyContent:"center" }}>{eingangFormulare.length}</span>
                        )}
                      </div>
                      <span style={{ fontSize:"11px", color:"#999" }}>{showEingang ? "‚ñ≤" : "‚ñº"}</span>
                    </div>
                    {showEingang && (
                      <div>
                        {sbReady() && (
                          <button onClick={sbLadeEingaenge} style={{ width:"100%", padding:"8px", backgroundColor:"#e8f0fb", color:"#003366", border:"1px solid #003366", borderRadius:"7px", cursor:"pointer", fontWeight:"bold", fontSize:"11px", marginBottom:"10px" }}>
                            üîÑ Neue Eing√§nge von Supabase abrufen
                          </button>
                        )}
                        {eingangFormulare.length === 0 && (
                          <div style={{ fontSize:"12px", color:"#999", textAlign:"center", padding:"12px 0" }}>Keine eingegangenen Formulare.</div>
                        )}
                        {eingangFormulare.map(f => (
                          <div key={f.id} style={{ backgroundColor:"#f0fdfd", borderRadius:"8px", padding:"12px", marginBottom:"8px", borderLeft:"4px solid #00afad" }}>
                            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
                              <div>
                                <div style={{ fontWeight:"bold", fontSize:"13px" }}>{f.typ}</div>
                                <div style={{ fontSize:"11px", color:"#666", marginTop:"2px" }}>Von: {f.name}</div>
                                <div style={{ fontSize:"10px", color:"#999", marginTop:"1px" }}>{f.datum}</div>
                              </div>
                              <button
                                onClick={() => { setAktivesEingangFormular(f); setView("eingang_detail"); }}
                                style={{ backgroundColor:"#00afad", color:"#fff", border:"none", borderRadius:"6px", padding:"6px 12px", fontSize:"11px", cursor:"pointer", fontWeight:"bold" }}>
                                √ñffnen
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* AUSGANG ‚Äì Unterkategorie */}
                  <div style={{ marginTop:"14px", borderTop:"2px solid #e8f0fb", paddingTop:"12px" }}>
                    <div onClick={() => setShowAusgang(!showAusgang)}
                      style={{ display:"flex", justifyContent:"space-between", alignItems:"center", cursor:"pointer", padding:"6px 0", marginBottom: showAusgang ? "8px" : "0" }}>
                      <div style={{ display:"flex", alignItems:"center", gap:"8px" }}>
                        <span style={{ fontSize:"13px", fontWeight:"bold", color:"#003366" }}>üì§ Ausgang Formulare</span>
                        {ausgangFormulare.filter(function(a){ return a.status === "unbeantwortet"; }).length > 0 && (
                          <span style={{ backgroundColor:"#f57c00", color:"#fff", borderRadius:"50%", width:"18px", height:"18px", fontSize:"10px", fontWeight:"bold", display:"flex", alignItems:"center", justifyContent:"center" }}>
                            {ausgangFormulare.filter(function(a){ return a.status === "unbeantwortet"; }).length}
                          </span>
                        )}
                      </div>
                      <span style={{ fontSize:"11px", color:"#999" }}>{showAusgang ? "‚ñ≤" : "‚ñº"}</span>
                    </div>
                    {showAusgang && (
                      <div>
                        {ausgangFormulare.length === 0 && (
                          <div style={{ fontSize:"12px", color:"#999", textAlign:"center", padding:"12px 0" }}>Keine gesendeten Formulare.</div>
                        )}
                        {ausgangFormulare.map(function(af) {
                          var statusFarbe = af.status === "unbeantwortet" ? "#f57c00" : af.status === "geoeffnet" ? "#1565c0" : "#2e7d32";
                          var statusBg = af.status === "unbeantwortet" ? "#fff3e0" : af.status === "geoeffnet" ? "#e3f2fd" : "#e8f5e9";
                          var statusLabel = af.status === "unbeantwortet" ? "unbeantwortet" : af.status === "geoeffnet" ? "ge√∂ffnet" : "beantwortet";
                          var statusIcon = af.status === "unbeantwortet" ? "‚è≥" : af.status === "geoeffnet" ? "üëÅ" : "‚úÖ";
                          return (
                            <div key={af.id} style={{ backgroundColor:"#fafafa", borderRadius:"8px", padding:"12px", marginBottom:"8px", borderLeft:"4px solid " + statusFarbe }}>
                              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
                                <div style={{ flex:1 }}>
                                  <div style={{ fontWeight:"bold", fontSize:"13px" }}>{af.typ}</div>
                                  <div style={{ fontSize:"11px", color:"#666", marginTop:"2px" }}>An: {af.empfaenger} {af.kanal && <span style={{ backgroundColor:"#e8f0fb", color:"#003366", borderRadius:"4px", padding:"1px 5px", fontSize:"10px", marginLeft:"4px" }}>{af.kanal}</span>}</div>
                                  {af.mitglied && <div style={{ fontSize:"11px", color:"#666" }}>Mitglied: {af.mitglied}</div>}
                                  <div style={{ fontSize:"10px", color:"#999", marginTop:"1px" }}>Gesendet: {af.datum}</div>
                                  {af.formLink && <div style={{ fontSize:"10px", color:"#00afad", marginTop:"3px", wordBreak:"break-all" }}>üîó {af.formLink}</div>}
                                </div>
                                <span style={{ backgroundColor:statusBg, color:statusFarbe, borderRadius:"12px", padding:"3px 8px", fontSize:"10px", fontWeight:"bold", whiteSpace:"nowrap", marginLeft:"8px" }}>
                                  {statusIcon} {statusLabel}
                                </span>
                              </div>
                              <div style={{ display:"flex", gap:"6px", marginTop:"8px" }}>
                                <button onClick={function() {
                                  setAusgangFormulare(function(prev) {
                                    return prev.map(function(x) {
                                      if (x.id !== af.id) return x;
                                      var next = x.status === "unbeantwortet" ? "geoeffnet" : x.status === "geoeffnet" ? "beantwortet" : "unbeantwortet";
                                      return Object.assign({}, x, { status: next });
                                    });
                                  });
                                }} style={{ fontSize:"11px", padding:"4px 10px", border:"1px solid #ddd", borderRadius:"5px", cursor:"pointer", backgroundColor:"#fff", color:"#333" }}>
                                  Status √§ndern
                                </button>
                                <button onClick={function() {
                                  setAusgangFormulare(function(prev) { return prev.filter(function(x) { return x.id !== af.id; }); });
                                }} style={{ fontSize:"11px", padding:"4px 10px", border:"1px solid #ffcdd2", borderRadius:"5px", cursor:"pointer", backgroundColor:"#fff", color:"#e53935" }}>
                                  L√∂schen
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>

                </div>
              )}
            </div>

            {/* KALENDER */}
            <div style={styles.card}>
              <div onClick={() => setShowCalendar(!showCalendar)} style={styles.reiterHeader}>
                <h3 style={{ margin: 0, fontSize: "14px" }}>üìÖ Kalender & Termine</h3><span>{showCalendar ? "‚ñ≤" : "‚ñº"}</span>
              </div>
              {showCalendar && (
                <div style={{ marginTop: "10px" }}>
                  <div style={styles.calHeader}>
                    <button onClick={() => setMonthOffset(monthOffset - 1)} style={styles.btnCal}>‚Äπ</button>
                    <strong>{new Date(2026, monthOffset).toLocaleString("de-DE", { month: "long" })}</strong>
                    <button onClick={() => setMonthOffset(monthOffset + 1)} style={styles.btnCal}>‚Ä∫</button>
                  </div>
                  {newTerminDialog && (
                    <div style={{ backgroundColor: "#f0fdfd", border: "1px solid #00afad", borderRadius: "8px", padding: "10px", marginBottom: "10px" }}>
                      <div style={{ fontSize: "12px", fontWeight: "bold", marginBottom: "6px" }}>Neuer Termin am {newTerminDialog.day}.{monthOffset + 1}.:</div>
                      <input style={{ ...styles.input, marginBottom: "6px" }} placeholder="Terminbezeichnung..." value={newTerminDialog.text} autoFocus onChange={e => setNewTerminDialog({ ...newTerminDialog, text: e.target.value })} onKeyDown={e => { if (e.key === "Enter") confirmAddTermin(); if (e.key === "Escape") setNewTerminDialog(null); }} />
                      <div style={{ display: "flex", gap: "8px" }}>
                        <button onClick={confirmAddTermin} style={{ ...styles.btnPrimary, width: "auto", padding: "6px 14px", fontSize: "12px" }}>‚úì Speichern</button>
                        <button onClick={() => setNewTerminDialog(null)} style={{ ...styles.btnSecondary, padding: "6px 14px", fontSize: "12px" }}>Abbrechen</button>
                      </div>
                    </div>
                  )}
                  <div style={styles.dayGrid}>
                    {[...Array(new Date(2026, monthOffset + 1, 0).getDate())].map((_, i) => {
                      const day = i + 1;
                      const hasTermin = termine.some(t => t.tag === day && t.monat === monthOffset);
                      return (<div key={i} onClick={() => handleAddTermin(day)} style={{ ...styles.day, backgroundColor: hasTermin ? "#00afad" : "#eee", color: hasTermin ? "#fff" : "#333" }}>{day}</div>);
                    })}
                  </div>
                  <div style={{ marginTop: "15px", borderTop: "1px solid #eee", paddingTop: "10px" }}>
                    <h4 style={{ fontSize: "12px", color: "#003366", margin: "0 0 8px 0" }}>Bevorstehende Termine:</h4>
                    {termine.filter(t => t.monat === monthOffset).map(t => (
                      <div key={t.id} onClick={() => { setSelectedTerminId(t.id); setView("termin_detail"); }} style={styles.terminItem}>
                        <span style={styles.terminTag}>{t.tag}.</span>
                        <span style={{ flex: 1 }}>{t.text}</span>
                        <span style={{ fontSize: "10px", color: "#999" }}>{t.zeit} Uhr</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* RECHNER */}
            <div style={styles.card}>
              <div onClick={() => setShowRechner(!showRechner)} style={styles.reiterHeader}>
                <h3 style={{ margin: 0, fontSize: "14px" }}>üßÆ Rechner</h3><span>{showRechner ? "‚ñ≤" : "‚ñº"}</span>
              </div>
              {showRechner && <div style={{ marginTop: "10px" }}><RechnerReiter /></div>}
            </div>
          </div>
        )}

        {/* TERMIN-DETAILS */}
        {view === "termin_detail" && activeTermin && (
          <div style={styles.formPage}>
            <button onClick={() => setView("dashboard")} style={styles.btnBack}>‚Äπ Zur√ºck</button>
            <h2 style={{ color: "#003366", fontSize: "18px" }}>Termin bearbeiten</h2>
            <div style={styles.formSection}>
              <label style={styles.label}>Titel:</label>
              <input style={styles.input} value={activeTermin.text} onChange={e => updateTermin(activeTermin.id, "text", e.target.value)} />
              <label style={styles.label}>Uhrzeit:</label>
              <input style={styles.input} type="time" value={activeTermin.zeit} onChange={e => updateTermin(activeTermin.id, "zeit", e.target.value)} />
              <label style={styles.label}>Gespr√§chsnotizen:</label>
              <textarea style={{ ...styles.input, height: "120px" }} value={activeTermin.notiz} placeholder="Notizen hier eintragen..." onChange={e => updateTermin(activeTermin.id, "notiz", e.target.value)} />
            </div>
            <button style={{ ...styles.btnPrimary, background: "#d9534f" }} onClick={() => { setTermine(termine.filter(t => t.id !== activeTermin.id)); setView("dashboard"); }}>Termin l√∂schen</button>
          </div>
        )}

        {/* MITGLIEDER-AKTE */}
        {view === "akte" && activeMember && (
          <div style={styles.formPage}>
            <button onClick={() => { setView("dashboard"); setShowMehrDaten(false); }} style={styles.btnBack}>‚Äπ Zur√ºck</button>
            <h2 style={{ color: "#003366", marginBottom: "4px" }}>Mitglieder-Stammdaten</h2>
            <div style={styles.dataRow}><span>Vorname:</span><strong>{activeMember.vorname}</strong></div>
            <div style={styles.dataRow}><span>Nachname:</span><strong>{activeMember.name}</strong></div>
            <div style={styles.dataRow}><span>Telefon:</span><strong>{activeMember.tel}</strong></div>
            <div style={styles.dataRow}><span>E-Mail:</span><strong>{activeMember.mail}</strong></div>
            <div style={styles.dataRow}><span>Stra√üe:</span><strong>{activeMember.strasse}</strong></div>
            <div style={styles.dataRow}><span>PLZ/Ort:</span><strong>{activeMember.plz} {activeMember.ort}</strong></div>
            <button onClick={() => setShowMehrDaten(!showMehrDaten)}
              style={{ width:"100%", marginTop:"14px", padding:"10px", backgroundColor: showMehrDaten ? "#003366" : "#f0f4f7", color: showMehrDaten ? "#fff" : "#003366", border:"1px solid #003366", borderRadius:"8px", cursor:"pointer", fontWeight:"bold", fontSize:"13px" }}>
              {showMehrDaten ? "‚ñ≤ Mehr Daten ausblenden" : "‚ñº Mehr Daten"}
            </button>
            {showMehrDaten && memberExtras[activeMember.id] && (
              <MehrDatenView ext={memberExtras[activeMember.id]} />
            )}

            {memberErgebnisse[activeMember.id] && memberErgebnisse[activeMember.id].length > 0 && (
              <div style={{ marginTop:"14px" }}>
                <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginBottom:"8px", letterSpacing:"0.5px" }}>
                  üßÆ Letzte Berechnungen
                </div>
                {[...memberErgebnisse[activeMember.id]].reverse().map((e, i) => (
                  <div key={i} style={{ backgroundColor: i===0 ? "#f0fdfd" : "#f9f9f9", border: i===0 ? "1px solid #00afad" : "1px solid #eee", borderRadius:"8px", padding:"10px", marginBottom:"6px" }}>
                    <div style={{ display:"flex", justifyContent:"space-between", marginBottom:"4px" }}>
                      <strong style={{ fontSize:"12px", color:"#003366" }}>{e.typ}</strong>
                      <span style={{ fontSize:"10px", color:"#999" }}>{e.datum}</span>
                    </div>
                    <div style={{ fontSize:"13px", fontWeight:"bold", color:"#00afad" }}>{e.ergebnis}</div>
                    {e.details && <div style={{ fontSize:"11px", color:"#666", marginTop:"3px" }}>{e.details}</div>}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* BERECHNUNG ‚Äì Rechnerauswahl */}
        {view === "berechnung" && activeMember && !berechnungRechner && (
          <div style={styles.formPage}>
            <button onClick={() => { setView("dashboard"); setBerechnungKategorie(null); }} style={styles.btnBack}>‚Äπ Zur√ºck</button>
            <div style={{ display:"flex", alignItems:"center", gap:"10px", marginBottom:"14px" }}>
              <div style={{ width:"40px", height:"40px", backgroundColor:"#003366", borderRadius:"50%", display:"flex", alignItems:"center", justifyContent:"center", color:"#fff", fontWeight:"bold", fontSize:"15px" }}>
                {activeMember.vorname[0]}{activeMember.name[0]}
              </div>
              <div>
                <div style={{ fontWeight:"bold", fontSize:"14px" }}>{activeMember.name}, {activeMember.vorname}</div>
                <div style={{ fontSize:"11px", color:"#666" }}>Bekannte Daten werden automatisch √ºbernommen</div>
              </div>
            </div>

            {!berechnungKategorie && (
              <div style={{ display:"flex", flexDirection:"column", gap:"8px" }}>
                <div onClick={() => setBerechnungKategorie("familie")}
                  style={{ padding:"14px", backgroundColor:"#f9f9f9", borderRadius:"10px", cursor:"pointer", borderLeft:"4px solid #003366", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                  <div><strong style={{ fontSize:"13px" }}>‚öñÔ∏è Familienrecht</strong><div style={{ fontSize:"10px", color:"#aaa", marginTop:"2px" }}>Kindes-, Trennungs-, nachehelicher Unterhalt</div></div>
                  <span style={{ color:"#00afad" }}>‚Ä∫</span>
                </div>
                <div onClick={() => setBerechnungKategorie("sozial")}
                  style={{ padding:"14px", backgroundColor:"#f9f9f9", borderRadius:"10px", cursor:"pointer", borderLeft:"4px solid #00afad", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                  <div><strong style={{ fontSize:"13px" }}>üèõÔ∏è Sozialrecht</strong><div style={{ fontSize:"10px", color:"#aaa", marginTop:"2px" }}>Mehrbedarf, TBG, Wohngeld</div></div>
                  <span style={{ color:"#00afad" }}>‚Ä∫</span>
                </div>
              </div>
            )}

            {berechnungKategorie === "familie" && (
              <div>
                <button onClick={() => { setBerechnungKategorie(null); setOpenRechnerMenuId(null); }} style={{ background:"none", border:"none", color:"#00afad", cursor:"pointer", fontWeight:"bold", marginBottom:"10px", padding:0 }}>‚Äπ Kategorien</button>
                <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", marginBottom:"8px" }}>‚öñÔ∏è Familienrecht</div>
                {[
                  { id:"kindes", label:"‚öñÔ∏è Kindesunterhalt", desc:"D√ºsseldorfer Tabelle" },
                  { id:"trennung", label:"üë´ Trennungsunterhalt", desc:"¬ß 1361 BGB" },
                  { id:"nachehelich", label:"üíç Nachehelicher Unterhalt", desc:"¬ß¬ß 1569 ff. BGB" },
                ].map(r => (
                  <div key={r.id} style={{ position:"relative", marginBottom:"8px" }}>
                    <div style={{ padding:"12px", backgroundColor:"#f9f9f9", borderRadius:"8px", borderLeft:"4px solid #003366", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                      <div onClick={() => { setBerechnungRechner(r.id); setOpenRechnerMenuId(null); }} style={{ flex:1, cursor:"pointer" }}>
                        <strong style={{ fontSize:"13px" }}>{r.label}</strong>
                        <div style={{ fontSize:"10px", color:"#999" }}>{r.desc}</div>
                      </div>
                      <button onClick={e => { e.stopPropagation(); setOpenRechnerMenuId(openRechnerMenuId === r.id ? null : r.id); }}
                        style={{ background:"none", border:"none", cursor:"pointer", fontSize:"18px", color:"#666", padding:"0 4px", lineHeight:1, fontWeight:"bold" }}>‚ãÆ</button>
                    </div>
                    {openRechnerMenuId === r.id && (
                      <div style={{ position:"absolute", right:0, top:"100%", backgroundColor:"#fff", border:"1px solid #ddd", borderRadius:"8px", boxShadow:"0 4px 12px rgba(0,0,0,0.12)", zIndex:100, minWidth:"170px", overflow:"hidden" }}>
                        <div onClick={() => { setBerechnungRechner(r.id); setOpenRechnerMenuId(null); }}
                          style={{ padding:"10px 14px", cursor:"pointer", fontSize:"13px", borderBottom:"1px solid #f0f0f0" }}>üßÆ Rechner √∂ffnen</div>
                        <div onClick={() => { alert("Link zum Rechner " + r.label + " wird an " + activeMember.mail + " gesendet."); setOpenRechnerMenuId(null); }}
                          style={{ padding:"10px 14px", cursor:"pointer", fontSize:"13px", borderBottom:"1px solid #f0f0f0" }}>üîó Link senden</div>
                        <div onClick={() => setOpenRechnerMenuId(null)}
                          style={{ padding:"10px 14px", cursor:"pointer", fontSize:"13px", color:"#999" }}>‚ùå Schlie√üen</div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}

            {berechnungKategorie === "sozial" && (
              <div>
                <button onClick={() => { setBerechnungKategorie(null); setOpenRechnerMenuId(null); }} style={{ background:"none", border:"none", color:"#00afad", cursor:"pointer", fontWeight:"bold", marginBottom:"10px", padding:0 }}>‚Äπ Kategorien</button>
                <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", marginBottom:"8px" }}>üèõÔ∏è Sozialrecht</div>
                {[
                  { id:"mbAlleinerziehende", label:"üë®‚Äçüëß Mehrbedarf Alleinerziehende", desc:"¬ß 21 Abs.3 SGB II" },
                  { id:"mbUmgang", label:"üöó Mehrbedarf Umgangskosten", desc:"¬ß 21 SGB II" },
                  { id:"tbg", label:"üè† Temp. Bedarfsgemeinschaft", desc:"SGB II" },
                  { id:"wohngeld", label:"üè° Wohngeld", desc:"WoGG" },
                ].map(r => (
                  <div key={r.id} style={{ position:"relative", marginBottom:"8px" }}>
                    <div style={{ padding:"12px", backgroundColor:"#f9f9f9", borderRadius:"8px", borderLeft:"4px solid #00afad", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                      <div onClick={() => { setBerechnungRechner(r.id); setOpenRechnerMenuId(null); }} style={{ flex:1, cursor:"pointer" }}>
                        <strong style={{ fontSize:"13px" }}>{r.label}</strong>
                        <div style={{ fontSize:"10px", color:"#999" }}>{r.desc}</div>
                      </div>
                      <button onClick={e => { e.stopPropagation(); setOpenRechnerMenuId(openRechnerMenuId === r.id ? null : r.id); }}
                        style={{ background:"none", border:"none", cursor:"pointer", fontSize:"18px", color:"#666", padding:"0 4px", lineHeight:1, fontWeight:"bold" }}>‚ãÆ</button>
                    </div>
                    {openRechnerMenuId === r.id && (
                      <div style={{ position:"absolute", right:0, top:"100%", backgroundColor:"#fff", border:"1px solid #ddd", borderRadius:"8px", boxShadow:"0 4px 12px rgba(0,0,0,0.12)", zIndex:100, minWidth:"170px", overflow:"hidden" }}>
                        <div onClick={() => { setBerechnungRechner(r.id); setOpenRechnerMenuId(null); }}
                          style={{ padding:"10px 14px", cursor:"pointer", fontSize:"13px", borderBottom:"1px solid #f0f0f0" }}>üßÆ Rechner √∂ffnen</div>
                        <div onClick={() => { alert("Link zum Rechner " + r.label + " wird an " + activeMember.mail + " gesendet."); setOpenRechnerMenuId(null); }}
                          style={{ padding:"10px 14px", cursor:"pointer", fontSize:"13px", borderBottom:"1px solid #f0f0f0" }}>üîó Link senden</div>
                        <div onClick={() => setOpenRechnerMenuId(null)}
                          style={{ padding:"10px 14px", cursor:"pointer", fontSize:"13px", color:"#999" }}>‚ùå Schlie√üen</div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* BERECHNUNG ‚Äì Rechner mit vorausgef√ºllten Daten */}
        {view === "berechnung" && activeMember && berechnungRechner && (
          <div style={styles.formPage}>
            <button onClick={() => setBerechnungRechner(null)} style={styles.btnBack}>‚Äπ Rechnerauswahl</button>
            <div style={{ backgroundColor:"#e8f4fd", border:"1px solid #bee5f8", borderRadius:"8px", padding:"8px 12px", marginBottom:"12px", fontSize:"11px", color:"#0c5460", display:"flex", alignItems:"center", gap:"6px" }}>
              <span>üë§</span><strong>{activeMember.name}, {activeMember.vorname}</strong><span>‚Äì Daten automatisch √ºbernommen</span>
            </div>
            <BerechnungMitDaten
              rechner={berechnungRechner}
              member={activeMember}
              ext={memberExtras[activeMember.id] || null}
              onSaveData={(newFields) => {
                const mid = activeMember.id;
                setMemberExtras(prev => ({
                  ...prev,
                  [mid]: { ...(prev[mid] || {}), ...newFields }
                }));
              }}
              onSaveErgebnis={(ergebnis) => {
                const mid = activeMember.id;
                const jetzt = new Date().toLocaleDateString("de-DE", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
                setMemberErgebnisse(prev => ({
                  ...prev,
                  [mid]: [...(prev[mid] || []), { ...ergebnis, datum: jetzt }].slice(-5)
                }));
              }}
            />
          </div>
        )}

        {/* NEUES MITGLIED */}
        {view === "neues_mitglied" && (
          <div style={styles.formPage}>
            <button onClick={() => { setView("dashboard"); setNeuesMitglied({ vorname:"", name:"", tel:"", mail:"", strasse:"", plz:"", ort:"" }); }} style={styles.btnBack}>‚Äπ Abbrechen</button>
            <h2 style={{ color:"#003366", marginBottom:"14px" }}>üë§ Neues Mitglied anlegen</h2>
            <label style={styles.label}>Nachname *</label>
            <input style={styles.input} placeholder="Nachname" value={neuesMitglied.name} onChange={e => setNeuesMitglied({...neuesMitglied, name: e.target.value})} />
            <label style={styles.label}>Vorname *</label>
            <input style={styles.input} placeholder="Vorname" value={neuesMitglied.vorname} onChange={e => setNeuesMitglied({...neuesMitglied, vorname: e.target.value})} />
            <label style={styles.label}>Telefon</label>
            <input style={styles.input} placeholder="z.B. 0170 1234567" value={neuesMitglied.tel} onChange={e => setNeuesMitglied({...neuesMitglied, tel: e.target.value})} />
            <label style={styles.label}>E-Mail</label>
            <input style={styles.input} placeholder="name@beispiel.de" value={neuesMitglied.mail} onChange={e => setNeuesMitglied({...neuesMitglied, mail: e.target.value})} />
            <label style={styles.label}>Stra√üe & Hausnummer</label>
            <input style={styles.input} placeholder="Musterstra√üe 1" value={neuesMitglied.strasse} onChange={e => setNeuesMitglied({...neuesMitglied, strasse: e.target.value})} />
            <div style={{ display:"flex", gap:"10px" }}>
              <div style={{ width:"90px" }}>
                <label style={styles.label}>PLZ</label>
                <input style={styles.input} placeholder="12345" value={neuesMitglied.plz} onChange={e => setNeuesMitglied({...neuesMitglied, plz: e.target.value})} />
              </div>
              <div style={{ flex:1 }}>
                <label style={styles.label}>Ort</label>
                <input style={styles.input} placeholder="Stadt" value={neuesMitglied.ort} onChange={e => setNeuesMitglied({...neuesMitglied, ort: e.target.value})} />
              </div>
            </div>
            <button
              disabled={!neuesMitglied.name.trim() || !neuesMitglied.vorname.trim()}
              onClick={() => {
                const neu = { ...neuesMitglied, id: Date.now() };
                setMembers(prev => [...prev, neu]);
                setNeuesMitglied({ vorname:"", name:"", tel:"", mail:"", strasse:"", plz:"", ort:"" });
                setView("dashboard");
                setShowMemberList(true);
              }}
              style={{ ...styles.btnPrimary, marginTop:"10px", opacity: (!neuesMitglied.name.trim() || !neuesMitglied.vorname.trim()) ? 0.5 : 1 }}>
              ‚úì Mitglied speichern
            </button>
          </div>
        )}

        {/* FORMULAR VERSAND DIALOG */}
        {formulareVersandDialog && (
          <div style={{ position:"fixed", top:0, left:0, right:0, bottom:0, backgroundColor:"rgba(0,0,0,0.5)", zIndex:200, display:"flex", alignItems:"center", justifyContent:"center", padding:"20px" }}>
            <div style={{ backgroundColor:"#fff", borderRadius:"12px", padding:"20px", width:"100%", maxWidth:"420px", maxHeight:"90vh", overflowY:"auto" }}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"16px" }}>
                <div style={{ fontWeight:"bold", fontSize:"15px", color:"#003366" }}>‚úâÔ∏è Formular senden</div>
                <button onClick={() => setFormulareVersandDialog(null)} style={{ background:"none", border:"none", fontSize:"20px", cursor:"pointer", color:"#999" }}>√ó</button>
              </div>
              <div style={{ backgroundColor:"#e8f0fb", borderRadius:"8px", padding:"10px 12px", marginBottom:"14px", fontSize:"12px" }}>
                <strong>Mitglied:</strong> {formulareVersandDialog.member.vorname} {formulareVersandDialog.member.name}<br/>
                <strong>E-Mail:</strong> {formulareVersandDialog.member.mail}
              </div>
              <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"8px" }}>Formular ausw√§hlen:</div>
              {[
                { id:"stammdaten", label:"Stammdaten-Fragebogen" },
                { id:"tbg", label:"Anlage TBG (B√ºrgergeld)" },
              ].map(function(fTyp) {
                return (
                  <button key={fTyp.id}
                    onClick={function() {
                      var m = formulareVersandDialog.member;
                      var ext = formulareVersandDialog.ext;
                      // Pre-fill formFelderDaten with member data from Akte
                      setFormFelderDaten({
                        _formTyp: fTyp.id,
                        _formLabel: fTyp.label.replace("üìã ", ""),
                        _vorausgefuellt: true,
                        _mitglied: m.vorname + " " + m.name,
                        vorname: m.vorname || "",
                        name: m.name || "",
                        tel: m.tel || "",
                        mail: m.mail || "",
                        strasse: m.strasse || "",
                        plz: m.plz || "",
                        ort: m.ort || "",
                        familienstand: ext.familienstand || "",
                        einkommenNetto: ext.einkommenNetto ? String(ext.einkommenNetto) : "",
                        mieteWarm: ext.mieteWarm ? String(ext.mieteWarm) : "",
                        hatKinder: (ext.kinder && ext.kinder.length > 0) ? "ja" : "",
                        kinder: (ext.kinder || []).map(function(k) {
                          return { vorname: (k.name||"").split(", ")[1]||"", nachname: (k.name||"").split(", ")[0]||"", geburt: k.geburt||"", wohnort: k.wohnort||"", andererElternteil: "nein", uvg: k.uvg ? "ja" : "nein" };
                        }),
                      });
                      setFormulareVersandDialog(null);
                      setView("formular_ausfuellen");
                    }}
                    style={{ width:"100%", padding:"12px 14px", backgroundColor:"#f9f9f9", border:"1px solid #ddd", borderRadius:"8px", cursor:"pointer", textAlign:"left", fontSize:"13px", marginBottom:"8px", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                    <span>üìã {fTyp.label}</span>
                    <span style={{ color:"#003366", fontSize:"11px", fontWeight:"bold" }}>vorausgef√ºllt √∂ffnen ‚Üí</span>
                  </button>
                );
              })}
              <div style={{ backgroundColor:"#e8f5e9", border:"1px solid #a5d6a7", borderRadius:"8px", padding:"10px", marginTop:"8px", fontSize:"11px", color:"#2e7d32" }}>
                ‚úÖ Formular wird mit Aktendaten vorausgef√ºllt ¬∑ erscheint im Ausgang als <strong>unbeantwortet</strong>
              </div>
            </div>
          </div>
        )}

        {/* EINGANG FORMULAR DETAIL */}
        {view === "eingang_detail" && aktivesEingangFormular && (
          <div style={styles.formPage}>
            <button onClick={() => setView("dashboard")} style={styles.btnBack}>‚Äπ Zur√ºck</button>
            <div style={{ backgroundColor:"#00afad", color:"#fff", borderRadius:"10px", padding:"12px 16px", marginBottom:"14px" }}>
              <div style={{ fontWeight:"bold", fontSize:"14px" }}>{aktivesEingangFormular.typ}</div>
              <div style={{ fontSize:"11px", opacity:0.85, marginTop:"2px" }}>Von: {aktivesEingangFormular.name} ¬∑ {aktivesEingangFormular.datum}</div>
            </div>

            {/* Ausgef√ºllte Felder */}
            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginBottom:"10px", letterSpacing:"0.5px" }}>Ausgef√ºllte Felder</div>
            {Object.entries(aktivesEingangFormular.felder).map(function(entry) {
              var k = entry[0]; var v = entry[1];
              if (!v || k === "kinder" || k === "hatKinder") return null;
              var labels = { vorname:"Vorname", name:"Nachname", tel:"Telefon", mail:"E-Mail", strasse:"Stra√üe", plz:"PLZ", ort:"Ort", familienstand:"Familienstand", einkommenNetto:"Nettoeinkommen (‚Ç¨)", mieteWarm:"Miete warm (‚Ç¨)", notizen:"Notizen" };
              return (
                <div key={k} style={{ display:"flex", justifyContent:"space-between", padding:"7px 0", borderBottom:"1px solid #f5f5f5" }}>
                  <span style={{ color:"#666", fontSize:"12px" }}>{labels[k] || k}:</span>
                  <strong style={{ fontSize:"12px", maxWidth:"60%", textAlign:"right" }}>{String(v)}</strong>
                </div>
              );
            })}

            {/* Kinder */}
            {aktivesEingangFormular.felder.kinder && aktivesEingangFormular.felder.kinder.length > 0 && (
              <div style={{ marginTop:"10px" }}>
                <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginBottom:"8px", letterSpacing:"0.5px" }}>Kinder ({aktivesEingangFormular.felder.kinder.length})</div>
                {aktivesEingangFormular.felder.kinder.map(function(k, i) {
                  return (
                    <div key={i} style={{ backgroundColor:"#f9f9f9", borderRadius:"8px", padding:"10px", marginBottom:"8px", borderLeft:"3px solid #00afad" }}>
                      <div style={{ fontWeight:"bold", fontSize:"13px", marginBottom:"4px" }}>Kind {i+1}: {k.vorname} {k.nachname||""}</div>
                      {k.geburt && <div style={{ fontSize:"12px", color:"#555" }}>Geb.: {k.geburt}</div>}
                      {k.wohnort && <div style={{ fontSize:"12px", color:"#555" }}>Wohnort: {k.wohnort}</div>}
                      {k.andererElternteil === "ja" && k.epVorname && <div style={{ fontSize:"12px", color:"#555" }}>And. Elternteil: {k.epVorname} {k.epNachname||""}</div>}
                      {k.uvg && <div style={{ fontSize:"12px", color:"#555" }}>UVG: {k.uvg}</div>}
                    </div>
                  );
                })}
              </div>
            )}

            {/* √úbertragen in Akte */}
            <div style={{ marginTop:"16px" }}>
              <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"6px" }}>üìã In Mitgliederakte √ºbertragen:</div>
              {members.map(function(m) {
                return (
                  <button key={m.id}
                    onClick={function() {
                      var f = aktivesEingangFormular.felder;
                      var updates = {};
                      if (f.familienstand) updates.familienstand = f.familienstand;
                      if (f.einkommenNetto) updates.einkommenNetto = parseFloat(f.einkommenNetto);
                      if (f.mieteWarm) updates.mieteWarm = parseFloat(f.mieteWarm);
                      if (f.notizen) updates.notizen = f.notizen;
                      if (f.hatKinder === "nein") { updates.alleinerziehend = false; updates.kinder = []; }
                      if (f.kinder && f.kinder.length > 0) {
                        updates.alleinerziehend = true;
                        updates.kinder = f.kinder.map(function(k) {
                          var heute = new Date();
                          var geb = k.geburt ? new Date(k.geburt) : null;
                          var alterJahre = geb ? Math.floor((heute - geb) / (365.25*24*3600*1000)) : 0;
                          var alterGruppe = alterJahre >= 18 ? "18+ J." : alterJahre >= 12 ? "12-17 J." : alterJahre >= 6 ? "6-11 J." : "0-5 J.";
                          return { name: (k.nachname||f.name||"") + ", " + (k.vorname||""), geburt: k.geburt||"", alter: alterGruppe, wohnort: k.wohnort||"bei Antragsteller", uvg: k.uvg==="ja", kg: true, andererElternteil: k.andererElternteil==="ja" ? ((k.epVorname||"")+" "+(k.epNachname||"")).trim() : "" };
                        });
                      }
                      setMemberExtras(function(prev) {
                        var next = Object.assign({}, prev);
                        next[m.id] = Object.assign({}, prev[m.id] || {}, updates);
                        return next;
                      });
                      setEingangFormulare(function(prev) { return prev.filter(function(x) { return x.id !== aktivesEingangFormular.id; }); });
                      setActiveMember(m);
                      setView("akte");
                    }}
                    style={{ width:"100%", padding:"10px 14px", backgroundColor:"#f9f9f9", border:"1px solid #ddd", borderRadius:"8px", cursor:"pointer", textAlign:"left", fontSize:"13px", display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"6px" }}>
                    <span>üë§ {m.name}, {m.vorname}</span>
                    <span style={{ color:"#003366", fontSize:"11px", fontWeight:"bold" }}>‚Üí Akte √∂ffnen</span>
                  </button>
                );
              })}
            </div>

            {/* Weiterleiten an Rechner */}
            <div style={{ marginTop:"14px" }}>
              <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"6px" }}>üßÆ Direkt zu Berechnung weiterleiten:</div>
              {members.map(function(m) {
                return (
                  <button key={m.id}
                    onClick={function() {
                      var f = aktivesEingangFormular.felder;
                      var updates = {};
                      if (f.einkommenNetto) updates.einkommenNetto = parseFloat(f.einkommenNetto);
                      if (f.mieteWarm) updates.mieteWarm = parseFloat(f.mieteWarm);
                      if (f.familienstand) updates.familienstand = f.familienstand;
                      if (f.kinder && f.kinder.length > 0) {
                        updates.kinder = f.kinder.map(function(k) {
                          var heute = new Date(); var geb = k.geburt ? new Date(k.geburt) : null;
                          var j = geb ? Math.floor((heute-geb)/(365.25*24*3600*1000)) : 0;
                          return { name: (k.vorname||""), geburt: k.geburt||"", alter: j>=18?"18+ J.":j>=12?"12-17 J.":j>=6?"6-11 J.":"0-5 J.", wohnort: k.wohnort||"", uvg: k.uvg==="ja", kg: true };
                        });
                      }
                      setMemberExtras(function(prev) { var n=Object.assign({},prev); n[m.id]=Object.assign({},prev[m.id]||{},updates); return n; });
                      setActiveMember(m);
                      setBerechnungRechner(null);
                      setBerechnungKategorie(null);
                      setView("berechnung");
                    }}
                    style={{ width:"100%", padding:"10px 14px", backgroundColor:"#e8f4fd", border:"1px solid #bee5f8", borderRadius:"8px", cursor:"pointer", textAlign:"left", fontSize:"13px", display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"6px" }}>
                    <span>üßÆ {m.name}, {m.vorname}</span>
                    <span style={{ color:"#00afad", fontSize:"11px", fontWeight:"bold" }}>‚Üí Berechnung</span>
                  </button>
                );
              })}
            </div>

            {/* R√ºckantwort senden */}
            <div style={{ marginTop:"14px", backgroundColor:"#f0f4f7", borderRadius:"10px", padding:"12px" }}>
              <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"8px" }}>üí¨ R√ºckmeldung an Absender senden:</div>
              <div style={{ display:"flex", gap:"8px" }}>
                {aktivesEingangFormular.absender && (
                  <button
                    onClick={function() {
                      var betreff = encodeURIComponent("ISUV Anspruchslotse ‚Äì Ihr Formular wurde bearbeitet");
                      var body = encodeURIComponent("Sehr geehrte*r " + (aktivesEingangFormular.name || "Mitglied") + ",\n\nIhr Formular \"" + aktivesEingangFormular.typ + "\" wurde von uns erhalten und in Ihre Akte √ºbertragen.\n\nBei Fragen stehen wir gerne zur Verf√ºgung.\n\nMit freundlichen Gr√º√üen\n" + (loginDaten.leiter || "ISUV") + (loginDaten.ort ? " ¬∑ " + loginDaten.ort : ""));
                      window.open("mailto:" + aktivesEingangFormular.absender + "?subject=" + betreff + "&body=" + body);
                    }}
                    style={{ flex:1, padding:"9px", backgroundColor:"#003366", color:"#fff", border:"none", borderRadius:"7px", cursor:"pointer", fontWeight:"bold", fontSize:"11px" }}>
                    ‚úâÔ∏è Per E-Mail
                  </button>
                )}
                {loginDaten.whatsapp && aktivesEingangFormular.felder && aktivesEingangFormular.felder.tel && (
                  <button
                    onClick={function() {
                      var tel = aktivesEingangFormular.felder.tel.replace(/[\s\-()]/g,"");
                      var msg = encodeURIComponent("Hallo " + (aktivesEingangFormular.name || "") + ",\n\nIhr Formular \"" + aktivesEingangFormular.typ + "\" wurde erhalten und bearbeitet. Bei Fragen melden Sie sich gerne.\n\n" + (loginDaten.leiter || "ISUV") + (loginDaten.ort ? " ¬∑ " + loginDaten.ort : ""));
                      window.open("https://wa.me/" + tel.replace("+","") + "?text=" + msg);
                    }}
                    style={{ flex:1, padding:"9px", backgroundColor:"#25d366", color:"#fff", border:"none", borderRadius:"7px", cursor:"pointer", fontWeight:"bold", fontSize:"11px" }}>
                    üì± WhatsApp
                  </button>
                )}
              </div>
            </div>

            <button
              onClick={function() { setEingangFormulare(function(prev) { return prev.filter(function(x) { return x.id !== aktivesEingangFormular.id; }); }); setView("dashboard"); }}
              style={{ width:"100%", marginTop:"10px", padding:"10px", backgroundColor:"#d9534f", color:"#fff", border:"none", borderRadius:"8px", cursor:"pointer", fontWeight:"bold", fontSize:"13px" }}>
              üóëÔ∏è Formular l√∂schen
            </button>
          </div>
        )}

        {/* FORMULAR IM BROWSER AUSF√úLLEN */}
        {view === "formular_ausfuellen" && (
          <div style={styles.formPage}>
            <div style={{ backgroundColor:"#003366", color:"#fff", borderRadius:"10px", padding:"14px 16px", marginBottom:"16px", textAlign:"center" }}>
              <div style={{ fontWeight:"bold", fontSize:"16px" }}>ISUV Anspruchslotse</div>
              <div style={{ fontSize:"11px", opacity:0.8, marginTop:"2px" }}>Stammdaten-Fragebogen</div>
            </div>

            <button onClick={function() { setView("dashboard"); setFormFelderDaten({}); }} style={{ background:"none", border:"none", color:"#003366", fontWeight:"bold", fontSize:"13px", cursor:"pointer", marginBottom:"12px", padding:"0" }}>‚Äπ Abbrechen</button>

            {/* Stammdaten */}
            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginBottom:"10px", letterSpacing:"0.5px" }}>Pers√∂nliche Daten</div>
            <label style={styles.label}>Vorname *</label>
            <input style={styles.input} placeholder="Vorname" value={formFelderDaten.vorname||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {vorname: e.target.value}); })} />
            <label style={styles.label}>Nachname *</label>
            <input style={styles.input} placeholder="Nachname" value={formFelderDaten.name||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {name: e.target.value}); })} />
            <label style={styles.label}>Telefon</label>
            <input style={styles.input} placeholder="0170 1234567" value={formFelderDaten.tel||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {tel: e.target.value}); })} />
            <label style={styles.label}>E-Mail *</label>
            <input style={styles.input} placeholder="name@beispiel.de" value={formFelderDaten.mail||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {mail: e.target.value}); })} />
            <label style={styles.label}>Stra√üe & Hausnummer</label>
            <input style={styles.input} placeholder="Musterstra√üe 1" value={formFelderDaten.strasse||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {strasse: e.target.value}); })} />
            <div style={{ display:"flex", gap:"10px" }}>
              <div style={{ width:"90px" }}><label style={styles.label}>PLZ</label><input style={styles.input} value={formFelderDaten.plz||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {plz: e.target.value}); })} /></div>
              <div style={{ flex:1 }}><label style={styles.label}>Ort</label><input style={styles.input} value={formFelderDaten.ort||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {ort: e.target.value}); })} /></div>
            </div>
            <label style={styles.label}>Familienstand</label>
            <select style={styles.input} value={formFelderDaten.familienstand||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {familienstand: e.target.value}); })}>
              <option value="">‚Äì bitte w√§hlen ‚Äì</option>
              <option value="ledig">ledig</option>
              <option value="verheiratet">verheiratet</option>
              <option value="getrennt lebend">getrennt lebend</option>
              <option value="geschieden">geschieden</option>
              <option value="verwitwet">verwitwet</option>
            </select>

            {/* Einkommen & Wohnen */}
            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginTop:"14px", marginBottom:"10px", letterSpacing:"0.5px" }}>Einkommen & Wohnen</div>
            <label style={styles.label}>Nettoeinkommen (‚Ç¨/Monat)</label>
            <input style={styles.input} type="number" placeholder="1500" value={formFelderDaten.einkommenNetto||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {einkommenNetto: e.target.value}); })} />
            <label style={styles.label}>Bruttomiete warm (‚Ç¨/Monat)</label>
            <input style={styles.input} type="number" placeholder="900" value={formFelderDaten.mieteWarm||""} onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {mieteWarm: e.target.value}); })} />
            <div style={{ fontSize:"10px", color:"#888", marginBottom:"10px", marginTop:"-6px" }}>‚ÑπÔ∏è Mietenstufe wird automatisch anhand von PLZ/Ort ermittelt</div>

            {/* Kinder ‚Äì intelligente Filterf√ºhrung */}
            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginTop:"4px", marginBottom:"10px", letterSpacing:"0.5px" }}>Kinder</div>
            <label style={styles.label}>Haben Sie minderj√§hrige Kinder?</label>
            <div style={{ display:"flex", gap:"8px", marginBottom:"10px" }}>
              {["ja","nein"].map(function(v) {
                return (
                  <div key={v} onClick={function() { setFormFelderDaten(function(p) { return Object.assign({}, p, {hatKinder: v, kinder: v === "nein" ? [] : (p.kinder || [])}); }); }}
                    style={{ padding:"8px 20px", borderRadius:"8px", cursor:"pointer", fontWeight:"bold", fontSize:"13px", backgroundColor: formFelderDaten.hatKinder === v ? "#003366" : "#eee", color: formFelderDaten.hatKinder === v ? "#fff" : "#333" }}>
                    {v === "ja" ? "Ja" : "Nein"}
                  </div>
                );
              })}
            </div>

            {formFelderDaten.hatKinder === "ja" && (
              <div>
                {(formFelderDaten.kinder || []).map(function(kind, idx) {
                  var updateKind = function(feld, wert) {
                    setFormFelderDaten(function(p) {
                      var neueKinder = (p.kinder || []).map(function(k, i) { return i === idx ? Object.assign({}, k, {[feld]: wert}) : k; });
                      return Object.assign({}, p, {kinder: neueKinder});
                    });
                  };
                  return (
                    <div key={idx} style={{ backgroundColor:"#f9f9f9", borderRadius:"8px", padding:"12px", marginBottom:"10px", borderLeft:"3px solid #00afad" }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"10px" }}>
                        <strong style={{ fontSize:"13px", color:"#003366" }}>Kind {idx + 1}</strong>
                        <button onClick={function() { setFormFelderDaten(function(p) { var k = (p.kinder||[]).filter(function(_,i){ return i !== idx; }); return Object.assign({},p,{kinder:k}); }); }}
                          style={{ background:"none", border:"none", color:"#e53935", cursor:"pointer", fontSize:"18px", padding:0 }}>√ó</button>
                      </div>
                      <label style={styles.label}>Vorname *</label>
                      <input style={styles.input} placeholder="Vorname des Kindes" value={kind.vorname||""} onChange={function(e){ updateKind("vorname", e.target.value); }} />
                      <label style={styles.label}>Nachname</label>
                      <input style={styles.input} placeholder="Nachname (falls abweichend)" value={kind.nachname||""} onChange={function(e){ updateKind("nachname", e.target.value); }} />
                      <label style={styles.label}>Geburtsdatum *</label>
                      <input style={styles.input} type="date" value={kind.geburt||""} onChange={function(e){ updateKind("geburt", e.target.value); }} />
                      <label style={styles.label}>Wo lebt das Kind haupts√§chlich?</label>
                      <select style={styles.input} value={kind.wohnort||""} onChange={function(e){ updateKind("wohnort", e.target.value); }}>
                        <option value="">‚Äì bitte w√§hlen ‚Äì</option>
                        <option value="bei mir">Bei mir</option>
                        <option value="beim anderen Elternteil">Beim anderen Elternteil</option>
                        <option value="Wechselmodell">Wechselmodell (abwechselnd)</option>
                      </select>
                      <label style={styles.label}>Hat dieses Kind einen anderen Vater / eine andere Mutter?</label>
                      <div style={{ display:"flex", gap:"8px", marginBottom:"10px" }}>
                        {["ja","nein"].map(function(v) {
                          return (
                            <div key={v} onClick={function(){ updateKind("andererElternteil", v); }}
                              style={{ padding:"6px 16px", borderRadius:"6px", cursor:"pointer", fontSize:"12px", fontWeight:"bold", backgroundColor: kind.andererElternteil === v ? "#00afad" : "#eee", color: kind.andererElternteil === v ? "#fff" : "#333" }}>
                              {v === "ja" ? "Ja" : "Nein"}
                            </div>
                          );
                        })}
                      </div>
                      {kind.andererElternteil === "ja" && (
                        <div style={{ backgroundColor:"#fff", border:"1px solid #ddd", borderRadius:"6px", padding:"10px", marginBottom:"6px" }}>
                          <div style={{ fontSize:"11px", fontWeight:"bold", color:"#666", marginBottom:"8px" }}>Anderer Elternteil:</div>
                          <label style={styles.label}>Vorname</label>
                          <input style={styles.input} placeholder="Vorname" value={kind.epVorname||""} onChange={function(e){ updateKind("epVorname", e.target.value); }} />
                          <label style={styles.label}>Nachname</label>
                          <input style={styles.input} placeholder="Nachname" value={kind.epNachname||""} onChange={function(e){ updateKind("epNachname", e.target.value); }} />
                        </div>
                      )}
                      <label style={styles.label}>UVG (Unterhaltsvorschuss) beantragt?</label>
                      <div style={{ display:"flex", gap:"8px", marginBottom:"6px" }}>
                        {["ja","nein","unbekannt"].map(function(v) {
                          return (
                            <div key={v} onClick={function(){ updateKind("uvg", v); }}
                              style={{ padding:"5px 12px", borderRadius:"6px", cursor:"pointer", fontSize:"11px", backgroundColor: kind.uvg === v ? "#003366" : "#eee", color: kind.uvg === v ? "#fff" : "#333" }}>
                              {v === "ja" ? "Ja" : v === "nein" ? "Nein" : "Wei√ü nicht"}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
                <button
                  onClick={function() { setFormFelderDaten(function(p) { var k = (p.kinder||[]).concat([{vorname:"",nachname:"",geburt:"",wohnort:"",andererElternteil:"nein",uvg:""}]); return Object.assign({},p,{kinder:k}); }); }}
                  style={{ width:"100%", padding:"10px", backgroundColor:"#e8f4fd", color:"#003366", border:"2px dashed #003366", borderRadius:"8px", cursor:"pointer", fontWeight:"bold", fontSize:"13px", marginBottom:"10px" }}>
                  + Weiteres Kind hinzuf√ºgen
                </button>
              </div>
            )}

            {/* Notizen */}
            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginTop:"4px", marginBottom:"10px", letterSpacing:"0.5px" }}>Anmerkungen</div>
            <textarea style={{ width:"100%", padding:"10px", border:"1px solid #ddd", borderRadius:"6px", fontSize:"13px", boxSizing:"border-box", height:"70px" }}
              placeholder="Optionale Anmerkungen..."
              value={formFelderDaten.notizen||""}
              onChange={e => setFormFelderDaten(function(p) { return Object.assign({}, p, {notizen: e.target.value}); })} />

            <button
              disabled={!formFelderDaten.vorname || !formFelderDaten.name || !formFelderDaten.mail}
              onClick={function() {
                var jetzt = new Date();
                var datum = jetzt.toLocaleDateString("de-DE") + " " + String(jetzt.getHours()).padStart(2,"0") + ":" + String(jetzt.getMinutes()).padStart(2,"0");
                var formLabel = formFelderDaten._formLabel || "Stammdaten-Fragebogen";
                var empfMail = formFelderDaten.mail || "";
                // Formular geht raus ‚Üí Ausgang
                setAusgangFormulare(function(prev) {
                  return prev.concat([{
                    id: Date.now(), typ: formLabel,
                    empfaenger: empfMail,
                    mitglied: formFelderDaten._vorausgefuellt ? formFelderDaten._mitglied : null,
                    datum: datum, status: "unbeantwortet",
                    vorausgefuellt: formFelderDaten._vorausgefuellt || false
                  }]);
                });
                // mailto mit Formulardaten im Body
                var zeilen = ["ISUV Anspruchslotse ‚Äì " + formLabel, ""];
                zeilen.push("Vorname: " + (formFelderDaten.vorname||""));
                zeilen.push("Nachname: " + (formFelderDaten.name||""));
                zeilen.push("Telefon: " + (formFelderDaten.tel||""));
                zeilen.push("E-Mail: " + empfMail);
                zeilen.push("Adresse: " + (formFelderDaten.strasse||"") + ", " + (formFelderDaten.plz||"") + " " + (formFelderDaten.ort||""));
                zeilen.push("Familienstand: " + (formFelderDaten.familienstand||""));
                zeilen.push("Nettoeinkommen: " + (formFelderDaten.einkommenNetto||""));
                zeilen.push("Miete warm: " + (formFelderDaten.mieteWarm||""));
                if (formFelderDaten.kinder && formFelderDaten.kinder.length > 0) {
                  zeilen.push("");
                  zeilen.push("Kinder:");
                  formFelderDaten.kinder.forEach(function(k, i) {
                    zeilen.push("  Kind " + (i+1) + ": " + (k.vorname||"") + " " + (k.nachname||"") + ", Geb: " + (k.geburt||"") + ", Wohnort: " + (k.wohnort||"") + ", UVG: " + (k.uvg||""));
                  });
                }
                if (formFelderDaten.notizen) { zeilen.push(""); zeilen.push("Notizen: " + formFelderDaten.notizen); }
                var absender = (loginDaten.leiter || "ISUV") + (loginDaten.ort ? " " + loginDaten.ort : "");
                var betreff = "ISUV Formular: " + (formFelderDaten.vorname||"") + " " + (formFelderDaten.name||"");
                var mailtoUrl = "mailto:" + encodeURIComponent(empfMail) + "?subject=" + encodeURIComponent(betreff) + "&body=" + encodeURIComponent(zeilen.join("\r\n"));
                window.location.href = mailtoUrl;
                setFormFelderDaten({});
                setShowFormulare(true);
                setShowAusgang(true);
                setView("dashboard");
              }}
              style={{ width:"100%", marginTop:"12px", padding:"12px", backgroundColor:"#003366", color:"#fff", border:"none", borderRadius:"8px", fontWeight:"bold", cursor:"pointer", fontSize:"13px", opacity: (!formFelderDaten.vorname||!formFelderDaten.name||!formFelderDaten.mail)?0.5:1 }}>
              ‚úâÔ∏è Formular absenden (per Mail)
            </button>
            <div style={{ fontSize:"10px", color:"#999", textAlign:"center", marginTop:"8px" }}>* Pflichtfelder ¬∑ wird per E-Mail gesendet und im Ausgang gespeichert</div>
          </div>
        )}

        {/* ANLAGE TBG */}
        {view === "tbg_form" && (
          <div style={styles.formPage}>
            <button onClick={() => setView("dashboard")} style={styles.btnBack}>‚Äπ Abbrechen</button>
            <h1 style={{ fontSize: "18px", textAlign: "center", margin: "0 0 5px 0" }}>Anlage TBG</h1>
            <p style={{ fontSize: "11px", textAlign: "center", color: "#666", marginBottom: "15px" }}>Tempor√§re Bedarfsgemeinschaft (B√ºrgergeld)</p>
            <div style={styles.formSection}>
              <h4 style={styles.sectionTitle}>(1) Pers√∂nliche Daten Antragsteller*in</h4>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px" }}>
                <input style={styles.input} placeholder="Nachname" />
                <input style={styles.input} placeholder="Vorname" />
              </div>
              <input style={styles.input} placeholder="Stra√üe, Hausnummer" />
              <div style={{ display: "flex", gap: "10px" }}>
                <input style={{ ...styles.input, width: "80px" }} placeholder="PLZ" />
                <input style={styles.input} placeholder="Ort" />
              </div>
              <input style={styles.input} placeholder="BG-Nummer (falls vorhanden)" />
            </div>
            {tbgKinder.map((kind, idx) => (
              <div key={kind.id} style={{ border: "1px solid #00afad", borderRadius: "10px", padding: "15px", marginTop: "20px" }}>
                <h3 style={{ margin: "0 0 10px 0", fontSize: "14px", color: "#00afad" }}>Angaben f√ºr Kind #{idx + 1}</h3>
                <h4 style={styles.sectionTitle}>Andere*r Erziehungsberechtigte*r</h4>
                <input style={styles.input} placeholder="Name, Vorname" />
                <input style={styles.input} placeholder="Anschrift (Stra√üe, PLZ, Ort)" />
                <h4 style={styles.sectionTitle}>Daten des Kindes</h4>
                <input style={styles.input} placeholder="Name, Vorname des Kindes" />
                <input style={styles.input} placeholder="Geburtsdatum (TT.MM.JJJJ)" />
                <h4 style={styles.sectionTitle}>Betreuungsmodell</h4>
                <label style={styles.labelBlock}><input type="radio" name={"m_" + kind.id} /> Parit√§tisch (ca. 50:50)</label>
                <label style={styles.labelBlock}><input type="radio" name={"m_" + kind.id} /> Asymmetrisch (Besuchstage)</label>
                <h4 style={styles.sectionTitle}>Kalender (Tage pro Monat)</h4>
                <div style={styles.calGridTBG}>
                  <span style={{ fontSize: "10px" }}>Monat</span>
                  <span style={{ fontSize: "10px", textAlign: "center" }}>Mutter</span>
                  <span style={{ fontSize: "10px", textAlign: "center" }}>Vater</span>
                  {["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"].map(m => (
                    <React.Fragment key={m}>
                      <span style={{ fontSize: "11px" }}>{m}</span>
                      <input style={styles.miniInput} placeholder="Tage" />
                      <input style={styles.miniInput} placeholder="Tage" />
                    </React.Fragment>
                  ))}
                </div>
                <h4 style={styles.sectionTitle}>Einkommen des Kindes</h4>
                <input style={styles.input} placeholder="Kindergeldberechtigter" />
                <input style={styles.input} placeholder="Sonstiges Einkommen (Unterhalt, UVG)" />
              </div>
            ))}
            <button onClick={addKind} style={{ ...styles.btnSecondary, width: "100%", marginTop: "15px", border: "1px dashed #00afad" }}>+ Weiteres Kind</button>
            <button style={{ ...styles.btnPrimary, width: "100%", marginTop: "20px", backgroundColor: "#00afad" }}>üíæ Speichern & PDF-Vorschau</button>
          </div>
        )}

        {/* ============================================= */}
        {/* PROFIL-SEITE */}
        {/* ============================================= */}
        {view === "profil" && (
          <div style={styles.formPage}>
            <button onClick={() => setView("dashboard")} style={styles.btnBack}>‚Äπ Zur√ºck</button>
            <h2 style={{ color:"#003366", marginBottom:"16px", fontSize:"17px" }}>‚öôÔ∏è Profil & Versandeinstellungen</h2>

            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginBottom:"12px", letterSpacing:"0.5px" }}>Absender-Daten</div>
            <label style={styles.label}>Name Leiter*in</label>
            <input style={styles.input} value={loginDaten.leiter} onChange={e => setLoginDaten(p => ({...p, leiter: e.target.value}))} placeholder="Ihr Name" />
            <label style={styles.label}>Ortsgruppe / Ort</label>
            <input style={styles.input} value={loginDaten.ort} onChange={e => setLoginDaten(p => ({...p, ort: e.target.value}))} placeholder="z.B. M√ºnchen" />

            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginTop:"14px", marginBottom:"12px", letterSpacing:"0.5px" }}>üìß E-Mail-Versand</div>
            <label style={styles.label}>E-Mail-Adresse (f√ºr Versand & R√ºckantwort)</label>
            <input style={styles.input} type="email" value={loginDaten.email} onChange={e => setLoginDaten(p => ({...p, email: e.target.value}))} placeholder="leiter@isuv-ortsgruppe.de" />
            {loginDaten.email && (
              <div style={{ backgroundColor:"#e8f5e9", border:"1px solid #a5d6a7", borderRadius:"6px", padding:"8px 10px", fontSize:"11px", color:"#2e7d32", marginBottom:"10px" }}>
                ‚úÖ Formulare k√∂nnen per E-Mail gesendet werden ¬∑ R√ºckantwort geht an: <strong>{loginDaten.email}</strong>
              </div>
            )}

            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginTop:"14px", marginBottom:"12px", letterSpacing:"0.5px" }}>üì± WhatsApp-Versand</div>
            <label style={styles.label}>WhatsApp-Nummer (mit L√§ndervorwahl)</label>
            <input style={styles.input} type="tel" value={loginDaten.whatsapp} onChange={e => setLoginDaten(p => ({...p, whatsapp: e.target.value}))} placeholder="+49170 1234567" />
            {loginDaten.whatsapp ? (
              <div style={{ backgroundColor:"#e8f5e9", border:"1px solid #a5d6a7", borderRadius:"6px", padding:"8px 10px", fontSize:"11px", color:"#2e7d32", marginBottom:"10px" }}>
                ‚úÖ WhatsApp-Versand aktiv ¬∑ Nummer: <strong>{loginDaten.whatsapp}</strong>
                <div style={{ marginTop:"4px", color:"#555" }}>Empf√§nger k√∂nnen per WhatsApp-Nachricht zur√ºcksenden ‚Äì der Link landet automatisch im Eingang.</div>
              </div>
            ) : (
              <div style={{ backgroundColor:"#fff9e6", border:"1px solid #ffeeba", borderRadius:"6px", padding:"8px 10px", fontSize:"11px", color:"#856404", marginBottom:"10px" }}>
                ‚ö†Ô∏è Keine WhatsApp-Nummer hinterlegt ‚Äì WhatsApp-Versand nicht verf√ºgbar.
              </div>
            )}

            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginTop:"14px", marginBottom:"10px", letterSpacing:"0.5px" }}>‚ÑπÔ∏è So funktioniert der Versand</div>
            <div style={{ fontSize:"11px", color:"#555", lineHeight:"1.6", backgroundColor:"#f9f9f9", borderRadius:"8px", padding:"12px" }}>
              <div style={{ marginBottom:"6px" }}>1Ô∏è‚É£ <strong>Formular versenden:</strong> Mitglied ausw√§hlen ‚Üí Formular w√§hlen ‚Üí per Mail oder WhatsApp senden</div>
              <div style={{ marginBottom:"6px" }}>2Ô∏è‚É£ <strong>Empf√§nger f√ºllt aus:</strong> √ñffnet den Link im Browser, f√ºllt das Formular aus, sendet es zur√ºck</div>
              <div style={{ marginBottom:"6px" }}>3Ô∏è‚É£ <strong>Eingang pr√ºfen:</strong> Ausgef√ºllte Formulare erscheinen im Eingang</div>
              <div>4Ô∏è‚É£ <strong>In Akte √ºbertragen:</strong> Per Knopfdruck in die Mitgliederakte √ºbernehmen</div>
            </div>

            <div style={{ fontSize:"10px", fontWeight:"bold", color:"#003366", textTransform:"uppercase", backgroundColor:"#e8f0fb", borderRadius:"5px", padding:"5px 8px", marginTop:"14px", marginBottom:"10px", letterSpacing:"0.5px" }}>üóÑÔ∏è Supabase ‚Äì Online-Formulare</div>
            <div style={{ fontSize:"11px", color:"#555", lineHeight:"1.6", backgroundColor:"#f0f7ff", borderRadius:"8px", padding:"12px", marginBottom:"12px", border:"1px solid #bee3f8" }}>
              <strong>Was ist Supabase?</strong> Ein kostenloser Dienst, der Ihren Formularen eine echte Web-Adresse gibt. Das Mitglied √∂ffnet den Link, f√ºllt direkt im Browser aus ‚Äì die Daten landen automatisch im Eingang.
              <div style={{ marginTop:"8px" }}>
                <strong>Einrichtung (einmalig, 3 Minuten):</strong>
                <div style={{ marginTop:"4px" }}>1. <a href="https://supabase.com" target="_blank" rel="noreferrer" style={{ color:"#003366" }}>supabase.com</a> ‚Üí kostenlos registrieren</div>
                <div>2. Neues Projekt erstellen ‚Üí Region: <strong>Frankfurt (eu-central-1)</strong></div>
                <div>3. Settings ‚Üí API ‚Üí <strong>Project URL</strong> und <strong>anon/public Key</strong> kopieren</div>
                <div>4. In den Feldern unten einf√ºgen</div>
                <div style={{ marginTop:"6px", backgroundColor:"#fff9e6", borderRadius:"4px", padding:"6px", fontSize:"10px", color:"#856404" }}>
                  ‚ö†Ô∏è Einmalig SQL ausf√ºhren unter Supabase ‚Üí SQL Editor:<br/>
                  <code style={{ fontSize:"9px", display:"block", marginTop:"4px", whiteSpace:"pre-wrap" }}>
{"CREATE TABLE formulare (\n  id bigint generated always as identity primary key,\n  formular_id text unique,\n  typ text, label text,\n  mitglied_name text, mitglied_mail text, mitglied_tel text,\n  vorausgefuellt text, antwort_daten text,\n  status text default 'gesendet',\n  erstellt_am timestamptz default now(),\n  beantwortet_am timestamptz\n);\nALTER TABLE formulare ENABLE ROW LEVEL SECURITY;\nCREATE POLICY pol_ins ON formulare FOR INSERT WITH CHECK (true);\nCREATE POLICY pol_sel ON formulare FOR SELECT USING (true);\nCREATE POLICY pol_upd ON formulare FOR UPDATE USING (true);"}
                  </code>
                </div>
              </div>
            </div>
            <label style={styles.label}>Supabase Project URL</label>
            <input style={styles.input} value={loginDaten.supabaseUrl} onChange={e => setLoginDaten(p => ({...p, supabaseUrl: e.target.value.replace(/\/rest\/v1.*/, "").replace(/\/$/, "") + "/rest/v1"}))} placeholder="https://xyzxyz.supabase.co" />
            <label style={styles.label}>Supabase API Key (anon/public)</label>
            <input style={styles.input} value={loginDaten.supabaseKey} onChange={e => setLoginDaten(p => ({...p, supabaseKey: e.target.value.trim()}))} placeholder="eyJhbGci..." />
            {sbReady() ? (
              <div style={{ backgroundColor:"#e8f5e9", border:"1px solid #a5d6a7", borderRadius:"6px", padding:"8px 10px", fontSize:"11px", color:"#2e7d32", marginBottom:"10px" }}>
                ‚úÖ Supabase verbunden ‚Äì Formulare bekommen eine echte Web-Adresse
                <button onClick={sbLadeEingaenge} style={{ display:"block", marginTop:"6px", backgroundColor:"#003366", color:"#fff", border:"none", borderRadius:"5px", padding:"5px 10px", fontSize:"11px", cursor:"pointer" }}>
                  üîÑ Eing√§nge jetzt abrufen
                </button>
              </div>
            ) : (
              <div style={{ backgroundColor:"#fff9e6", border:"1px solid #ffeeba", borderRadius:"6px", padding:"8px 10px", fontSize:"11px", color:"#856404", marginBottom:"10px" }}>
                ‚ö†Ô∏è Kein Supabase hinterlegt ‚Äì Formulare k√∂nnen nur per Mail/WhatsApp-Text gesendet werden (kein klickbarer Link).
              </div>
            )}

            <button onClick={() => { try { localStorage.setItem("isuv_profil", JSON.stringify(loginDaten)); } catch(e) {} setView("dashboard"); }} style={{ ...styles.btnPrimary, marginTop:"16px" }}>‚úì Speichern & Zur√ºck</button>
          </div>
        )}

        {/* ============================================= */}
        {/* FORMULAR-VERSAND-DIALOG (NEU - Mail + WhatsApp) */}
        {/* ============================================= */}
        {formularVersandDialogNeu && (
          <div style={{ position:"fixed", top:0, left:0, right:0, bottom:0, backgroundColor:"rgba(0,0,0,0.5)", zIndex:1000, display:"flex", alignItems:"flex-end", justifyContent:"center" }}>
            <div style={{ backgroundColor:"#fff", borderRadius:"20px 20px 0 0", padding:"20px", width:"100%", maxWidth:"500px", maxHeight:"85vh", overflowY:"auto" }}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"16px" }}>
                <h3 style={{ margin:0, fontSize:"16px", color:"#003366" }}>üì§ Formular versenden</h3>
                <button onClick={() => setFormularVersandDialogNeu(null)} style={{ background:"none", border:"none", fontSize:"22px", cursor:"pointer", color:"#999", lineHeight:1 }}>√ó</button>
              </div>

              {formularVersandDialogNeu.member && (
                <div style={{ backgroundColor:"#f0f4f7", borderRadius:"8px", padding:"10px 12px", marginBottom:"14px", display:"flex", alignItems:"center", gap:"10px" }}>
                  <div style={{ width:"36px", height:"36px", backgroundColor:"#003366", borderRadius:"50%", display:"flex", alignItems:"center", justifyContent:"center", color:"#fff", fontWeight:"bold", fontSize:"13px", flexShrink:0 }}>
                    {formularVersandDialogNeu.member.vorname[0]}{formularVersandDialogNeu.member.name[0]}
                  </div>
                  <div>
                    <div style={{ fontWeight:"bold", fontSize:"13px" }}>{formularVersandDialogNeu.member.name}, {formularVersandDialogNeu.member.vorname}</div>
                    <div style={{ fontSize:"11px", color:"#666" }}>
                      {formularVersandDialogNeu.member.mail && <span>‚úâÔ∏è {formularVersandDialogNeu.member.mail}</span>}
                      {formularVersandDialogNeu.member.tel && <span style={{ marginLeft:"8px" }}>üì± {formularVersandDialogNeu.member.tel}</span>}
                    </div>
                  </div>
                </div>
              )}

              <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"8px", textTransform:"uppercase", letterSpacing:"0.5px" }}>Formular ausw√§hlen:</div>
              <div style={{ display:"flex", flexDirection:"column", gap:"6px", marginBottom:"16px" }}>
                {[
                  { id:"stammdaten", label:"üìã Stammdaten-Fragebogen", desc:"Pers√∂nliche Daten, Einkommen, Kinder" },
                  { id:"tbg", label:"üìã Anlage TBG", desc:"Tempor√§re Bedarfsgemeinschaft" },
                ].map(function(f) {
                  var sel = formularVersandDialogNeu.formTyp === f.id;
                  return (
                    <div key={f.id} onClick={() => setFormularVersandDialogNeu(p => ({...p, formTyp: f.id}))}
                      style={{ padding:"10px 12px", borderRadius:"8px", cursor:"pointer", border: sel ? "2px solid #003366" : "1px solid #ddd", backgroundColor: sel ? "#e8f0fb" : "#f9f9f9" }}>
                      <div style={{ fontWeight:"bold", fontSize:"12px", color: sel ? "#003366" : "#333" }}>{f.label}</div>
                      <div style={{ fontSize:"10px", color:"#999", marginTop:"2px" }}>{f.desc}</div>
                    </div>
                  );
                })}
              </div>

              {formularVersandDialogNeu.formTyp && (function() {
                var m = formularVersandDialogNeu.member;
                var fTyp = formularVersandDialogNeu.formTyp;
                var fLabel = fTyp === "stammdaten" ? "Stammdaten-Fragebogen" : "Anlage TBG";
                var linkText = "Guten Tag" + (m ? " " + m.vorname + " " + m.name : "") + ",\n\n" +
                  "der ISUV Anspruchslotse hat f√ºr Sie ein Formular bereitgestellt:\n" +
                  "üìã " + fLabel + "\n\n" +
                  "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
                  "SO GEHT ES:\n" +
                  "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
                  "1Ô∏è‚É£ Formular erhalten\n" +
                  "   ‚Üí Sie erhalten das Formular direkt von uns per E-Mail oder WhatsApp.\n" +
                  "   ‚Üí Bitte √∂ffnen Sie es auf Ihrem Ger√§t (Handy, Tablet oder PC).\n\n" +
                  "2Ô∏è‚É£ Formular ausf√ºllen\n" +
                  "   ‚Üí F√ºllen Sie alle Felder direkt im Browser aus.\n" +
                  "   ‚Üí Kein Ausdrucken, kein Download n√∂tig.\n\n" +
                  "3Ô∏è‚É£ Formular zur√ºcksenden\n" +
                  "   ‚Üí Tippen Sie am Ende auf \"Absenden\"\n" +
                  "   ‚Üí Oder kopieren Sie die ausgef√ºllten Daten und senden Sie diese zur√ºck an:\n" +
                  (loginDaten.email ? "   ‚úâÔ∏è Per E-Mail: " + loginDaten.email + "\n" : "") +
                  (loginDaten.whatsapp ? "   üì± Per WhatsApp: " + loginDaten.whatsapp + "\n" : "") +
                  "\nBei Fragen stehen wir jederzeit zur Verf√ºgung.\n" +
                  "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";

                return (
                  <div>
                    <div style={{ fontSize:"11px", fontWeight:"bold", color:"#003366", marginBottom:"10px", textTransform:"uppercase", letterSpacing:"0.5px" }}>Versandweg w√§hlen:</div>
                    <div style={{ display:"flex", flexDirection:"column", gap:"10px" }}>

                      {/* E-Mail Versand */}
                      {loginDaten.email ? (
                        <div style={{ backgroundColor:"#f0f4f7", borderRadius:"10px", padding:"12px" }}>
                          <div style={{ fontWeight:"bold", fontSize:"12px", color:"#003366", marginBottom:"8px" }}>‚úâÔ∏è Per E-Mail senden</div>
                          <div style={{ fontSize:"11px", color:"#555", marginBottom:"8px" }}>
                            Empf√§nger-Adresse: <strong>{m && m.mail ? m.mail : "‚Äì"}</strong>
                          </div>
                          <input
                            style={{ ...styles.input, marginBottom:"8px" }}
                            type="email"
                            placeholder="Empf√§nger E-Mail"
                            value={formularVersandDialogNeu.empfaengerMail || (m && m.mail ? m.mail : "")}
                            onChange={e => setFormularVersandDialogNeu(p => ({...p, empfaengerMail: e.target.value}))}
                          />
                          {/* Debug: Supabase Status */}
                          <div style={{ fontSize:"10px", padding:"6px 8px", borderRadius:"5px", marginBottom:"6px",
                            backgroundColor: sbReady() ? "#e8f5e9" : "#fff3e0",
                            color: sbReady() ? "#2e7d32" : "#e65100" }}>
                            {sbReady() ? "‚úÖ Supabase verbunden ‚Äì Link wird generiert" : "‚ö†Ô∏è Kein Supabase ‚Äì E-Mail wird ohne Link gesendet. Bitte Profil ‚Üí Supabase einrichten & Speichern."}
                          </div>
                          <button
                            onClick={async function() {
                              var empfMail = formularVersandDialogNeu.empfaengerMail || (m && m.mail ? m.mail : "");
                              if (!empfMail || !empfMail.includes("@")) { alert("Bitte g√ºltige E-Mail-Adresse eingeben."); return; }
                              var formLink = "";
                              var sbResult = null;
                              if (sbReady()) {
                                try {
                                  sbResult = await sbSaveFormular(fTyp, fLabel, m, {});
                                } catch(err) {
                                  alert("Supabase Fehler: " + err.message);
                                }
                                if (sbResult) {
                                  formLink = "\n\nüîó Formular-Link (direkt im Browser ausf√ºllen):\n" + sbResult.url;
                                } else if (sbReady()) {
                                  alert("Supabase konnte Formular nicht speichern. Pr√ºfen Sie URL und Key im Profil.");
                                  return;
                                }
                              }
                              var betreff = "ISUV Anspruchslotse ‚Äì " + fLabel + (m ? " f√ºr " + m.vorname + " " + m.name : "");
                              var body = linkText + formLink + "\n\nMit freundlichen Gr√º√üen\n" + (loginDaten.leiter || "ISUV") + (loginDaten.ort ? " ¬∑ " + loginDaten.ort : "");
                              var mailtoUrl = "mailto:" + encodeURIComponent(empfMail) + "?subject=" + encodeURIComponent(betreff) + "&body=" + encodeURIComponent(body);
                              window.open(mailtoUrl);
                              var jetzt = new Date();
                              var ds = jetzt.toLocaleDateString("de-DE") + " " + String(jetzt.getHours()).padStart(2,"0") + ":" + String(jetzt.getMinutes()).padStart(2,"0");
                              setAusgangFormulare(function(prev) {
                                return prev.concat([{ id: sbResult ? sbResult.id : Date.now(), typ: fLabel, empfaenger: empfMail, mitglied: m ? m.vorname + " " + m.name : null, datum: ds, status:"unbeantwortet", kanal:"‚úâÔ∏è E-Mail", formLink: sbResult ? sbResult.url : null }]);
                              });
                              setFormularVersandDialogNeu(null);
                              setShowAusgang(true);
                            }}
                            style={{ width:"100%", padding:"10px", backgroundColor:"#003366", color:"#fff", border:"none", borderRadius:"8px", cursor:"pointer", fontWeight:"bold", fontSize:"12px" }}>
                            ‚úâÔ∏è Per E-Mail senden & im Ausgang speichern
                          </button>
                        </div>
                      ) : (
                        <div style={{ backgroundColor:"#fff9e6", border:"1px solid #ffeeba", borderRadius:"8px", padding:"10px", fontSize:"11px", color:"#856404" }}>
                          ‚ö†Ô∏è Keine E-Mail-Adresse hinterlegt. <span style={{ cursor:"pointer", textDecoration:"underline" }} onClick={() => { setFormularVersandDialogNeu(null); setView("profil"); }}>Jetzt im Profil einrichten ‚Üí</span>
                        </div>
                      )}

                      {/* WhatsApp Versand */}
                      {loginDaten.whatsapp ? (
                        <div style={{ backgroundColor:"#f0f7f0", borderRadius:"10px", padding:"12px" }}>
                          <div style={{ fontWeight:"bold", fontSize:"12px", color:"#1a7a1a", marginBottom:"8px" }}>üì± Per WhatsApp senden</div>
                          <div style={{ fontSize:"11px", color:"#555", marginBottom:"8px" }}>
                            Empf√§nger-Nummer: <strong>{m && m.tel ? m.tel : "‚Äì"}</strong>
                          </div>
                          <input
                            style={{ ...styles.input, marginBottom:"8px" }}
                            type="tel"
                            placeholder="+49170 Empf√§nger-Nummer"
                            value={formularVersandDialogNeu.empfaengerWA || (m && m.tel ? m.tel : "")}
                            onChange={e => setFormularVersandDialogNeu(p => ({...p, empfaengerWA: e.target.value}))}
                          />
                          <button
                            onClick={async function() {
                              var empfTel = (formularVersandDialogNeu.empfaengerWA || (m && m.tel ? m.tel : "")).replace(/[\s\-()]/g, "");
                              if (!empfTel) { alert("Bitte Telefonnummer eingeben."); return; }
                              var formLink = "";
                              var sbResult = null;
                              if (sbReady()) {
                                sbResult = await sbSaveFormular(fTyp, fLabel, m, {});
                                if (sbResult) {
                                  formLink = "\n\nüîó Formular-Link (direkt im Browser ausf√ºllen):\n" + sbResult.url;
                                }
                              }
                              var waMsg = "Hallo" + (m ? " " + m.vorname : "") + ",\n\n" + linkText + formLink + "\n\nNach dem Ausf√ºllen bitte zur√ºcksenden an:\nüì± " + loginDaten.whatsapp + "\n\nVielen Dank!\n" + (loginDaten.leiter || "ISUV") + (loginDaten.ort ? " ¬∑ " + loginDaten.ort : "");
                              var waUrl = "https://wa.me/" + empfTel.replace("+","") + "?text=" + encodeURIComponent(waMsg);
                              window.open(waUrl);
                              var jetzt = new Date();
                              var ds = jetzt.toLocaleDateString("de-DE") + " " + String(jetzt.getHours()).padStart(2,"0") + ":" + String(jetzt.getMinutes()).padStart(2,"0");
                              setAusgangFormulare(function(prev) {
                                return prev.concat([{ id: sbResult ? sbResult.id : Date.now(), typ: fLabel, empfaenger: empfTel, mitglied: m ? m.vorname + " " + m.name : null, datum: ds, status:"unbeantwortet", kanal:"üì± WhatsApp", formLink: sbResult ? sbResult.url : null }]);
                              });
                              setFormularVersandDialogNeu(null);
                              setShowAusgang(true);
                            }}
                            style={{ width:"100%", padding:"10px", backgroundColor:"#25d366", color:"#fff", border:"none", borderRadius:"8px", cursor:"pointer", fontWeight:"bold", fontSize:"12px" }}>
                            üì± Per WhatsApp senden & im Ausgang speichern
                          </button>
                        </div>
                      ) : (
                        <div style={{ backgroundColor:"#fff9e6", border:"1px solid #ffeeba", borderRadius:"8px", padding:"10px", fontSize:"11px", color:"#856404" }}>
                          ‚ö†Ô∏è Keine WhatsApp-Nummer hinterlegt. <span style={{ cursor:"pointer", textDecoration:"underline" }} onClick={() => { setFormularVersandDialogNeu(null); setView("profil"); }}>Jetzt im Profil einrichten ‚Üí</span>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        )}

      </main>
    </div>
  );
}

const styles = {
  appFrame: { minHeight: "100vh", backgroundColor: "#f4f7f9", fontFamily: "sans-serif" },
  header: { display: "flex", justifyContent: "space-between", padding: "15px", backgroundColor: "#fff", borderBottom: "3px solid #00afad", alignItems: "center" },
  main: { padding: "15px", maxWidth: "500px", margin: "0 auto" },
  card: { backgroundColor: "#fff", padding: "15px", borderRadius: "12px", boxShadow: "0 2px 10px rgba(0,0,0,0.05)", marginBottom: "10px" },
  reiterHeader: { display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer" },
  input: { width: "100%", padding: "10px", marginBottom: "10px", borderRadius: "6px", border: "1px solid #ddd", fontSize: "13px", boxSizing: "border-box" },
  miniInput: { width: "100%", padding: "5px", textAlign: "center", border: "1px solid #eee", fontSize: "11px", borderRadius: "4px" },
  btnPrimary: { width: "100%", padding: "12px", backgroundColor: "#003366", color: "#fff", border: "none", borderRadius: "10px", cursor: "pointer", fontWeight: "bold" },
  btnSecondary: { padding: "12px", backgroundColor: "#eee", border: "none", borderRadius: "10px", cursor: "pointer" },
  btnLogout: { border: "none", background: "#f0f0f0", padding: "5px 10px", borderRadius: "5px", cursor: "pointer", fontSize: "11px" },
  miniLogo: { width: "24px", height: "24px", backgroundColor: "#00afad", color: "#fff", display: "flex", alignItems: "center", justifyContent: "center", borderRadius: "4px", fontWeight: "bold" },
  formPage: { backgroundColor: "#fff", padding: "20px", borderRadius: "15px" },
  formSection: { marginTop: "15px" },
  sectionTitle: { fontSize: "10px", color: "#003366", marginBottom: "8px", fontWeight: "bold", borderBottom: "1px solid #eee", textTransform: "uppercase", paddingTop: "5px" },
  label: { fontSize: "12px", fontWeight: "bold", display: "block", marginBottom: "5px" },
  labelBlock: { display: "block", fontSize: "12px", marginBottom: "5px", cursor: "pointer" },
  calHeader: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "10px" },
  dayGrid: { display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: "5px" },
  day: { height: "30px", display: "flex", alignItems: "center", justifyContent: "center", borderRadius: "4px", fontSize: "11px", cursor: "pointer" },
  btnCal: { border: "none", background: "none", color: "#00afad", cursor: "pointer", fontSize: "20px" },
  terminItem: { display: "flex", alignItems: "center", gap: "10px", fontSize: "12px", padding: "8px", borderBottom: "1px solid #f9f9f9", cursor: "pointer" },
  terminTag: { backgroundColor: "#00afad", color: "#fff", padding: "2px 6px", borderRadius: "4px", fontWeight: "bold", fontSize: "10px" },
  dataRow: { display: "flex", justifyContent: "space-between", padding: "10px 0", borderBottom: "1px solid #f5f5f5", fontSize: "14px" },
  btnBack: { background: "none", border: "none", color: "#00afad", cursor: "pointer", marginBottom: "15px", fontWeight: "bold" },
  calGridTBG: { display: "grid", gridTemplateColumns: "1.5fr 1fr 1fr", gap: "5px", alignItems: "center" },
  loginPage: { height: "100vh", display: "flex", justifyContent: "center", alignItems: "center", backgroundColor: "#f0f4f7" },
  loginCard: { width: "280px", padding: "30px", backgroundColor: "#fff", borderRadius: "20px" },
  logo: { width: "50px", height: "50px", backgroundColor: "#003366", color: "#fff", borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", margin: "0 auto 15px", fontWeight: "bold" },
  memberRow: { padding: "10px", borderBottom: "1px solid #eee", display: "flex", justifyContent: "space-between", alignItems: "center" },
  formItem: { padding: "12px", backgroundColor: "#f9f9f9", borderRadius: "8px", cursor: "pointer", borderLeft: "4px solid #00afad" },
  btnDots: { background: "none", border: "none", fontSize: "20px", cursor: "pointer", padding: "0 5px" },
  actionMenu: { position: "absolute", right: "0", top: "25px", backgroundColor: "#fff", boxShadow: "0 4px 12px rgba(0,0,0,0.15)", padding: "8px", borderRadius: "8px", zIndex: 100, width: "140px" },
  menuItem: { fontSize: "12px", cursor: "pointer", padding: "8px", borderBottom: "1px solid #eee" }
};


document.getElementById('loading').style.display = 'none';
ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>